<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>{$marketInfo['wap_title']}</title>
<meta name="viewport" content="width=320, maximum-scale=1, user-scalable=no,minimal-ui">
<meta content="O2O,O2O营销,二维码,旺财,市场调研" name="Keywords">
<meta content="telephone=no" name="format-detection" />
<meta content="email=no" name="format-detection" />
<meta name="apple-touch-fullscreen" content="NO">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Label/Css/activity/wap_20150218.css?v=20150129">
<script type="text/javascript" src="__PUBLIC__/Label/Js/jquery-2.1.1.min.js"></script>
<script>
    //载入全局配置变量
    var _global = {$js_global} || {
        'nowcode':0, //分数
        'game_number':0//局数
    };
    var nowcode = _global.nowcode ||0;//分值
    var nowball = _global.game_number ||0;//炮数

    var loadImg = function(){
        var loadImg = 0 ;
        var imgNum = $(".loadimg").length;
        $(".loadimg").one('load', function() {
            loadImg++;
            if(loadImg==imgNum){
                init();
                $("#loading").fadeOut();
            }
        }).each(function() {
            if(this.complete) $(this).load();
        });
    };

    //初始化页面
    var initData = function(){
        $.post("{:U('getInfo',array('id'=>$id))}",{
        },function(res){
            _global.nowcode = res.info.score;
            _global.game_number = res.info.game_number;
            nowball = _global.game_number,
            nowcode = _global.nowcode;
            loadImg();
            begin();
        },'json');
    };
    initData();

</script>
</head>
<body>
<div id="loading">
    <div class="spinner">
    	<div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
    	<p>载入中</p>
    </div>
    <img src="__PUBLIC__/Label/Image/20150218/fireworks-2.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks-3.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks-4.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks0.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks2.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks3.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks4.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks0-1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks1-1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks2-1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks3-1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fireworks4-1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fuse.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fire1.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/fire2.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20150218/game-end.png" class="loadimg" />
</div>
<div id="gamewrapper">
    <div id="gamecontainer">
        <div class="gameCon">
        	<div class="snowballNum l"><i class="icon-snowball"></i><span></span></div>
        	<div class="snowballNum r"><i class="icon-coin"></i><span></span></div>
            <div class="snowballTip" style="font-size:20px;">选择炮仗开始游戏</div>
            <div class="fireworks-con begin">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-2.png" class="fireworks-an1">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-3.png" class="fireworks-an2">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-4.png" class="fireworks-an3">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-2.png" class="fireworks-an4">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-3.png" class="fireworks-an5">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-4.png" class="fireworks-an6">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-2.png" class="fireworks-an7">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-3.png" class="fireworks-an8">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-1.png" class="fireworks-an01">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-2.png" class="fireworks-an02">
            	<img src="__PUBLIC__/Label/Image/20150218/fireworks-3.png" class="fireworks-an03">
            </div>
            <div class="snowMan">
            	<div class="snowManCon">
                	<div class="fireworks fireworks1 ready"><span></span><img src="__PUBLIC__/Label/Image/20150218/fireworks0.png" /><div class="fuse fuse1"><i></i></div></div>
                	<div class="fireworks fireworks2 ready"><span></span><img src="__PUBLIC__/Label/Image/20150218/fireworks1.png" /><div class="fuse fuse2"><i></i></div></div>
                	<div class="fireworks fireworks3 ready"><span></span><img src="__PUBLIC__/Label/Image/20150218/fireworks2.png" /><div class="fuse fuse3"><i></i></div></div>
                	<div class="fireworks fireworks4 ready"><span></span><img src="__PUBLIC__/Label/Image/20150218/fireworks3.png" /><div class="fuse fuse4"><i></i></div></div>
                	<div class="fireworks fireworks5 ready"><span></span><img src="__PUBLIC__/Label/Image/20150218/fireworks4.png" /><div class="fuse fuse5"><i></i></div></div>
                </div>
            </div>
            <div class="fire">
            	<img src="__PUBLIC__/Label/Image/20150218/{:L('IMAGE_GIRL')}" class="fire3" ondragstart="return false;" />
            </div>
            <div class="beginCon">
                <p class="tc"><a href="{:U('index',array('id'=>$id))}" class="btn-gohome">返回首页</a></p>
            </div>
        </div>
    </div>
</div>
<div class="gameEnd">
	<p><span>被炸到手了<br>换个姿势再来一次吧~</span><em>点击屏幕重新开始</em></p>
</div>
<audio src="__PUBLIC__/Label/Image/20150218/win.mp3" id="audio" style="display:none; width:0; height:0; overflow:hidden;"></audio>
<audio src="__PUBLIC__/Label/Image/20150218/lose.mp3" id="audio2" style="display:none; width:0; height:0; overflow:hidden;"></audio>
</body>
</html>
<script>
var windowwidth=$("#gamewrapper").width();
var windowheight=$("#gamewrapper").height();
var bodywidth = $("body").width();
var thiscode = 0;
var t = true;
var f = false;
var g = true;
var fuse = [];
var fuseready = [];
var wx,wy;
var num = 4;
$(document).ready(function(e) {
    init();
	nowclode(+nowball,+nowcode);
	$("#gamewrapper,.gameEnd").on("touchmove",function(){
		event.preventDefault();
	});
	$(".fireworks").on("touchstar click",function(event){
		if(nowball==0){
			end();
			return false;
		}
		if(f){
			if($(".gamemsg").length>=1){
				return false;
			}
			$("body").append("<div class='gamemsg'><p>烟花燃放中,请等待...</p></div>");
			setTimeout(function(){
				$(".gamemsg").remove();
			},4000);
			return false;
		}
		var index = $(this).index();
		$(".fireworks:not('.beginan')").addClass("ready");
		$(".fireworks").removeClass("readygo");
		$(this).removeClass("ready");
		$(this).addClass("readygo");
		fuseready = [fuse[index][0],fuse[index][1]];
		$(".snowballTip").hide();
		checksuccess();
	})
	$(".gameEnd").on("click",function(){
		if(g){
            setTimeout(function(){
                g = false;
            },1000);
            return false;
        }
		$(this).removeClass("show");
		begin();
	});
	$(".close-msgPop").on("touchstar mousedown",function(){
		$(".gameEnd").removeClass("show");
		$(".msgPop").remove();
	});
});

function nowclode(nowball,nowcode){
	$(".snowballNum.l span").text("X"+nowball);
	$(".snowballNum.r span").text(nowcode);
	$(".snowballNum.r span").addClass("add");
	setTimeout(function(){
		$(".snowballNum.r span").removeClass("add");
	},900);
}
function end(){
	$.post("{:U('playRate')}",{"id":"<?php echo $id;?>","ranking":"<?php echo $info['score'];?>"},function(data){
		if(data.status == '1'){
			var html = [
				'<p class="msg-p bg">您现在共有<span>'+nowcode+'</span>金币,击败了'+data.info.rate+'%的微信用户!</p>',
				''+data.info.showmsg+'',
				'<p class="msg-p">邀请1名好友就可以获得1次{:L('DA_PAO')}机会<br>赶紧去邀请</p>',
				'<a href="javascript:void(0)" class="btn-all w120 btnshow">邀好友，赚金币</a><a href="<?php echo U('getPrize',array('id'=>$id)) ;?>" class="btn-all other w80">兑换奖品</a>'].join('');
			MsgPop({
				title:"恭喜您",
				html:html,
				close:false
			});
		}
	},"json");
}
function init(){
	var windowwidth=$("#gamewrapper").width();
	var scale=windowwidth/640;
	var x = windowwidth-200*scale;
	var y = windowheight;
	$(".fire").css({
		width:200*scale
	});
	$(".fuse").css({
		width:30*scale,
		height:47*scale
	});
	$(".fire").css("transform","translate3d("+x+"px,"+y+"px, 0)");
	$(".fire-n").css({
		top:-210*scale,
		left:40*scale
	});
	setTimeout(function(){
		$(".fuse").each(function(index, element) {
			var fusex = parseInt($(this).offset().left)-(bodywidth-windowwidth)/2;
			var fusey = parseInt(parseInt($(this).offset().top));
			fuse[index] = [fusex,fusey];
		});
	},500)
	var fireimg = $(".fire3").attr("src").indexOf("girl-2.png");
	var fireimg2 = $(".fire3").attr("src").indexOf("girl-4.png");
	var fireimg3 = $(".fire3").attr("src").indexOf("girl-5.png");
	if(fireimg>=1){
		$(".fire3").css({
			width:"140%",
			right:"0px",
			bottom:0
		});
	}
	if(fireimg2>=1){
		$(".fire").attr("style","translate3d(0,0, 0)");
		$(".fire").css({
			width:"100%",
			zIndex:-1
		});
		$(".fire3").addClass("erro");
		$(".fire3").css({
			width:"100%",
			right:"0px",
			top:0
		});
	}
	if(fireimg3>=1){
		$(".fire3").css({
			width:"140%",
			right:"0px",
			bottom:0
		});
	}
}
function checksuccess(){
	if(num==$(".fireworks.ready").length){
		num--;
	}else{
		return false;
	}
	var checkend = Math.round(Math.random()*4);
	var end = true;
	if($(".fireworks.beginan").length>=4){
        sucess_end();
        return;
	}else{
		if(checkend<=$(".fireworks.beginan").length){
			end = false ;
		}
	}
    f = true;
	if(end){
        var code = 0;
        var readtl = $(".fireworks.ready").length;
        if(readtl==4){
            code=20;
        }else if(readtl==3){
            code=30;
        }else if(readtl==2){
            code=50;
        }else if(readtl==1){
            code=100;
        }
        nowcode = nowcode*1+code;
				thiscode = thiscode*1+code;
			var beginan = $(".fireworks.readygo:not('.beginan')");
			var i = beginan.index();
			beginan.addClass("beginan");
			document.getElementById('audio').load();
			document.getElementById('audio').play();
			setTimeout(function(){
				beginan.find("img").attr("src","__PUBLIC__/Label/Image/20150218/fireworks"+i+"-1.png");
			},2200);
			setTimeout(function(){
				$(".fireworks-con").addClass("action");
			},3500);
			setTimeout(function(){
				$(".fireworks-con").removeClass("action");
			},8000);
			setTimeout(function(){
                if($(".fireworks.beginan").length >=4 ){
                    sucess_end();
                }
				nowclode(nowball,nowcode);
                f = false;
			},4000);

	}else{
		var beginan = $(".fireworks.readygo:not('.beginan')");
		var i = beginan.index();
		beginan.addClass("beginan");
		document.getElementById('audio2').load();
		document.getElementById('audio2').play();
		setTimeout(function(){
			beginan.find("img").attr("src","__PUBLIC__/Label/Image/20150218/fireworks"+i+"-1.png");
			$(".gameEnd").addClass("show");
            updata(thiscode*1+10);
		},2200);
		setTimeout(function(){
			g = false;
        	f = false;
		},4000);
	}
}
//成功后提交
function sucess_end(){
    updata(thiscode*1);
    var html = [
        '<p class="msg-p bg">恭喜你本次获得最高'+thiscode+'个金币</p>',
        '<a href="javascript:void(0)" class="btn-all w120" onclick="javascript:closeMsgPop();">继续游戏</a>'
    ].join('');
    MsgPop({
        title:"恭喜您",
        html:html,
        close:false
    });
}
function updata(thiscode){
	$.post("{:U('gameScore',array('id'=>$id))}",{
        'score':thiscode
    },function(res){
		if(+res.code != 0){
            alert(res.msg);
			return;
		}
		initData();
	},'json');
}

function begin(){
    nowclode(nowball,nowcode);
    g = true;
	if(+nowball == 0){
		end();
		return false;
	}else{
		num=4;
		f=false;
        thiscode = 0;
		$(".fireworks:not('ready')").removeClass("readygo").removeClass("beginan").addClass("ready");
		$(".fireworks").each(function(index) {
            $(this).find("img").attr("src","__PUBLIC__/Label/Image/20150218/fireworks"+index+".png");
        });
		$(".fireworks-con begin action").removeClass("action");
	}
}

</script>

<script>
    var wxShareData = {:json_encode($shareData)};
</script>
<!--微信分享-->
<include file="Label/Spring2015/_share"/>