<if condition="$is_adb">

<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/My97DatePicker/WdatePicker.js?v=__VR__"></script>
<style>


.msgPop { position:fixed; top:0; left:0; z-index:202; width:100%; height:100%;background:rgba(0,0,0,0.3);display: -webkit-box;-webkit-box-orient: horizontal;-webkit-box-pack: center;-webkit-box-align: center;}
.msgPopCon { position:relative; width:310px; margin:0 auto; margin-top:-40px;z-index:203; background:#fff;border-radius:3px; padding:20px 10px 10px 10px ;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;}
.msgPopCon a.close { width:26px; height:26px; display:block; position:absolute; right:0px; top:0px; text-align:center; line-height:26px; font-size:38px; color:#aaa;transform:rotate(-45deg);-ms-transform:rotate(-45deg);-moz-transform:rotate(-45deg);-webkit-transform:rotate(-45deg);}
.msgPop .btn-go {display: inline-block; width:46%; height:32px; line-height:32px;border-radius:3px; color:#fff; background:#ed3f40;}
.msgPop .btn-back {display: inline-block; width:46%; height:32px; line-height:32px;border-radius:3px; color:#fff; background:#ddd;}
.msgPop .msgCon { padding-bottom:15px; height:auto; overflow:hidden;border-radius:0 0 4px 4px;}

     .msgPopCon { padding: 50px 15px 20px 15px;}
.msgPopCon a.close { top: 10px; right: 10px; text-indent: -999px; width: 40px; height: 40px; background: url(__PUBLIC__/Label/Image/Shop/icon-erro.png) 0 0; background-size:100%;transform: rotate(0); -ms-transform: rotate(0); -moz-transform: rotate(0); -webkit-transform: rotate(0);}
.succeed_icon { text-align: left;}
.succeed_icon img { vertical-align: middle; margin-right: 5px;}
.succeed_icon span { vertical-align: middle; font-size: 18px; color: #000000;}
.msgPopCon p { text-align: left; font-size: 14px; color: #999999;}
.msgPopCon p .red { color: #ed3f41;}
.msgPopCon .Gform:after,.msgPopCon .Gform ul:after,.msgPopCon .Gform ul li:after {visibility:hidden;display:block;font-size:0;content:"";clear:both;height:0px;}
.msgPopCon .Gform ul { position:relative; box-sizing:border-box;}
.msgPopCon .Gform ul li p { font-size: 13px; color: #999999; text-align: justify;}
.msgPopCon .Gform .name {/* width:100px;*/ text-align:left; line-height:43px;/* position:absolute; top:0px; left:0;*/ font-size:16px; color:#33373c; box-sizing:border-box;}
.msgPopCon .Gform .name em { line-height: 43px; color: #ed3f41;}
.msgPopCon .Gform .input {/* padding:0 0 0 100px;*/ margin-bottom: 10px; border: 1px #e5e5e5 solid; border-radius: 5px; line-height: 43px; position:relative; text-align:left; box-sizing:border-box;}
.msgPopCon .Gform .input span { color: #999999; font-size: 14px;}
.msgPopCon .Gform .input .textbox,.msgPopCon .Gform .input textarea { width:100%; font-size:14px;/* border:solid 1px #bbb;*/ border-radius:3px; box-sizing:border-box;-webkit-appearance:none;/*box-shadow: inset 0 1px 1px rgba(0,0,0,.075);*/}
.msgPopCon .Gform .input .textbox {height:43px; padding:7px 0; line-height:20px; text-indent:3px;}
.msgPopCon .Gform .input .textbox.half { width:47%; float:left;}
.msgPopCon .Gform .input .passcode { width:47%; height:43px; float:right; border-radius:3px;}
.msgPopCon .Gform .input .btn-input.half { width:47%; line-height:43px; float:right; border:solid 0px #bfbfbf; color:#ed3f41; -webkit-appearance:none; border-radius:3px; background:none;}
.msgPopCon .Gform .input textarea { margin-top:5px;height:60px; line-height:20px;}
.msgPopCon .Gform .input select { position: relative; width: 100%; height:43px; line-height:43px;/*background-image: linear-gradient( #fff , #f1f1f1);*/ background: none; font-size:16px; color: #999999; text-align: right; border:solid 0px #bbb; border-radius:3px; box-sizing:border-box;-webkit-appearance:none;/*box-shadow: 0px 1px 3px rgba(0,0,0,.2);*/}
.msgPopCon .Gform .input select:last-child { margin-right:0;}
.msgPopCon .Gform .input:before{ content: ""; display: block; width: 20px; height: 10px; position: absolute; right: 15px; top: 50%; margin-top: -5px; background: url(__PUBLIC__/Label/Image/Item/balco-11.png); background-size: 100%;}
::-webkit-input-placeholder {
    font-size:16px;
}

.msgPopCon .Gform .input i { float:right; margin: 11px -8px 0 0; width:25px; height:25px;background:url(__PUBLIC__/Image/Item/nc-icon.png) 0 -25px; background-size:100% auto;}
.msgPopCon .Gform ul.btn-ul { padding:10px 0;}
.msgPopCon .Gform ul li.btn-li { text-align:center;}
.msgPopCon .Gform ul li .adb-btn-up  { display:block; width: 100%; height:43px; background:#ed3f41; color:#fff; line-height:43px; font-size:18px; font-weight:bold; text-align:center; border-radius:5px;}
.msgPopCon .Gform ul li .adb-btn-up-close{background:#999;}
.formError { position:absolute; top:40px !important; left:auto !important; right:5px !important; margin:0 !important; z-index:100;-webkit-animation:erroMsg 0.3s linear;-webkit-animation-fill-mode:forwards;}
.formError.passcode { right:100px;}
.formError:before { position:absolute; top:-4px; right:10px; width:8px; height:8px; border: 1px #e39f9f solid; border-width: 1px 0 0 1px; background:#fff8f8; content: ''; -webkit-transform: rotate(45deg); z-index: 1;}
.formError .formErrorContent { width: auto; background: #fff8f8; position: relative; color: #ec3636; font-size: 12px; border: 1px solid #e39f9f; padding: 2px 10px 2px 10px; line-height: 20px; border-radius: 3px; box-shadow: 0 2px 2px rgba(0,0,0,.1); white-space: nowrap;}
@-webkit-keyframes erroMsg{
    0%{
        -webkit-transform:translate(0,10px);opacity:0;
        }
    100%{
        -webkit-transform:translate(0,0);opacity:1;
    }
}

.msgPopCon .Gform .input select{
    text-align: center;
}

.switchStore-box { position: fixed; top: 40px; right: 10px; background: rgba(237,63,65,0.85); z-index: 99; width: 40px; border-radius: 50%; height: 40px; line-height: 16px; color: rgb(255, 255, 255); font-size: 13   px;}
/*.switchStore-box:before { content: ""; display: block; position: absolute; right: 11px; top: 8px; width: 10px; height: 1px; transform: rotate(-45deg); background: #ffffff;}
.switchStore-box:after { content: ""; display: block; position: absolute; left: 11px; bottom: 8px; width: 10px; height: 1px; transform: rotate(-45deg); background: #ffffff;}*/
.switchStore-box #adbChangeStore { display: block; width: 32px; height: 32px; text-align: center; position: absolute; top: 50%; margin: -16px auto 0 -16px; left: 50%;}
.orderFormMsg dd ul.fn li select option[disabled] {
    color: #949494;
}



.l2{
    display: inline-block;
    width:50%;
}
.Gselect {
    position: relative;
}
.Gselect:after {
    position: absolute;
    right: 5px;
    top: 50%;
    margin-top: -20px;
    content: "";
    display: block;
    width: 17px;
    height: 40px;
    background: url(__PUBLIC__/Image/icon-shopsearch2.png);
    background-size: 100%;
}
#form .item  ul.adb-user li.input .Gselect select{display: block;padding-top:4px;text-align:left;width:100%;}
#form .item  ul.adb-user li.input .Gselect:after{
    right: none;
    left: -12px;
}

#form .item  ul.adb-user li.input.pl72{
    padding-left:85px;
}


</style>

<if condition="empty($adb_is_sub)">
    <script type="text/javascript">
        $(function(){
        adb_msg_pop('<div class="Gform confirmation"><div style="text-align:center;" class="succeed_icon"><img src="__PUBLIC__/Image/stop_icon.png"><span>请先关注爱蒂宝公众号</span></div><img style="width:90%;display:block;margin:auto;" src="{$adb_attention_href}"><p style="width:80%;margin:auto;text-align:center;">长按上面的二维码图片关注或搜索“爱蒂宝”关注</p></div>',true);
        });
    </script>
</if>



<if condition='$adb_is_page eq 1'>
<include file="Public:Public:wechatAllShareJsdk" />
<script type="text/javascript">
    $(function () {
        wx.ready(function () {
            wx.showOptionMenu();
        });
       
    });
</script>
</if>

<script>
$(function(){
 if($('.orderFormMsg .orderPro').length){

    $("#cart_check").click(function(){
/*        if($("input[name=contacts]").length && !$("input[name=contacts]").val()){
            alert("请输入自提联系人");
            return false;
        }

        if($("input[name=adb_self_date_time]").length && !$("input[name=adb_self_date_time]").val()){
            alert("请选择自提时段");
        return false;
        }

        if($("input[name=adb_self_store_id]").length && !$("input[name=adb_self_store_id]").val()){
            alert("请选择自提门店");
        return false;
        }

        if($("input[name=adb_delivery_date_time]").length && !$("input[name=adb_delivery_date_time]").val()){
            alert("请选择配送时段");
        return false;
        }

        if($("input[name=adb_store_id]").length && !$("input[name=adb_store_id]").val()){
            alert("请选择配送门店");
        return false;
      }*/
    });



        var html='',adb_date_type="{$adb_self_order}";
        var p_code="{$adb_store_info.province_code}",sid="{$adb_store_id}",c_base_option=s_base_option='',_is_page,h="",store_dia="";
        _is_page="{$adb_cur_store_id}";
        if(_is_page > 0){
            $('.orderPro').parent().after("<div style='display:none;' id='adb_is_page'></div>");
        }else{
            c_base_option='<option value="0">请选择省份</option>';
            s_base_option='<option value="0">请选择门店</option>';
        }
      var home_url="{:U('Label/Label/index',array('change'=>1,'id'=>$id))}";

        if(adb_date_type == 2 || adb_date_type == 3){
          
             html+='<div class="orderFormMsg"><dt>自提联系人</dt><dd><ul class="fn"><li>'
                +'<input type="text" name="contacts" maxlength="10" placeholder="自提联系人名称" />'
                +'</li></ul></dd></div>';
             store_dia='';
                if(_is_page > 0){
                     store_dia='<dt style="color:red;">若更改自提门店，请在<a href="'+home_url+'">【总部商城】</a>下单</dt>';
                }
              html+='<div class="orderFormMsg">'+store_dia+'<dt>自提时间</dt><dd><ul class="fn"><li>'
                +"<div class='Gselect l2 list2'><input style='-webkit-appearance: none; background: #ffffff;' name='adb_self_date' type='date' value='"+now()+"' min='"+now()+"' placeholder='请选择日期'  onChange='changeTimeBySelf()' id='adb_self_date'/></div>"
                +'<div class="Gselect l2 list2"><select name="adb_self_date_time" >'
                +'<option value="0">请选择时段</option>'
                +'</select></div></li></ul></dd></div>';

            if(_is_page == 0){
                html+='<div class="orderFormMsg"><dt>自提门店</dt><dd><ul class="fn"><li>'
                    +'<div class="Gselect l2 list2"><select  id="adb_area_self" onchange="adb_self_area_change_store()" class="ml validate[required]">'+c_base_option
                    +get_area_option(p_code)
                    +'</select></div>'
                    +'<div class="Gselect l2 list2"><select  id="adb_self_store_id" name="adb_self_store_id" class="ml validate[required]">'
                    +s_base_option
                    +get_store_option_by_area(p_code,sid)
                    +'</select></div>'
                    +'</li></ul></dd></div>';
            }else{
                h+='<input type="hidden" name="adb_self_store_id" value="'+sid+'" />';

            }
        }

        if(adb_date_type == 1 || adb_date_type == 3){
            store_dia='';
            if(_is_page > 0){
                 store_dia='<dt style="color:red;">若更改配送门店，请在<a href="'+home_url+'">【总部商城】</a>下单</dt>';
            }
                html+='<div class="orderFormMsg">'+store_dia+'<dt>配送时间</dt><dd><ul class="fn"><li>'
                +'<div class="Gselect l2 list2"><input  name="adb_delivery_date" type="date" value="'+now()+'" min="'+now()+' placeholder="请选择日期" style="-webkit-appearance: none; background: #ffffff;" onChange="changeTime()" id="adb_delivery_date"/></div>'
                +'<div class="Gselect l2 list2"><select name="adb_delivery_date_time" >'
                +'<option value="0">请选择时段</option>'
                +'</select></div></li></ul></dd></div>';

            if(_is_page == 0){
                html+='<div class="orderFormMsg"><dt>配送门店</dt><dd><ul class="fn"><li>'
                +'<div class="Gselect l2 list2"><select  id="adb_area" onchange="adb_area_change_store()" class="ml validate[required]">'+c_base_option
                +get_area_option(p_code)
                +'</select></div>'
                +'<div class="Gselect l2 list2"><select  id="adb_store_id" name="adb_store_id" class="ml validate[required]">'
                +s_base_option
                +get_store_option_by_area(p_code,sid)
                +'</select></div>'
                +'</li></ul></dd></div>';
            }else{
                h+='<input type="hidden" value="'+sid+'" name="adb_store_id" />';
            }
        
          
        }


        if(!$("input[name=memo]").length){
              html+='<div class="orderFormMsg"><dd class="leaveMessage">'
                +'<span>给商家留言</span><p><input type="text" name="memo" maxlength="50" placeholder="可填写您和商家达成一致的要求" />'
                +'</p></dd></div>';


        }
 
        html+=h;
        html+='<input type="hidden" name="adb_self_order" value="'+adb_date_type+'"/>';
       
        $('.orderPro').parents(".orderFormMsg").after(html);
        changeTime();
        changeTimeBySelf();
 }



    if($('.userCenter').length){
        var uc_dia='';
        if('{$adb_store_id}' > 0){
            uc_dia='<ul style="height:80px;padding: 0px;margin: auto;"><li class="name" style="color:red;padding:0 0 12px 12px;">温馨提示：<br/>如需改配送门店，请至<a href="{:U("Label/Label/index",array("change"=>1,"id"=>$id))}">【总部商城】</a>下单。<br/>绑定其他门店后购物车商品将清空！</li></ul>';
         }
         html='<ul class="adb-user"><li class="name" style="width: 90px;">选择的门店</li>'
                    +'<li class="input " style="padding-left:95px;">'
                        +'<div class="Gselect l2 list2 ul2"><select  id="adb_area" onchange="adb_area_change_store()" class="ml validate[required]"><option value="0">请选择省份</option>'
                        +get_area_option("{$adb_store_info.province_code}")
                    +'</select></div>'

                     +'<div class="Gselect l2 list2 ul2"><select  id="adb_store_id" name="adb_store_id" class="ml validate[required]"><option value="0">请选择门店</option>'
                        +get_store_option_by_area("{$adb_store_info.province_code}","{$adb_store_info.store_id}")
                        +'</select></div></li></ul>'+
                        uc_dia;

        $('#sex').parent('ul.btn-ul').prev('div.item').append(html);
    }

    if($("#adbUChangeStore").length > 0){
        $("#adbUChangeStore").on("click",function(){
            var id=$(this).data('id');
            var is_home=$(this).data("home");
            var check="{$adb_check_carts}";
            var url="{:U('Label/Label/index')}&id="+id+"&change="+(is_home==1?1:2);
            if(is_home==1 || !check){
            //直接跳转
                link_to(url);
            }else{
              var html='<div class="Gform confirmation"><form action="" method=""><div class="succeed_icon"><img src="__PUBLIC__/Image/stop_icon.png"><span>当前购物车内存有商品，切换后购物车将清空，是否切换？</span></div><ul class="btn-ul"><li class="btn-li"><a href="'+url+'" class="adb-btn-up" >立刻切换</a><br/><a href="javascript:void(0)" class="adb-btn-up adb-btn-up-close" onclick="adb_msg_pop_close()">暂不切换</a></li></ul></form></div>';
                adb_msg_pop(html);
 
            }
            return false;
        });
    }

});


    function adb_save_store(){
        var val=$('#adb_store_id').val(),url;
        if(val <= 0){
             art.dialog({content:"<div class='msg-all-error'>请选择选择的门店</div>",title:false,fixed: true,padding:0}).time(3);
            return false; 
        }
        $.post("{:U('Label/Store/adbSaveStore',array('id'=>$id))}",{store_id:val},function(data){
            if(typeof(data).toLowerCase()  =='string'){
                data=JSON.parse(data);
            }
            if(data.status == 1){
               if(typeof(data.url) == 'object'){
                for(var i in data.url){
                    url=data.url[i];
                    break;
                }
               }else{
                url=data.url;
               }
               window.location.href=url;
            }else{
                art.dialog({content:"<div class='msg-all-error'>"+data.info+"</div>",title:false,fixed: true,padding:0}).time(3);
            }
        });
    }

    function adb_area_change_store(){
        if($("#adb_is_page").length){
            return false;
        }
        var val=$("#adb_area").val(),option="<option value='0'>请选择门店</option>";
        option+=get_store_option_by_area(val);
        $("#adb_store_id").html(option);
    }   

    function adb_self_area_change_store(){
        if($("#adb_is_page").length){
            return false;
        }
        var val=$("#adb_area_self").val(),option="<option value='0'>请选择门店</option>";
        option+=get_store_option_by_area(val);
        $("#adb_self_store_id").html(option);
    }

    //弹层
    function adb_msg_pop(msg,not_close){
        var close='<a href="javascript:void(0)" class="close" onclick="adb_msg_pop_close()">+</a>';
        if(not_close){
            close="";
        }
        var html=['<div class="msgPop">',
                '<div class="msgPopCon">',
                    close,
                    ''+msg+'',
                '</div>',
            '</div>'].join('');
        $("body").append(html);
        
    }

    function adb_msg_pop_close(){
        $(".msgPop").remove();
    }


    function changeTime(){
        if($("select[name=adb_delivery_date_time]").length <= 0){
            return false;
        }
        var val=$("#adb_delivery_date").val();
        var d=new Date(),time,data,option='<option value="0" selected="selected">请选择时段</option>',_now=now();
        val=val.match(/[0-9]+/g).join('-');
        if(strtotime(val) < strtotime(_now)){
            $("#adb_delivery_date").val(_now);
            val=_now;
        }
        time=(d.getHours()+4).toString();
        time=time>23?23:time;
        data=[{id:1,val:"10:00到12:00",end:"10"},
        {id:2,val:"12:00到14:00",end:"12"},
        {id:3,val:"14:00到16:00",end:"14"},
        {id:4,val:"16:00到18:00",end:"16"},
        {id:5,val:"18:00到20:00",end:"18"},];
        $.each(data,function(idx,row){
        option+="<option  value='"+row.id+"' "+((time > row.end && val == _now)?"disabled='disabled'":"")+">"+row.val+"</li>";
        });
        $("select[name=adb_delivery_date_time]").html(option);
    }

    function changeTimeBySelf(){
        if($("select[name=adb_self_date_time]").length <= 0){
            return false;
        }
        var val=$("#adb_self_date").val();
        var d=new Date(),time,data,option='<option value="0" selected="selected">请选择时段</option>',_now=now();
        val=val.match(/[0-9]+/g).join('-')
        if(strtotime(val) < strtotime(_now)){
            $("#adb_self_date").val(_now);
            val=_now;
        }
        time=(d.getHours()+2).toString();
        time=time>23?23:time;//10:00——20:00
        data=[
            {id:6,val:"10:00到11:00",end:"10"},
            {id:7,val:"11:00到12:00",end:"11"},
            {id:8,val:"12:00到13:00",end:"12"},
            {id:9,val:"13:00到14:00",end:"13"},
            {id:10,val:"14:00到15:00",end:"14"},
            {id:11,val:"15:00到16:00",end:"15"},
            {id:12,val:"16:00到17:00",end:"16"},
            {id:13,val:"17:00到18:00",end:"17"},
            {id:14,val:"18:00到19:00",end:"18"},
            {id:15,val:"19:00到20:00",end:"19"},
        ];
        $.each(data,function(idx,row){
        option+="<option  value='"+row.id+"' "+((time > row.end && val == _now)?"disabled='disabled'":"")+">"+row.val+"</li>";
        });
        $("select[name=adb_self_date_time]").html(option);
    }

    function now(){
        var d=new Date(),y,m,d;
         y=d.getFullYear().toString();
         m=(d.getMonth()+1).toString();
         d=d.getDate().toString();
         if(m.length < 2){
            m="0"+m;
         }
         if(d.length < 2){
            d="0"+d;
         }
        return (y+"-"+m+"-"+d);
    }

    function strtotime(str){

        var timestamp2 = Date.parse(new Date(str));
        timestamp2 = timestamp2 / 1000;
        return timestamp2;
    }

    function get_area_option(id){
        var list=get_area_list(),is_page,option='',selected;
        is_page=$("#adb_is_page").length;
        if(list.length){
            $.each(list,function(idx,row){
                selected="";
                if(typeof(id) !='undefined' && id == row.id){
                    selected="selected='selected'";
                }else{
                    if(is_page){
                        selected="disabled='disabled'";
                    }
                }
                option += "<option value='"+row.id+"' "+selected+">"+row.name+"</option>";
            });
        }
        return option;
    }

    function get_store_option_by_area(pid,id){
        if(typeof(pid) == 'undefined'){
            return '';
        }
        pid=pid/1;
        var list=get_store_list();
        var option="",pro_id,selected,is_page;
        is_page=$("#adb_is_page").length;
        if(list.length){
            $.each(list,function(idx,row){
                pro_id=row.province_code/1;
                if(pid == pro_id){
                    selected='';
                    if(typeof(id) !='undefined' && id == row.store_id){
                         selected="selected='selected'";
                    }else{
                        if(is_page){
                            selected="disabled='disabled'";
                        }
                    }
                    option += "<option value='"+row.store_id+"' "+selected+">"+row.store_name+"</option>";    
                }
            });
        } 
       
        return option;
    }

    function get_store_list(){
        var list=JSON.parse('{:json_encode($adb_store_list)}');
   
        if(list == null){
            return false;
        }
        return list;
    }

    function get_area_list(){
        var list=JSON.parse('{:json_encode($adb_area_list)}');
        if(list == null){
            return false;
        }
        return list;
    }

</script>

</if>