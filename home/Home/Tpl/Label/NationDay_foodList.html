<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>{$marketInfo['name']}</title>
<meta name="viewport" content="width=320, maximum-scale=1, user-scalable=no,minimal-ui">
<meta content="O2O,O2O营销,二维码,旺财,市场调研" name="Keywords">
<meta content="telephone=no" name="format-detection" />
<meta content="email=no" name="format-detection" />
<meta name="apple-touch-fullscreen" content="NO">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/Label/Css/activity/wap_20151001.css?v=__VR__">
<script type="text/javascript" src="__PUBLIC__/Label/Js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/Label/Js/idangerous.swiper.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery-ui-1.11.2.custom/template.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
    var wxShareData = <?php echo json_encode($shareData['config']);?>;;
    if(wxShareData) {
        wx.config({
            //debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: wxShareData.appId,  //必填，公众号的唯一标识
            timestamp: wxShareData.timestamp, // 必填，生成签名的时间戳
            nonceStr: wxShareData.nonceStr, // 必填，生成签名的随机串
            signature: wxShareData.signature,// 必填，签名，见附录1
            jsApiList: [
                'onMenuShareTimeline',
                'onMenuShareAppMessage'
            ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });
    }
    function loadwxjs(){
        wx.ready(function () {
            wx.showOptionMenu();
            var title = "{$shareData['desc']}";
            var link = "{$shareData['link']}";
            var imgUrl = "{$shareData['imgUrl']}";
            wx.onMenuShareTimeline({
                title: title, // 分享标题
                link: link, // 分享链接
                imgUrl: imgUrl // 分享图标
            });
            wx.onMenuShareAppMessage({
                title: "{$shareData['title']}", // 分享标题
                desc: "{$shareData['desc']}", // 分享描述
                link: "{$shareData['link']}", // 分享链接
                imgUrl: "{$shareData['imgUrl']}"// 分享图标
            });
        })
    }
$(document).ready(function(e) {
    loadwxjs();
	var loadImg = 0;
	var imgNum = $(".loadimg").length-1;
	$(".loadimg").one('load', function () {
		loadImg++;
		if (loadImg >= imgNum) {
			$("#loading").hide();
			$("#wrapper").addClass("begin");
            return false;
		}
	}).each(function () {
		if (this.complete) $(this).load();
	});
    setTimeout(function(){
        $("#loading").hide();
        $("#wrapper").addClass("begin");
    },5000);
});
</script>
</head>
<body>
<div id="loading">
    <div class="loadingbox">
        <h4>{$nodeName}</h4>
        <div><i></i>
            <?php if ($marketInfo['log_img']) { ?>
            <img src="{$marketInfo['log_img']}" />
            <?php } else{ ?>
            <img src="__PUBLIC__/Label/Image/defaultlogo-sTwo.png">
            <?php } ?>
        </div>
        <h5>Loading...</h5>
        <h6>我是升旗手</h6>
    </div>
    <img src="__PUBLIC__/Label/Image/20151001/loadingbg.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20151001/bg.jpg" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20151001/prizebg.png" class="loadimg" />
    <img src="__PUBLIC__/Label/Image/20151001/qj-18.png" class="loadimg" />
</div>
<div id="wrapper">
    <div id="container">
    	<div id="main">
            <div class="mainCon">
                <p>您已获得下列材料</p>
                <div class="numList fn">
                	<ul>
                        <php>if($foods_number['2']){</php>
                        <li><div class="bg fn"><i class="icon-num2"></i><em>X<span class="_food2">{$foods_number['2']}</span></em><a href="javascript:void(0)" class="btn-sm" onclick="sendfood(2);" id="_food2"><span>赠送</span></a></div></li>
                        <php>}else{</php>
                        <li><div class="bg fn"><i class="icon-num2"></i><em>X<span class="_food2">0</span></em><a href="javascript:void(0)" class="btn-sm erro"><span>赠送</span></a></div></li>
                        <php>}</php>
                        <php>if($foods_number['0']){</php>
                        <li><div class="bg fn"><i class="icon-num0"></i><em>X<span class="_food0">{$foods_number['0']}</span></em><a href="javascript:void(0)" class="btn-sm" onclick="sendfood(0);" id="_food0"><span>赠送</span></a></div></li>
                        <php>}else{</php>
                        <li><div class="bg fn"><i class="icon-num0"></i><em>X<span class="_food0">0</span></em><a href="javascript:void(0)" class="btn-sm erro"><span>赠送</span></a></div></li>
                        <php>}</php>
                        <php>if($foods_number['1']){</php>
                        <li><div class="bg fn"><i class="icon-num1"></i><em>X<span class="_food1">{$foods_number['1']}</span></em><a href="javascript:void(0)" class="btn-sm" onclick="sendfood(1);" id="_food1"><span>赠送</span></a></div></li>
                        <php>}else{</php>
                        <li><div class="bg fn"><i class="icon-num1"></i><em>X<span class="_food1">0</span></em><a href="javascript:void(0)" class="btn-sm erro"><span>赠送</span></a></div></li>
                        <php>}</php>
                        <php>if($foods_number['3']){</php>
                        <li><div class="bg fn"><i class="icon-num5"></i><em>X<span class="_food3">{$foods_number['3']}</span></em><a href="javascript:void(0)" class="btn-sm" onclick="sendfood(3);" id="_food3"><span>赠送</span></a></div></li>
                        <php>}else{</php>
                        <li><div class="bg fn"><i class="icon-num5"></i><em>X<span class="_food3">0</span></em><a href="javascript:void(0)" class="btn-sm erro"><span>赠送</span></a></div></li>
                        <php>}</php>
                    </ul>
                </div>
                <p class="pRule">
                    <php>if($list[0]['name']=="一等奖"){</php>
                    <span>一等奖：</span>集齐数字20151001<br>
                    <php>}else if($list[0]['name']=="二等奖"){</php>
                    <span>二等奖：</span>集齐数字151001<br>
                    <php>}else if($list[0]['name']=="三等奖"){</php>
                    <span>三等奖：</span>集齐数字1001<br>
                    <php>}</php>
                    <php>if($list[1]['name']=="一等奖"){</php>
                    <span>一等奖：</span>集齐数字20151001<br>
                    <php>}else if($list[1]['name']=="二等奖"){</php>
                    <span>二等奖：</span>集齐数字151001<br>
                    <php>}else if($list[1]['name']=="三等奖"){</php>
                    <span>三等奖：</span>集齐数字1001<br>
                    <php>}</php>
                    <php>if($list[2]['name']=="一等奖"){</php>
                    <span>一等奖：</span>集齐数字20151001<br>
                    <php>}else if($list[2]['name']=="二等奖"){</php>
                    <span>二等奖：</span>集齐数字151001<br>
                    <php>}else if($list[2]['name']=="三等奖"){</php>
                    <span>三等奖：</span>集齐数字1001<br>
                    <php>}</php>
                    <php>if($phone_total_count!=0){</php>
                       <php>if($node_id==C('changsha_bank.node_id')){</php>
                             <span>兑奖次数：</span>{$phone_total_count}次
                       <php>}else{</php>
                             <span>兑奖次数：</span>{$phone_total_count}次（微信卡券作为奖品，只可领取一次！）
                       <php>}</php>
                    <php>}else{</php>
                        <php>if($node_id==C('changsha_bank.node_id')){</php>
                        <span>兑奖次数：</span>不限
                        <php>}else{</php>
                       <span>兑奖次数：</span>不限（微信卡券作为奖品，只可领取一次！）
                    <php>}</php>
                    <php>}</php>
                </p>
                <p>获得材料可点亮数字，集齐相应数字组合可兑换奖品哦~</p>
                <input type="hidden"  value="" id="food_id"/>
                <input type="hidden"  value="{$id}" id="id"/>
                <input type="hidden"  value="{$url_final}" id="openid_md5"/>
                <input type="hidden" value="" id="jp_type"/>
                <input type="hidden" value="" id="tcj_cate_id"/>
                <div class="numCode">
                	<ul>
                    	<li class="<php>if($foods_number['2']){echo 'ok';}</php>" id="score_color1">2</li>
                    	<li class="<php>if($foods_number['0']>2){echo 'ok';}</php>" id="score_color2">0</li>
                    	<li class="<php>if($foods_number['1']>2){echo 'ok';}</php>" id="score_color3">1</li>
                    	<li class="<php>if($foods_number['3']){echo 'ok';}</php>" id="score_color4">5</li>
                    	<li class="<php>if($foods_number['1']>1){echo 'ok';}</php>" id="score_color5">1</li>
                    	<li class="<php>if($foods_number['0']>1){echo 'ok';}</php>" id="score_color6">0</li>
                    	<li class="<php>if($foods_number['0']){echo 'ok';}</php>" id="score_color7">0</li>
                    	<li class="<php>if($foods_number['1']){echo 'ok';}</php>" id="score_color8">1</li>
                    </ul>
                </div>
                <div class="prize">
                    <div class="prizeFlash">
                    	<ul class="swiper-wrapper">
                            <volist name="list" id="vo">
                                <php>if($vo['name']=="一等奖"){</php>
                                <li class="swiper-slide"><h2>{$vo['name']}</h2><div class="img"><img src="__UPLOAD__/<?php echo $vo['goods_image'];?>"></div><p>{$vo['batch_short_name']}</p><p><a href="javascript:void(0)" class="btn-sm btn-get1" onclick="getPrize('1','{$vo.goods_type}','{$vo.card_id}','{$vo.tcj_cate_id}','{$vo.id}')"><span>马上领取</span></a></p></li>
                                <php>}elseif($vo['name']=="二等奖"){</php>
                                <li class="swiper-slide"><h2>{$vo['name']}</h2><div class="img"><img src="__UPLOAD__/<?php echo $vo['goods_image'];?>"></div><p>{$vo['batch_short_name']}</p><p><a href="javascript:void(0)" class="btn-sm btn-get2" onclick="getPrize('2','{$vo.goods_type}','{$vo.card_id}','{$vo.tcj_cate_id}','{$vo.id}')"><span>马上领取</span></a></p></li>
                                <php>}else{</php>
                                <li class="swiper-slide"><h2>{$vo['name']}</h2><div class="img"><img src="__UPLOAD__/<?php echo $vo['goods_image'];?>"></div><p>{$vo['batch_short_name']}</p><p><a href="javascript:void(0)" class="btn-sm btn-get3" onclick="getPrize('3','{$vo.goods_type}','{$vo.card_id}','{$vo.tcj_cate_id}','{$vo.id}')"><span>马上领取</span></a></p></li>
                                <php>}</php>
                            </volist>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="fixedOpr">
                <div class="out-box dn">
                    <img class="img" src="__PUBLIC__/Label/Image/duanwu/tip-share.png">
                </div>
            	<a href="{:U('Label/NationDay/playGame',array('id'=>$id))}" class="btn-green">再一次升旗</a>
            	<a href="{:U('Label/NationDay/mycardList',array('id'=>$id))}" class="btn-yellow">中奖记录</a>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script>
    //领取卡券
    function getWxCard2(card_id,card_ext){
        //领取微信卡券
        getWxCard(card_id,card_ext);
    }
    document.addEventListener('WeixinJSBridgeReady', function(){
        window['getWxCard'] = function(card_id,card_ext){
            //todo debug
            if(typeof(WeixinJSBridge) == 'undefined'){
                alert('wait...');
                return;
            }
            /*alert(data.card_id);
             alert(data.card_ext);*/
            WeixinJSBridge.invoke('batchAddCard', {
                "card_list": [{
                    "card_id": card_id,
                    "card_ext": card_ext
                }]
            },function(res){
                /*for(var i in res){
                 alert(res[i]);
                 }*/
            });
        }
    }, false);
    document.addEventListener('WeixinJSBridgeReady', function(){
        window['getWxCard'] = function(card_id,card_ext){
            //todo debug
            if(typeof(WeixinJSBridge) == 'undefined'){
                alert('wait...');
                return;
            }
            /*alert(data.card_id);
             alert(data.card_ext);*/
            WeixinJSBridge.invoke('batchAddCard', {
                "card_list": [{
                    "card_id": card_id,
                    "card_ext": card_ext
                }]
            },function(res){
                /*for(var i in res){
                 alert(res[i]);
                 }*/
            });
        }
    }, false);
    function getPrize(jp_type,goods_type,card_id,tcj_cate_id,card_batch_id){
        //兑换奖品的类型放input中
        $("#jp_type").val(jp_type);
        $("#tcj_cate_id").val(tcj_cate_id);
        //一等奖需要校验
        if(jp_type==1){
            if($("._food2").text()<1 || $("._food0").text()<3 || $("._food1").text()<3  || $("._food3").text()<1){
//                cj.content({
//                    msg:"<p>您还没有集齐<span>一等奖需要的</span>食材，无<br>法兑换礼品。赶快去升旗收集吧！</p>"
//                })
                return false;
            }
        }else if(jp_type==2){
            if( $("._food0").text()<2 || $("._food1").text()<3  || $("._food3").text()<1){
//                cj.content({
//                    msg:"<p>您还没有集齐<span>二等奖需要的</span>食材，无<br>法兑换礼品。赶快去升旗收集吧！</p>"
//                })
                return false;
            }
        }else if(jp_type==3){
            if( $("._food0").text()<2 || $("._food1").text()<2){
//                cj.content({
//                    msg:"<p>您还没有集齐<span>三等奖需要的</span>食材，无<br>法兑换礼品。赶快去升旗收集吧！</p>"
//                })
                return false;
            }
        }
        if(_global.flag==false){
            return false;
        }
        ajaxNationDay(card_id);
    }
var _global = {
		onsub:false,
		g:true,
        flag:true,
        data:{},
        msg:{}
	}
$(document).ready(function(e) {
    loadinglq();
    //验证码
    $("body").on("click","#getpasscode",function(){
        var phone = $("#mobile").val();
        var id = $("#id").val();
        if(phone.length!=11)
        {
            art.dialog.alert("手机号码不正确！");
            return false;
        }
        var self = $(this);
        if(self.data('in_ajax') != 0) return ;
        self.data('in_ajax', 1);
        self.val("正在发送......");
        $.get("{:U('Label/NationDay/sendCheckCode',array('id'=>$id))}"+'&phone='+phone,function(data){
            self.data('in_ajax', 0);
            if (data.status == 1) {
                self.data('in_ajax', 2);
                self.val("90秒");
                var sed = 90, Int;
                function aha(){
                    sed = sed - 1;
                    if( sed == 0){
                        self.data('in_ajax', 0);
                        self.val('获取验证码');
                        clearInterval(Int);
                        return;
                    }else{
                        self.val(sed+'秒');
                    }
                }
                Int = setInterval(aha, 1000);
            } else {
                var html = "<p>"+data.info+"<p>";
                cj.content({
                    msg:html,
                    btn:[{
                        text:"关闭",
                        callback:function(){
                            cj.close();
                        }
                    }]
                });
                $("#getpasscode").val("获取验证码");
            }
        },"json");
    });
	$("body").on("click","#subcj",function(){
        var url="{:U('Label/NationDay/reSend',array('id'=>$id))}";
        $.ajax({
            url: url,
            type: "POST",
            data: {phone:$("#mobile").val(),verify:$("#verify").val(),cj_traceid:$("#cj_traceid").val(),request_id:$("#request_id").val(),bonus_use_detail_id:$("#bonus_use_detail_id").val()},
            timeout: 10000,
            dataType: "json",
            success: function (resp) {
                if(resp.status == 1){
                    foods_shao();
                    if(resp.info.type == 1){
                        var btn = [];
                        if(resp.info.link_flag == 1){
                            var html2 = "<p class='title'>"+ "恭喜您获得了"+resp.info.bonus_page_name+"！"+"<p></p>"+"您可现在去使用或稍后在中奖记录中查看领取。"+"</p>";
                            cj.content({
                                msg: html2,
                                btn:[{
                                    text:"关闭",
                                    callback:function(){
                                        cj.close();
                                    }
                                },{
                                    text:"去使用",
                                    url:resp.info.link_url
                                }]
                            });
                            return false;
                        }
                        var html = "<p class='title'>"+ "恭喜您获得了"+resp.info.bonus_page_name+"！"+"<p></p>"+"中奖凭证将自动下发至您的手机，请注意查收。"+"</p>";
                        cj.content({
                            msg:html,
                            btn:[{
                                text:"关闭",
                                callback:function(){
                                    cj.close();
                                }
                            }]
                        });
                        return false;
                    }else{
                        //提示卡券
                        if(resp.dianzi_flag==1){
                            var html = "<p class='title'>"+ "恭喜您获得了"+resp.goods_name+"！"+"<p></p>"+"中奖凭证将自动下发至您的手机，请注意查收。"+"</p>";
                            cj.content({
                                msg:html,
                                btn:[{
                                    text:"关闭",
                                    callback:function(){
                                        cj.close();
                                    }
                                }]
                            });
                            return false;
                        }else{
                            var html2 = "领取成功";
                            cj.content({
                                msg:html2,
                                btn:[{
                                    text:"确定",
                                    callback:function(){
                                        cj.close();
                                    }
                                }]
                            });
                            setTimeout("cj.close()",2000);
                        }
                    }
                }else{
                    var html = "<p>"+resp.info+"</p>";
                    cj.content({
                        msg:html,
                        btn:[{
                            text:"确定",
                            callback:function(){
                                cj.close();
                            }
                        }]
                    });
                }
            }
        });
	});
});
var cj = {
	basic:function(msg){
		cj.close();
		if(!msg.title){var notitle="notitle";msg.title="";}else{var notitle="hastitle"}
		if(msg.isclose){var closehtml = '<a href="javascript:void(0)" class="close-msgPop"><i><span>+</span></i></a>'}else{var closehtml = "";}
		var html = ['<div class="msgPop bg '+notitle+'" id="'+msg.id+'">',
			'<div class="msgBg">',
			'<div class="msgTitle '+notitle+'">'+msg.title+closehtml+'</div>',
			'<div class="msgCon">'+msg.html+'</div>',
			'</div>',
			'</div>'].join('');
		$("body").append(html);
		if(typeof(msg.start) == 'string'){
			window[msg.start].call(this,$(this));
		}else if(typeof(msg.start) == 'function'){
			msg.start.call(this,$(this));
		}
		$("body").find(".msgBg",html).on("click",".cjBtn-back",function(){
			var index = $(this).index();
			if(typeof(msg.btn[index].callback) == 'string'){
				window[msg.btn[index].callback].call(this,$(this));
			}else if(typeof(msg.btn[index].callback) == 'function'){
				msg.btn[index].callback.call(this,$(this));
			}else{
				msg.repeat ? (cj.close(),cj.login({repeat:msg.repeat})) : cj.close();
				if($(this).attr("href")!="javascript:void(0)"){
					window.location.href = $(this).attr("href");
				}
			}
		});
		$("body").find(".msgBg",html).on("click",".close-msgPop",function(){
			if(typeof(msg.after) == 'string'){
				window[msg.after].call(this,$(this));
			}else if(typeof(msg.after) == 'function'){
				msg.after.call(this,$(this));
			}
			msg.repeat ? (cj.remove(),cj.login({repeat:msg.repeat})) : cj.remove();
		});
		$("body").on("click","input",msg.html,function(){
			$(this).removeClass("erro");
		});
	},
	tip:function(msg){
		$(".cjTip").remove();
		var txt = ["10秒钟内点的越多，砍掉的价格越高"];
		var codeRandom = Math.floor(Math.random()*txt.length);
		if(!msg){msg = txt[codeRandom]};
		if(msg==1){return false;}
		var html = '<div class="cjTip"><div class="cjTipTxt"><i></i><p>'+msg+'</p></div><div class="cjTipbg"></div></div>';
		$("body").append(html);
	},
	login: function (msg) {
		var html = template("js-tmpl-popForm", _global);
		msg = $.extend(true, {}, cj.msg, msg);
		msg.html = html;
		cj.basic(msg);
	},
	content:function(msg){
		msg = $.extend(true, {}, cj.msg,msg);
		msg.html = template("js-tmpl-msg",msg);
		cj.basic(msg);
	},
	remove:function(msg){
		_global.g = true;
		$(".gameCon").removeClass("end");
		$(".msgPop").remove();
		var _MsgPopglobal = {
			refurbish:false,
			repeat:true
		}
		msg = $.extend(true, {}, _MsgPopglobal,msg);
		if(msg.refurbish){
			location.href = location.href ;
		}
	},
	close:function(msg){
		_global.g = true;
		$(".gameCon").removeClass("end");
		var _MsgPopglobal = {
			refurbish:false,
			repeat:true
		}
		msg = $.extend(true, {}, _MsgPopglobal,msg);
		$(".msgPop").not("[id!='']").remove();
		if(msg.refurbish){
			location.href = location.href ;
		}
	},
	msg:{
		id:"",
		title:false,//标题
		html:false,//内容
		refurbish:false,//是否刷新
		msg:"未知错误",//内容
		icon:false,//图标
		repeat:false,//重新填出登陆框
		btn:[
			{
				text:"返回",//按钮文字
				url:"javascript:void(0)",//按钮链接
				callback:function(){
					cj.close();
				}
			}
		],
		isclose:true,
		start:false,//弹出之后callback
		after:false//关闭之后callback
	}
}
</script>
<script type="text/html" id="js-tmpl-msg">
<div class="cjText">
	{{if !html}}
	<div class="cjText-con">
		{{if !icon}}
			<div class="cjText-text noicon">{{#msg}}</div>
		{{else}}
			<div class="cjText-text">{{#msg}}</div>
			<div class="cjText-img">
				{{if icon==1}}
				<img src="__PUBLIC__/Label/Image/qianji/Item/qj-6.png" width="64">
				{{else}}
				<img src="__PUBLIC__/Label/Image/qianji/Item/qj-19-{{icon}}.png" width="100">
				{{/if}}
			</div>
		{{/if}}
	</div>
	{{else}}
	{{#html}}
	{{/if}}
</div>
<div class="cjBtn">
{{each btn as value i}}
	<a href="{{value.url}}" class="cjBtn-back {{if btn.length>1}}{{if i==0}}sm{{/if}}{{/if}}">{{value.text}}</a>
{{/each}}
</div>
</script>

<!--普通抽奖-->
<script type="text/html" id="js-tmpl-popForm">
    <div class="cjCon" id="popForm">
        <div class="cjText">
            <p>恭喜您获得了{{data.goods_name}}！</p>
            <p>{{msg}}</p>
			<div class="formDiv">
				<form id="theform" action="" method="post" name="theform">
                    <input  type="hidden" name="cj_traceid" value="{{data.cj_traceid}}" id="cj_traceid"/>
                    <input  type="hidden" name="request_id" value="{{data.request_id}}" id="request_id"/>
                    <input  type="hidden" name="bonus_use_detail_id" value="{{data.bonus_use_detail_id}}" id="bonus_use_detail_id"/>
					<ul>
						<li><input type="tel" name="mobile" id="mobile" placeholder="请输入手机号" maxlength="11"/>
							<div class="formError">手机号错误</div>
						</li>
						<li>
							<input type="tel" id="verify" name="verify" placeholder="输入验证码" class="half">
							<div class="formError">验证码错误</div>
							<input type="button" value="获取验证码" class="sOne-cjpasscode-btn" id="getpasscode" data-in_ajax='0'>
						</li>
					</ul>
				</form>
			</div>
        </div>
        <div class="cjBtn">
			<a href="javascript:void(0);" id="subcj">确定</a>
        </div>
    </div>
</script>
<script>
    var wxShareData = <?php echo json_encode($shareData);?>;
</script>
<include file="Label/Public/_shareWx"/>
<script>
    function sendfood(e){
        var zengs_flag=$("._food" + e + "").text();
        if(zengs_flag==0){
            return false;
        }
        $(".out-box").show();
        $('.out-box').on("click", function () {
            restart_wxjs();
            loadwxjs();
            $('.out-box').hide();
        });
        var food_id = e;
        var url_final_1 = "{$url_final}";
        var open_flag = $("#openid_md5").val();
        if (open_flag) {
            wxShareData.link = "{$shareUrl_send}" + "&food_id=" + e + "&url_final=" + open_flag;
        } else {
            wxShareData.link = "{$shareUrl_send}" + "&food_id=" + e + "&url_final=" + url_final_1;
        }
        wx.config({
            debug: false,
            appId: wxShareData.config.appId,
            timestamp: wxShareData.config.timestamp,
            nonceStr: wxShareData.config.nonceStr,
            signature: wxShareData.config.signature,
            jsApiList: [
                'checkJsApi',
                'onMenuShareTimeline',
                'onMenuShareAppMessage',
                'onMenuShareQQ',
                'onMenuShareWeibo',
                'hideMenuItems',
                'showMenuItems',
                'hideAllNonBaseMenuItem',
                'showAllNonBaseMenuItem',
                'translateVoice',
                'startRecord',
                'stopRecord',
                'onRecordEnd',
                'playVoice',
                'pauseVoice',
                'stopVoice',
                'uploadVoice',
                'downloadVoice',
                'chooseImage',
                'previewImage',
                'uploadImage',
                'downloadImage',
                'getNetworkType',
                'openLocation',
                'getLocation',
                'hideOptionMenu',
                'showOptionMenu',
                'closeWindow',
                'scanQRCode',
                'chooseWXPay',
                'openProductSpecificView',
                'addCard',
                'chooseCard',
                'openCard'
            ]
        });
        wx.error(function(res){
            for(var i in res){
                alert(i+':'+res[i]);
            }
        });
        wx.ready(function () {
            wxShareData.desc = "{$nickname}"+"有一份活动材料转赠给你，助你得到精美好礼。";
            wxShareData.title = "我是升旗手，快来升旗赢好礼。";
            wxShareData.title1 = "{$nickname}"+"有一份活动材料转赠给你，助你得到精美好礼。";
            wxShareData.imgUrl = "{$headimgurl}";
            $("#food_id").val(food_id);
            //调用微信分享
            wx.onMenuShareAppMessage({
                title: wxShareData.title, // 分享标题
                desc: wxShareData.desc, // 分享描述
                link: wxShareData.link, // 分享链接
                imgUrl: wxShareData.imgUrl, // 分享图标
                success: function (res) {
                    // 用户确认分享后执行的回调函数
                    if (typeof(wxShareData.ShareAppMessageSuccess) == 'string' && wxShareData.ShareAppMessageSuccess != '') {
                        window[wxShareData.ShareAppMessageSuccess].call(this, res);
                    } else if (typeof(wxShareData.ShareAppMessageSuccess) == 'function') {
                        wxShareData.ShareAppMessageSuccess.call(this, res);
                    }
                },
                cancel: function (res) {
                    // 用户取消分享后执行的回调函数
                    wxShareData.link = "{$shareUrl}";
                    $(".out-box").hide();
                    if (typeof(wxShareData.ShareAppMessageCancel) == 'string' && wxShareData.ShareAppMessageCancel != '') {
                        window[wxShareData.ShareAppMessageCancel].call(this, res);
                    } else if (typeof(wxShareData.ShareAppMessageCancel) == 'function') {
                        wxShareData.ShareAppMessageCancel.call(this, res);
                    }
                }
            });
            wx.onMenuShareTimeline({
                title: wxShareData.title1, // 分享标题
                desc: wxShareData.desc, // 分享描述
                link: wxShareData.link, // 分享链接
                imgUrl: wxShareData.imgUrl, // 分享图标
                success: function (res) {
                    // 用户确认分享后执行的回调函数
                    if (typeof(wxShareData.ShareTimelineSuccess) == 'string' && wxShareData.ShareTimelineSuccess != '') {
                        window[wxShareData.ShareTimelineSuccess].call(this, res);
                    } else if (typeof(wxShareData.ShareTimelineSuccess) == 'function') {
                        wxShareData.ShareTimelineSuccess.call(this, res);
                    }
                },
                cancel: function (res) {
                    // 用户取消分享后执行的回调函数
                    if (typeof(wxShareData.ShareTimelineCancel) == 'string' && wxShareData.ShareTimelineCancel != '') {
                        window[wxShareData.ShareTimelineCancel].call(this, res);
                    } else if (typeof(wxShareData.ShareTimelineCancel) == 'function') {
                        wxShareData.ShareTimelineCancel.call(this, res);
                    }
                }
            });
            wxShareData.ShareTimelineSuccess = function (res) {
                //分享成功,朋友圈，调用Post方法去扣减材料
                $(".out-box").hide();
                var food_id = $("#food_id").val();
                var url = "{:U('Label/NationDay/zengs',array('id'=>$id))}";
                var openid_md5 = $("#openid_md5").val();
                restart_wxjs();
                $.ajax({
                    url: url,
                    type: "POST",
                    data: {food_id: food_id, url_final: openid_md5},
                    timeout: 10000,
                    dataType: "json",
                    success: function (data) {
                        if (data.status == 1) {
                            foods_no(food_id);
                            $("#openid_md5").val(data.new_openid_md5);
                            alert(data.info);
                        } else {
                            alert(data.info);
                        }
                    }
                });
            }
            wxShareData.ShareTimelineCancel = function (res) {
                //取消将分享链接
                //wxShareData.link="{$shareUrl}";
                restart_wxjs();
                loadwxjs();
                $(".out-box").hide();
            }
            wxShareData.ShareAppMessageSuccess = function (res) {
                //分享好友成功，调用Post方法去扣减材料
                $(".out-box").hide();
                var food_id = $("#food_id").val();
                var url = "{:U('Label/NationDay/zengs',array('id'=>$id))}";
                var openid_md5 = $("#openid_md5").val();
                restart_wxjs();
                $.ajax({
                    url: url,
                    type: "POST",
                    data: {food_id: food_id, url_final: openid_md5},
                    timeout: 10000,
                    dataType: "json",
                    success: function (data) {
                        if (data.status == 1) {
                            foods_no(food_id);
                            $("#openid_md5").val(data.new_openid_md5);
                            alert(data.info);
                            //赋值给新的openid
                        } else {
                            alert(data.info);
                        }
                    }
                });
            }
            wxShareData.ShareAppMessageCancel = function (res) {
                //取消将分享链接
                //wxShareData.link="{$shareData['link']}";
                restart_wxjs();
                loadwxjs();
                $(".out-box").hide();
            }
        });
    }
    //取消分享，调用js重新加载
    function  restart_wxjs(){
        var wxShareData = <?php echo json_encode($shareData);?>;
        var wxShareData = (typeof(wxShareData) != 'undefined') ? wxShareData : {
            config:{}
        };
        //调用微信分享
        wx.onMenuShareAppMessage({
            title: wxShareData.title, // 分享标题
            desc: wxShareData.desc, // 分享描述
            link: wxShareData.link, // 分享链接
            imgUrl: wxShareData.imgUrl, // 分享图标
            success: function (res) {
                // 用户确认分享后执行的回调函数
                if(typeof(wxShareData.ShareAppMessageSuccess) == 'string' && wxShareData.ShareAppMessageSuccess != ''){
                    window[wxShareData.ShareAppMessageSuccess].call(this,res);
                }else if(typeof(wxShareData.ShareAppMessageSuccess) == 'function'){
                    wxShareData.ShareAppMessageSuccess.call(this,res);
                }
            },
            cancel: function (res) {
                // 用户取消分享后执行的回调函数
                wxShareData.link="{$shareUrl}";
                $(".out-box").hide();
                if(typeof(wxShareData.ShareAppMessageCancel) == 'string' && wxShareData.ShareAppMessageCancel != ''){
                    window[wxShareData.ShareAppMessageCancel].call(this,res);
                }else if(typeof(wxShareData.ShareAppMessageCancel) == 'function'){
                    wxShareData.ShareAppMessageCancel.call(this,res);
                }
            }
        });
        wx.onMenuShareTimeline({
            title: wxShareData.title, // 分享标题
            desc: wxShareData.desc, // 分享描述
            link: wxShareData.link, // 分享链接
            imgUrl: wxShareData.imgUrl, // 分享图标
            success: function (res) {
                // 用户确认分享后执行的回调函数
                if(typeof(wxShareData.ShareTimelineSuccess) == 'string' && wxShareData.ShareTimelineSuccess != ''){
                    window[wxShareData.ShareTimelineSuccess].call(this,res);
                }else if(typeof(wxShareData.ShareTimelineSuccess) == 'function'){
                    wxShareData.ShareTimelineSuccess.call(this,res);
                }
            },
            cancel: function (res) {
                // 用户取消分享后执行的回调函数
                if(typeof(wxShareData.ShareTimelineCancel) == 'string' && wxShareData.ShareTimelineCancel != ''){
                    window[wxShareData.ShareTimelineCancel].call(this,res);
                }else if(typeof(wxShareData.ShareTimelineCancel) == 'function'){
                    wxShareData.ShareTimelineCancel.call(this,res);
                }
            }
        });
    }
    //
    //领取成功后，将材料的值减1
    function foods_no(e){
        var test = $("._food" + e + "").text() - 1;
        $("._food" + e + "").html(test);
        if(e==2){
            //材料2
            if(test==0){
                $("#_food"+e+"").addClass('erro');
                $("#score_color"+1+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
            }
        }
        if(e==0){
            //材料2
            if(test==0){
                $("#_food"+e+"").addClass('erro');
                $("#score_color"+2+"").removeClass('ok');
                $("#score_color"+6+"").removeClass('ok');
                $("#score_color"+7+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
                $(".btn-get"+2+"").addClass('erro');
                $(".btn-get"+3+"").addClass('erro');
            }else if(test>=1 && test <2){
                $("#score_color"+2+"").removeClass('ok');
                $("#score_color"+6+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
                $(".btn-get"+2+"").addClass('erro');
                $(".btn-get"+3+"").addClass('erro');
            }else if(test>=2 && test <3){
                $("#score_color"+2+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
            }
        }
        if(e==1){
            //材料2
            if(test==0){
                $("#_food"+e+"").addClass('erro');
                $("#score_color"+3+"").removeClass('ok');
                $("#score_color"+5+"").removeClass('ok');
                $("#score_color"+8+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
                $(".btn-get"+2+"").addClass('erro');
                $(".btn-get"+3+"").addClass('erro');
            }else if(test>=1 && test <2){
                $("#score_color"+3+"").removeClass('ok');
                $("#score_color"+5+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
                $(".btn-get"+2+"").addClass('erro');
                $(".btn-get"+3+"").addClass('erro');
            }else if(test>=2 && test <3){
                $("#score_color"+3+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
            }
        }
        if(e==3){
            //材料2
            if(test==0){
                $("#_food"+e+"").addClass('erro');
                $("#score_color"+4+"").removeClass('ok');
                $(".btn-get"+1+"").addClass('erro');
                $(".btn-get"+2+"").addClass('erro');
            }
        }
        loadinglq();
    }
    //领取成功后，将材料的值减1
    function foods_shao(){
        var jp_type=$("#jp_type").val();
        var test2=null;
        var test0=null;
        var test1=null;
        var test3=null;
        if(jp_type==1){
            test2 = $("._food" +2+ "").text() - 1;
            $("._food" +2+ "").html(test2);
            test0 = $("._food" +0+ "").text() - 3;
            $("._food" +0+ "").html(test0);
            test1 = $("._food" +1+ "").text() - 3;
            $("._food" +1+ "").html(test1);
            test3 = $("._food" +3+ "").text() - 1;
            $("._food" +3+ "").html(test3);
        }else if(jp_type==2){
            test0 = $("._food" +0+ "").text() - 2;
            $("._food" +0+ "").html(test0);
            test1 = $("._food" +1+ "").text() - 3;
            $("._food" +1+ "").html(test1);
            test3 = $("._food" +3+ "").text() - 1;
            $("._food" +3+ "").html(test3);
        }else{
            test0 = $("._food" +0+ "").text() - 2;
            $("._food" +0+ "").html(test0);
            test1 = $("._food" +1+ "").text() - 2;
            $("._food" +1+ "").html(test1);
        }

        test0 = $("._food" +0+ "").text();
        test1 = $("._food" +1+ "").text();
        test2 = $("._food" +2+ "").text();
        test3 = $("._food" +3+ "").text();
        if(test2==0){
            $("#_food"+2+"").addClass('erro');
            $("#score_color"+1+"").removeClass('ok');
            $(".btn-get"+1+"").addClass('erro');
        }
        if(test0==0){
            $("#_food"+0+"").addClass('erro');
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
            $(".btn-get"+3+"").addClass('erro');
            $("#score_color"+2+"").removeClass('ok');
            $("#score_color"+6+"").removeClass('ok');
            $("#score_color"+7+"").removeClass('ok');
        }
        if(test1==0){
            $("#_food"+1+"").addClass('erro');
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
            $(".btn-get"+3+"").addClass('erro');
            $("#score_color"+3+"").removeClass('ok');
            $("#score_color"+5+"").removeClass('ok');
            $("#score_color"+8+"").removeClass('ok');
        }
        if(test3==0){
            $("#_food"+3+"").addClass('erro');
            $("#score_color"+4+"").removeClass('ok');
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
        }
        //判断0是否会亮
        if(test0>=1 && test0<2 ){
//            $("#score_color"+7+"").addClass('ok');
            $("#score_color"+6+"").removeClass('ok');
            $("#score_color"+2+"").removeClass('ok');
        }
        if(test0>=2 && test0<3 ){
//            $("#score_color"+7+"").addClass('ok');
//            $("#score_color"+6+"").addClass('ok');
            $("#score_color"+2+"").removeClass('ok');
        }
        if(test0>=3){
//            $("#score_color"+7+"").addClass('ok');
//            $("#score_color"+6+"").addClass('ok');
//            $("#score_color"+2+"").addClass('ok');
        }
        //判断1是否会亮
        if(test1>=1 && test1<2 ){
            $("#score_color"+8+"").addClass('ok');
            $("#score_color"+3+"").removeClass('ok');
            $("#score_color"+5+"").removeClass('ok');
        }else if(test1>=2 && test1<3 ){
            $("#score_color"+8+"").addClass('ok');
            $("#score_color"+5+"").addClass('ok');
            $("#score_color"+3+"").removeClass('ok');
        }if(test1>=3){
            $("#score_color"+8+"").addClass('ok');
            $("#score_color"+5+"").addClass('ok');
            $("#score_color"+3+"").addClass('ok');
        }
        loadinglq();
    }
    //加载的时候判断下立即领取按钮样式
    function loadinglq(){
        //判断一，二，三等奖
        if($("._food"+2+"").text()<1){
            $(".btn-get"+1+"").addClass('erro');
        }
        if($("._food"+0+"").text()==0 || $("._food"+0+"").text()==1 ){
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
            $(".btn-get"+3+"").addClass('erro');
        }else if($("._food"+0+"").text()>=2 && $("._food"+0+"").text()<3){
            $(".btn-get"+1+"").addClass('erro');
        }
        if($("._food"+1+"").text()==0 || $("._food"+1+"").text()==1 ){
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
            $(".btn-get"+3+"").addClass('erro');
        }else if($("._food"+1+"").text()>=2 && $("._food"+1+"").text()<3){
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
        }
        if($("._food"+3+"").text()<=0){
            $(".btn-get"+1+"").addClass('erro');
            $(".btn-get"+2+"").addClass('erro');
        }
    }
    function ajaxNationDay(card_id){
        _global.flag=false;
        var url="{:U('Label/NationDay/conversionJp',array('id'=>$id))}";
        $.ajax({
            url: url,
            type: "POST",
            data: {jp_type:$("#jp_type").val(),tcj_cate_id:$("#tcj_cate_id").val(),card_id:card_id},
            timeout: 10000,
            dataType: "json",
            success: function (resp) {
                _global.flag=true;
                if(resp.status == 1){
                    foods_shao();
                    //微信卡券逻辑
                    if(typeof(resp.info.card_ext) == "string" && typeof(resp.info.card_id) == "string" && resp.info.card_ext !="" && resp.info.card_id !=""){
                        var html = "<p class='title'>"+ "恭喜您获得了"+resp.info.goods_name+"！"+"<p></p>"+"您可现在去领取或稍后在中奖记录中查看领取。"+"</p>";
                        cj.content({
                            msg:html,
                            btn:[{
                                    text:"关闭",
                                    callback:function(){
                                        cj.close();
                                    }
                                },{
                                    text:"去领取",
                                    url:"javascript:getWxCard2("+JSON.stringify(resp.info.card_id)+","+JSON.stringify(resp.info.card_ext)+")"
                             }]
                        });
                        return false;
                    }
                    //卡券逻辑
                    if(typeof(resp.flage) == "string"){
                        var html = "<p class='title'>"+ "恭喜您获得了"+resp.goods_name+"！"+"<p></p>"+"中奖凭证将自动下发至您的手机,请注意查收。"+"</p>";
                        cj.content({
                            msg:html,
                            btn:[{
                                text:"关闭",
                                callback:function(){
                                    cj.close();
                                }
                            }]
                        });
                        return false;
                    }
                    //红包逻辑
                    if(resp.info.type == 1){
                        if(resp.info.link_flag == 1){
                            var html2 = "<p class='title'>"+ "恭喜您获得了"+resp.info.bonus_page_name+"！"+"<p></p>"+"您可现在去使用或稍后在中奖记录中查看领取。"+"</p>";
                            cj.content({
                                msg: html2,
                                btn:[{
                                    text:"关闭",
                                    callback:function(){
                                        cj.close();
                                    }
                                },{
                                    text:"去使用",
                                    url:resp.info.link_url
                                }]
                            });
                            return false;
                        }else{
                            var html = "<p class='title'>"+ "恭喜您获得了"+resp.info.bonus_page_name+"！"+"<p></p>"+"您可在中奖记录中查看领取。"+"</p>";
                            cj.content({
                                msg:html,
                                btn:[{
                                    text:"关闭",
                                    callback:function(){
                                        cj.close();
                                    }
                                }]
                            });
//                                    setTimeout("cj.close()",2000);
                            return false;
                        }
                    }
                    _global.data = resp.info;
                    _global.msg = resp.msg;
                    cj.login();
                }else{
                    var html = "<p>"+resp.info+"</p>";
                    cj.content({
                        msg:html,
                        btn:[{
                            text:"确定",
                            callback:function(){
                                cj.close();
                            }
                        }]
                    });
                }
            }
        });
    }
</script>