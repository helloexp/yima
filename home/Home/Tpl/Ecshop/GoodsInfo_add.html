<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>创建商品_旺财小店_翼码旺财</title>
<link href="__PUBLIC__/Css/main.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/layout.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/module.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wnumgoods.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wshop.css?v=__VR__" rel="stylesheet" type="text/css" />
<load href="__PUBLIC__/Js/validationEngine/css/validationEngine.jquery.css" />
<script type="text/javascript" src="__PUBLIC__/Js/jquery-1.7.1.min.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/global.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery.form.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/validationEngine/languages/jquery.validationEngine-zh_CN.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/validationEngine/jquery.validationEngine.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery-ui-1.11.2.custom/template.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery.cookie.js?v=__VR__"></script>
<script>
$(function(){
	$("#selectShop").click(function(e){
		art.dialog.open("{:U('Home/Store/storePopup')}",{
			title: '选择门店',
			width:'800px'
		});
		//$(".newRadio-default").show();
	});
	
	$("#editStore").click(function(){
		art.dialog.open("{:U('Home/Store/storePopup')}",{
			title: '选择门店',
			width:'800px'
		});
	});

	
	$("#theform").validationEngine();
    var is_submit = false;
    $("#sub_button").click(function(){
        //if(is_submit == true){$('#sub_button').attr('class','btn-all-del');return false;}
    	var dialog;
		var price = [];
		$(".skuTable [name='price']").each(function(index, element) {
            var p = $(this).val();
			var nid = $(this).attr("data-newid").split(",");
			var sid = new Array();
            var n = $(this).closest("tr").find("[name='num']").val();
			if(n==""||n=="不限"){n="-1"};
			for(var i=0;i<=nid.length;i++){
				sid.push(nid[i]);
			}
			var arr = {
				newid:sid,
				price:p,
				num:n
			};
			price.push(arr);
        });
	data["price"] = price;
        //console.info(data);return false;
        $('#data_price_info').val(JSON.stringify( data.price ));
        $('#data_name_info').val(JSON.stringify( data.namelist ));
		if($("#theform").validationEngine('validate')){
            $("#theform").ajaxSubmit({
                beforeSubmit:function(arr, $form, options){
                    $form["sku"] = data;
                    is_submit = true;
                    dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
                },
                success:function(data){
                 if(data.status == '1'){
                       all_art_close();
                       $('#div_content').hide();
                       $('#div_success').show();
                       windowheight();
                       return false;
                  }else{
                       dialog.time(5).content("<div class='msg-all-error'>"+data.info+"</div>");
                  }
            },
                dataType:'json'
            });
            return false;
        }
    });
    $(".message-show").click(function(){
        var message=$("#mms_text").val();
        var html=
        ['<div class="aipai-iphone">',
          '<div class="aipai-iphone-text">',
              message,
          '</div>',
          '</div>'].join('');
          art.dialog({
            padding: 20,
            title: '短信预览',
            content: html
        });
    });
    $(".print-show").click(function(){
        var message=$("#mms_text").val();
        var html=['<img src="__PUBLIC__/Image/iphone_bg2_print.png" />'].join('');
          art.dialog({
            padding: 0,
            title: '什么是小票内容？',
            content: html,
			width:690
        });
    });
})
function openOrder(t){
	var isorder = findorder();
	var v = t.attr("data-val");
	if(v==1){
        //显示限制按钮
        $('.goods_list').show();
		$("#openOrder").hide();
		if(isorder!=false || isorder===0){
			data.namelist.splice(isorder,1);
		}
		$(".addsku").removeClass("hide");
		begin(data);
	}else{
		if(data.namelist.length>=3){
			t.closest(".newRadio").find("span[data-val='1']").click();
			art.dialog.msg({content: '订购商品最多支持两个商品规格,您可以先删除一个商品规格后开启'});
			return false;
		}
        //隐藏限制按钮
        $('.goods_list').hide();
		$("#openOrder").show();
		var name = "月";
		$("#dg2").val()==1&&(name="月");
		$("#dg2").val()==2&&(name="周");
		$("#dg2").val()==3&&(name="日");
		if(isorder!=false || isorder===0){
			data.namelist[isorder].name = name;
			data.namelist[isorder].ordertype = $("#dg2").val();
		}else{
			data.namelist.push({
				name:name,
				ordertype:$("#dg2").val(),
				list:[]
			})
		}
		begin(data);
	}
}
function openOrderTime(t){
	var v = t.attr("data-val");
	var name = "月";
	v==1&&(name="月");
	v==2&&(name="周");
	v==3&&(name="日");
	var isorder = findorder();
	if(isorder!=false || isorder===0){
		data.namelist[isorder].name = name;
		data.namelist[isorder].ordertype = v;
	}
	begin(data);
}
function checkorder(field, rules, i, options){
	var c = field.closest(".skuRuleAdd"),
		v = field.val().replace(/\s/,""),
		cid = parseInt(field.closest(".skuRule").attr("data-newid"));
		for(var i=0;i<data.namelist.length;i++){
			if(data.namelist[i].newid == cid ){
				for(var j=0;j<data.namelist[i].list.length;j++){
					if(data.namelist[i].list[j].val==field.val()){
						return "该类型下您已经创建过一次'"+field.val()+"'了"
					}
				}
			}
		}
}
</script>
</head>
<body>
    <div id="wrapper" class="nomalCon">
        <include file="./Home/Tpl/Public/Public_header.html" />
		<!--开始载入头部菜单--> 
        <include file="Shop/nav" navmenuid="Navproduct"/>
        <div id="container" class="bgfff">
            <div id="main" class="rel">
				<div id="div_content">
                <div class="shopCon">
                    <div class="main-name fn">
                        <h4 class="bd-b-565656">我要创建商品</h4>
                    </div>
                    <div id="store_check">
                        <div class="numgoods-info <eq name='addStore' value='1'>dn</eq>">
                            <li>1  商品基本信息确定提交后不可修改</li>
                            <li>2  标记有“*”的字段为必填字段</li>
                            <li>3  商品创建完成后，可被【旺财小店】【闪购】【码上买】等直接调用</li>
                        </div>
                        <form method="post" action="<?php echo U('Ecshop/GoodsInfo/add');?>" id="theform">
                        <div class="Gform l w700 fn <eq name='addStore' value='1'>dn</eq> fistForm">
                            <div id="Wform">
                                <ul class="Gtitle">商品基本内容</ul>
                                <ul>
                                    <li class="Gname">*&nbsp;商品名称</li>
                                    <li class="Ginput"><input name="name" id="name" type="text" class="validate[required]" maxlength="24" /><span class="maxTips forInput" data-max="24">0/24</span><span class="txtTips important">商品创建后名称无法修改</span></li>
                                </ul>
                                <ul>
                                    <li class="Gname">&nbsp;商品货号</li>
                                    <li class="Ginput"><input name="customer_no" id="name" type="text" maxlength="24" /></li>
                                </ul>
                                 <ul>
                                    <li class="Gname">*&nbsp;商品图片</li>
                                    <li class="Ginput">
                                        <div class="Gchoose">
                                            <input type="text" value="" name="img_resp" id="img_resp" class="validate[required]">
                                            <a href="javascript:void(0)" class="Gbtn-pic" title="选择图片" data-rel="{width:640,height:400}"><i></i></a>
                                        </div>
                                    </li>
                                 </ul>
                                 <ul>
                                    <li class="Gnmae">*&nbsp;开启订购功能</li>
                                    <li class="Ginput">
                                        <div class="switch" data-callback="openOrder">
                                            <input type="radio" name="dg" id="dg" value="1" checked="checked" />
                                            <div class="newRadio">
                                                <span class="valfirst hover" data-val="1">关闭</span>
                                                <span class="vallast" data-val="2">开启</span>
                                            </div>
                                        </div>
                                        <span class="txtTips"><a href="{:U('Home/Help/helpDetails',array('newsId'=>1513,'classId'=>47))}" target="_blank">什么是订购？</a></span>
                                    </li>
                                </ul>
                                <div id="openOrder" class="dn">
                                    <ul>
                                        <li class="Gnmae">*&nbsp;配送周期</li>
                                        <li class="Ginput">
                                            <div class="switch auto" data-callback="openOrderTime">
                                                <input type="radio" name="dg2" id="dg2" value="1" checked="checked" />
                                                <div class="newRadio">
                                                    <span class="valfirst hover" data-val="1">月</span>
                                                    <span class="vallast" data-val="2">周</span>
                                                    <span class="vallast" data-val="3">日</span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                    <ul>
                                        <li class="Gnmae">*&nbsp;订购周期</li>
                                        <li class="Ginput">
                                            <div class="skuOrderRule fn">
                                                <div class="skuRule">
                                                    <div class="skuRuleAdd">
                                                        <div class="input">
                                                            <input type="text" maxlength="2" class="validate[required,custom[integer],max[24],min[1],funcCall[checkorder]] orderAddinput">
                                                            <i class="icon-skuOk erro">
                                                                <a href="javascript:void(0)" class="a-hide">修改</a>
                                                            </i>
                                                        </div>
                                                        <div class="skuRuleBtn">
                                                            <i></i>添加订购周期
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                    <ul style="margin-top:-10px;">
                                        <li class="Gnmae">*&nbsp;短信通知</li>
                                        <li class="Ginput">
                                            <label><input type="checkbox" name="msgConfig" id="group3-3" />开启系统自动发送送货通知短信服务<span class="red">（收费标准 0.1 元/条）</span></label>
                                            <div class="cl"></div>
                                            <p class="l">配送前</p><input type="text" class="l validate[condRequired[group3-3]]" name="sendTime" style="width:40px; padding-right:2px;"><p class="l">天，发送发货通知短信</p>
                                            <div class="cl"></div>
                                            <span class="txtTips">开启此项服务后，每个预定配送日前N天，系统将自动给订购此商品的消费者发送送货通知短信</span>
                                        </li>
                                    </ul>
                                </div>
                                <ul>
                                    <li class="Gname">&nbsp;商品规格</li>
                                    <li class="Ginput">
                                    	<div class="skuForm">
                                        </div>
                                        <span class="txtTips">商品规格最多添加3个</span>
                                    </li>
                                </ul>
                                <ul class="sku1">
                                    <li class="Gname">*&nbsp;价格与库存</li>
                                    <li class="Ginput">
                                    	<div class="fn skuTable"></div>
                                        <span class="txtTips"></span>
                                    </li>
                                </ul>
                                <ul class="sku2">
                                    <li class="Gname">*&nbsp;商品价格</li>
                                    <li class="Ginput">
                                        <input name="market_price" type="text"  class="validate[required,custom[number],min[0]]" maxlength="10"/><span class="maxTips forInput">元</span>
                                    </li>
                                </ul>
                                <ul class="sku2">
                                    <li class="Gname">*&nbsp;商品数量</li>
                                    <li class="Ginput">
                                        <div class="switch">
                                            <input type="radio" name="num_type" value="0" checked="checked" />
                                            <div class="newRadio">
                                                <span class="valfirst" data-val="0">不限</span>
                                                <span class="vallast goods_list" data-val="1">限制</span>
                                            </div>
                                            <div class="newRadio-input">
                                                <input name="goods_num" type="text" class="validate[required,min[1],custom[integer]]" style="width:350px;"/><span class="maxTips forInput">份</span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                <php>if($is_cnpc_gx){</php>
                                <ul>
                                    <li class="Gname">*&nbsp;所属商户</li>
                                    <li class="Ginput">
                                    	<select name="merchant_id" id="merchant_id"  class="validate[required]">
                                                <option value="">请选择</option>
                                                <php>
                                                    $parentArr = array_valtokey($merchantInfo,'id','merchant_name');
                                                </php>
                                                {:show_arr_opt($parentArr,'')}
                                            </select>
                                    </li>
                                </ul>
                                <php>}</php>
                                <!--
                               <ul>
                                    <li class="Gname">*&nbsp;配送方式</li>
                                    <li class="Ginput">
                                    <input name="delivery_type" id="delivery_type" value="1" checked="checked" type="radio" class="choosetext1" onclick="javascript:$('.delivery_type_con').show();"/><p class="ml5 choosetext1">电子凭证自提</p>
                                    <input name="delivery_type" id="delivery_type" value="2" type="radio" class="ml20 choosetext2" onclick="javascript:$('.delivery_type_con').hide();"/><p class="ml5 choosetext2">物流配送</p></li>
                               </ul>
                               -->
                                <ul>
                                    <li class="Gname">*&nbsp;商品描述</li>
                                    <li class="Ginput"><textarea name="goods_desc" id="goods_desc" class="validate[required,maxSize[200]]"></textarea><span class="maxTips forArea" data-max="200">0/200</span></li>
                                </ul>
                                <div class="Gmore">
                                    <div class="Gbtn-more"><span>更多设置：<i></i></span><p>如果您希望该商品支持到店自提，则需要对相关内容进行设置</p></div>
                                    <div class="GmoreForm">
                                        <ul>
                                            <li class="Gnmae">*&nbsp;可验证门店</li>
                                            <li class="Ginput">
                                            	<div class="switch">
                                                    <input type="radio" name="shop" id="shop" value="1" checked="checked" />
                                                    <div class="newRadio">
                                                        <span class="valfirst hover" data-val="1">所有门店</span>
                                                        <span class="vallast" data-val="2" id="selectShop">指定门店</span>
                                                    </div>
                                                    <div class="cl fn"></div>
                                                    <div class="newRadio-input">
                                                        <div class="sweet_tips2" id="htmlss">您总共选择了<span id="number">0</span>家门店&nbsp;&nbsp;<a href="javascript:void()" id="editStore"  name="choose_shop">点击查看</a></div>
                                                    <input type="hidden" id="openStores" name="openStores" value=""/>
                                                    </div>
                                                    <!--<div class="newRadio-input">
                                                    <div class="Gchoose" style="width:232px;">
                                                    	
                                                        <a href="javascript:void(0)" data-name="shop_id[]">您已选择<span id="number" style="color:#ff971c;">0</span>家可验证门店</a>
                                                        <a href="javascript:void(0)" class="Gbtn-shop" title="选择门店" data-url="{:U('WangcaiPc/NumGoods/shopList')}&type=1"><i></i></a>
                                                    </div>
                                                    </div>-->
                                                </div>
                                                <p class="txtTips">注：仅限已安装核验终端的门店</p>
                                            </li>
                                        </ul>
<!--                                        <ul>
                                            <li class="Gname">&nbsp;彩信标题</li>
                                            <li class="Ginput">
                                                <input id="mms_title" name="mms_title" type="text" class="validate[maxSize[10]]"/><span class="maxTips forInput" data-max="10">0/10</span>
                                            </li>
                                        </ul>
                                        <ul>
                                            <li class="Gname">&nbsp;彩信内容</li>
                                            <li class="Ginput">
                                                <textarea name="mms_text" id="mms_text" class="validate[maxSize[100]]"></textarea>
                                                <span class="maxTips forArea" data-max="100">0/100</span>
                                                <span class="txtTips"><a href="javascript:void(0)" class="message-show" style="color:#ff971c;">预览彩信内容</a></span>
                                            </li>
                                        </ul>-->
                                        <ul>
                                            <li class="Gname">&nbsp;打印小票内容</li>
                                            <li class="Ginput">
                                                <textarea name="print_text" id="print_text" class="validate[maxSize[100]]"></textarea>
                                                <span class="maxTips forArea" data-max="100">0/100</span>
                                                <span class="txtTips">编辑以上内容，可在消费者自提商品时，在打印小票上添加个性信息。<a href="javascript:void(0)" class="print-show" style="color:#ff971c;">什么是小票内容?</a></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                               <input type="hidden" value="" name="data_price_info" id="data_price_info" />
                               <input type="hidden" value="" name="data_name_info" id="data_name_info" /> 
                               <input type="hidden" value="" name="count_num" id="count_num" /> 
                                <ul>
                                    <li class="Gname">&nbsp;</li>
                                    <li class="Ginput">
                                    <a href="javascript:void(0);" id="sub_button" class="btn-all">确认</a>
                                    <a href="javascript:history.go(-1)" class="btn-all-del">取消</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        </form>
                    </div>
				</div>
			</div>
            <div class='loadTip' style="display:none; padding-top:100px;" id="div_success">
                <div class='loadStatus ok'>
                    <dl>
                        <dt>商品创建成功！</dt>
                        <dd>您可以在【旺财小店】【闪购】【码上买】等直接调用。</dd>
                        <dd>点击<a href="{:U('index')}">返回列表</a>&nbsp;|&nbsp;<a href="{:U('add')}">继续添加</a>。</dd>
                    </dl>
                </div>
            </div>
        </div>
     </div>
</div>
<include file="./Home/Tpl/Public/Public_footer.html" />
<div class="service"></div>
</body>
</html>
<script>
var newid = 1;
var data = {
	cookiename:"",
	cookielist:"",
	length:function(){
		var l = 0;
		for(var i=0;i<data.namelist.length;i++){
			if(data.namelist[i].list!=""){
				l++;
			}
		}
		if(l==0){l="";}
		return l;
	},
	length2:function(){
		var l = 0;
		for(var i=0;i<data.namelist.length;i++){
			if(data.namelist[i].list!=""){
				l++;
			}
		}
		return l+2;
	},
	length3:function(){
		var l = 0;
		if(data.namelist.length==1){
			l = 0;
		}else if (data.namelist.length==2){
			l = data.namelist[1].list.length;
		}else if (data.namelist.length==3){
			if(data.namelist[2].list.length!=0){
				l = data.namelist[1].list.length*data.namelist[2].list.length;
			}else{
				l = data.namelist[1].list.length;
			}
		}
		if(l==0){l="";}
		return l;
	},
	length4:function(){
		var l = 0;
		if (data.namelist.length==2){
			l = 0;
		}else if (data.namelist.length==3){
			l = data.namelist[2].list.length;
		}
		if(l==0){l="";}
		return l;
	},
	namelist:[],
	price : []
};
//大部分修改预览
$(document).ready(function(e){
	cookie();
	begin(data);
	$(".skuRuleAdd input").validationEngine();
	//输入规则
	$("body").on("change keyup click",".searchInput-edit input[type='text'],.skuRuleAdd input[type='text']",function(e){
		var t = $(this),
			i = t.closest(".input").find(".icon-skuOk"),
			v = t.val(),
			l = t.closest(".input").next("dl"),
			erro = 1;
		v=="" ? i.addClass("erro") : i.removeClass("erro");
		if(e.keyCode != 13){
			l.find("dd:not('.nodata')").each(function(index, element) {
				var text = $(this).text();
				text.indexOf(v)>=0 ? ($(this).removeClass("dn"),erro++) : $(this).addClass("dn");
			});
			erro>=7 ? l.height(200) : l.height(erro*26-26);
			erro==1 ? (l.height(erro*26),l.find(".nodata").removeClass("dn")) : l.find(".nodata").addClass("dn");
		}
		if(e.keyCode == 13){
			i.click();
			return false;
		}
	});
	//设置总库存:检测数值
	$("body").on("change keyup click","input[name='allprice'],input[name='allnum']",function(e){
		var t = $(this),
			i = t.closest("td").find(".icon-skuOk"),
			v = t.val();
		v=="" ? i.addClass("erro") : i.removeClass("erro");
	});
	//设置总库存:确认
	$("body").on("click",".skuOk-allprice:not('.erro'),.skuOk-allnum:not('.erro')",function(e){
		var t = $(this),
			h = t.hasClass("skuOk-allprice"),
			i = t.closest("td").find("input"),
			v = i.val();
		if(h){
			var r = /^[\-\+]?((([0-9]{1,3})([,][0-9]{3})*)|([0-9]+))?([\.]([0-9]+))?$/;
			r = r.test(v);
			if(r){
				$("input[name='price']").val(v);
			}else{
				i.addClass("shopFormBannerAn");
				setTimeout(function(){
					i.removeClass('shopFormBannerAn')
				},1000);
			}
		}else{
			var r = /^[\-\+]?\d+$/;
			r = r.test(v);
			if(r){
				$("input[name='num']").val(v);
                                $('#count_num').val($("input[name='num']").length*v);
				$("#all").text("已设置的总库存为："+$("input[name='num']").length*v+"，不填写库存，则商品库存为不限,总共0处为不限");
			}else{
				i.addClass("shopFormBannerAn");
				setTimeout(function(){
					i.removeClass('shopFormBannerAn')
				},1000);
			}
		}
		t.addClass("erro");
		i.val("");
	});
	//设置总库存:库存总数预览
	$("body").on("change keyup","input[name='num']",function(e){
		var l = 0;
		var t = 0;
		for(var i=0;i<$("input[name='num']").length;i++){
			if($("input[name='num']:eq("+i+")").val()=="" || $("input[name='num']:eq("+i+")").val()=="不限" || $("input[name='num']:eq("+i+")").val()=="-1"){
				t++;
			}else{
				l += parseInt($("input[name='num']:eq("+i+")").val());
			}
		}
                if(t > 0)
                    $('#count_num').val('-1');
                else
                    $('#count_num').val(l);
                //$("#all").text("已设置的总库存为："+l+"，不填写库存，则商品库存为不限,总共"+t+"处为不限");
		$("#all").text("已设置的总库存为："+l+"，不填写库存，则商品库存为不限,总共"+t+"处为不限");
	});
	//下拉菜单:点击dd
	$("body").on("click",".valLsit dd:not('.nodata')",function(e){
		$(".searchInput-edit").hide();
		var t = $(this),
			v = t.text(),
			i = t.closest(".valLsit").prev(".input").find("input"),
			ok = t.closest(".valLsit").prev(".input").find(".icon-skuOk");
			i.val(v);
			ok.removeClass("erro").click();
	});
	//下拉菜单:关闭
	$("body").on("click",".valLsitclose",function(e){
		$(this).closest(".searchInput-edit").hide();
		$(this).closest(".skuRuleAdd").removeClass("edit");
	});
	//修改规则
	$("body").on("click",".searchInput .icon-skuEdit,.searchInput>span",function(e){
		$(".searchInput-edit").hide();
		var t = $(this),
			s = t.closest(".searchInput").find(".searchInput-edit"),
			i = t.closest(".searchInput").find(".searchInput-edit input[type='text']");
			s.show();
			i.focus();
	});
	//规则删除
	$("body").on("click",".icon-skuDel",function(e){
		var t = $(this),
			c = $(this).closest(".skuList"),
			cid = parseInt(c.attr("data-newid"));
		for(var i=0;i<data.namelist.length;i++){
			if(data.namelist[i].newid == cid ){
				data.namelist = data.namelist.slice(0,i).concat(data.namelist.slice(i+1,data.namelist.length))
			}
		}
		begin(data);
	});
	//规则类别删除
	$("body").on("click",".skuRuleItem i",function(e){
		var t = $(this),
			c = $(this).closest(".skuList"),
			s = $(this).closest(".skuRuleItem"),
			cid = parseInt($(this).closest(".skuRule").attr("data-newid")),
			sid = parseInt(s.attr("data-newid"));
			for(var i=0;i<data.namelist.length;i++){
				if(data.namelist[i].newid == cid ){
					for(var j=0;j<data.namelist[i].list.length;j++){
						if(data.namelist[i].list[j].newid == sid ){
							data.namelist[i].list = data.namelist[i].list.slice(0,j).concat(data.namelist[i].list.slice(j+1,data.namelist[i].list.length))
						}
					}
				}
			}
		begin(data);
	});
	//规则类别添加
	$("body").on("click",".skuRuleAdd .skuRuleBtn",function(e){
		$(".skuRuleAdd").removeClass("edit");
		$(this).closest(".skuRuleAdd").addClass("edit");
		$(this).closest(".skuRuleAdd").find("input").focus();
	});
	//规则确定
	$("body").on("click",".searchInput-edit .icon-skuOk:not('.erro')",function(e){
		var t = $(this),
			e = t.closest(".searchInput-edit")
			s = t.closest(".searchInput").find("span"),
			i = t.closest(".input").find("input"),
			v = i.val().replace(/\s/,""),
			cid = parseInt($(this).closest(".skuList").attr("data-newid"));
		if(v!=""){
			s.text(v);
			t.addClass("erro");
			i.val("");
			e.find("dl,dd").attr("style","");
		};
		e.hide();
		for(var i=0;i<data.namelist.length;i++){
			if(data.namelist[i].newid == cid ){
				data.namelist[i].name = v
			}
		}
		cookie(v,1);
		begin(data);
	});
	//类别确定
	$("body").on("click",".skuRuleAdd .icon-skuOk:not('.erro')",function(e){
		var t = $(this),
			c = $(this).closest(".skuRuleAdd"),
			i = c.find("input"),
			v = i.val().replace(/\s/,""),
			cid = parseInt($(this).closest(".skuRule").attr("data-newid")),
			isorder = findorder();
			var pushList = {
				id:"0",
				val:v
			}
			if(!$(this).closest(".skuRuleAdd").find(".orderAddinput").validationEngine('validate')){
				for(var i=0;i<data.namelist.length;i++){
					if(data.namelist[i].newid == cid ){
						data.namelist[i].list.push(pushList)
					}
				}
			}else{
				return false;
			}
			t.addClass("erro");
			c.removeClass("edit");
			cookie(v,2);
			begin(data);
	});
	
	//类别确定
	$("body").on("click",".skuRuleAdd .icon-skuOk.erro",function(e){
		var t = $(this),
			c = $(this).closest(".skuRuleAdd");
			t.addClass("erro");
			c.removeClass("edit");
	});
	//添加规则
	$("body").on("click",".addsku",function(e){
		if(data.namelist.length>=3){
			return false;
		}else{
			var pushList = {
				id:"0",
				name:"",
				list:[]
			}
			data.namelist.push(pushList);
			begin(data);
			$(".skuList:last").find(".searchInput .icon-skuEdit").click();
			$(".skuList").each(function(index, element) {
				var z = 10-index;
				$(this).css("z-index",z);
			});
		}
	});
	$("body").on("focus","input[name='price']",function(){
		$("input[name='price']").prev(".formError").remove();
	});
});
function cookie(v,type){
	if(v){var v=v}else{var v="";};
	var cookiename = "颜色,尺寸,尺码,规格,款式,净含量,种类,内存";
	var cookielist = "";
	if(!$.cookie('shopsku')){
		$.cookie('shopsku',cookiename+"||"+cookielist, { expires: 365 });
		cookiename = $.cookie('shopsku').split("||")[0].split(",");
		cookielist = $.cookie('shopsku').split("||")[1].split(",");
		data.cookiename = cookiename;
		data.cookielist = cookielist;
	}else{
		cookiename = $.cookie('shopsku').split("||")[0];
		cookielist = $.cookie('shopsku').split("||")[1];
		if(v){
			if(type==1){
				if(cookiename.indexOf(v)<0){
					cookiename = cookiename + "," + v
				};
			}else{
				if(cookielist.indexOf(v)<0){
					if(cookielist!=""){
						cookielist = cookielist + "," + v;
					}else{
						cookielist = v;
					}
				}
			}
			$.cookie('shopsku',cookiename+"||"+cookielist, { expires: 365 });
		};
		cookiename = $.cookie('shopsku').split("||")[0].split(",");
		cookielist = $.cookie('shopsku').split("||")[1].split(",");
		data.cookiename = cookiename;
		data.cookielist = cookielist;
	};
}
function findorder(){
	var isorder = false;
	for(var i=0;i<data.namelist.length;i++){
		if(data.namelist[i].ordertype){
			if(data.namelist[i].ordertype==0){
				data.namelist[i].ordertype=false;
			}else{
				isorder = i
				break;
			}
		}
	}
	return isorder
}
function begin(data){
	var isorder = findorder();
	if(data.namelist.length!=0){
		$(".sku1").show();
		$(".sku2").hide();
		for(var i=0;i<data.namelist.length;i++){
			var namelist = data.namelist[i];
			namelist["newid"] = newid;
			newid++;
			if(namelist.list!=""){
				for(var j=0;j<namelist.list.length;j++){
					var list = namelist.list[j];
					list["newid"] = newid;
					newid++;
				}
			}
		}
		if(isorder!=false || isorder===0){
			var newdata = data.namelist;
			data.namelist = data.namelist.slice(0,isorder).concat(data.namelist.slice(isorder+1,data.namelist.length));
			data.namelist.push(newdata[isorder]);
		}
	}else{
		$(".sku1").hide();
		$(".sku2").show();
	};
	isorder = findorder();
	data["erromsg"] = "";
	for(var i=0;i<data.namelist.length;i++){
		if(data.namelist[i]){
			if(data.namelist[i].name == ""){
				data["erromsg"] = "您的第"+i+"项sku未设置，无法显示价格与库存";
				if(data.namelist[i].ordertype){
					data["erromsg"] = "您的订购周期未设置，无法显示价格与库存";
				}
				break;
			}else{
				if(data.namelist[i].list.length == 0){
					data["erromsg"] = '您的"'+data.namelist[i].name+'"未设置，无法显示价格与库存';
					if(data.namelist[i].ordertype){
						data["erromsg"] = "您的订购周期未设置，无法显示价格与库存";
					}
					break;
				}
			}
		}
	}
	var html = template("skuList",data);
	var html2 = template("skuTable",data);
	if(isorder!=false || isorder===0){
		var html3 = template("skuOrderRule",data.namelist[isorder]);
		$(".skuOrderRule").html(html3);
	}
	$(".skuForm").html(html);
	$(".skuTable").html(html2);
	$(".skuList").each(function(index, element) {
		var z = 10-index;
        $(this).css("z-index",z);
    });
	$("input[name='price']").each(function(index, element) {
		var t = $(this),
			id = t.attr("data-id");
		for(var i=0;i<data.price.length;i++){
			if(data.price[i].id.toString()==id){
				t.val(data.price[i].price);
				data.price[i]["newid"]=t.attr("data-newid");
			}
		}
    });
	$("input[name='num']").each(function(index, element) {
		var t = $(this),
			id = t.attr("data-id");
		for(var i=0;i<data.price.length;i++){
			if(data.price[i].id.toString()==id){
				t.val(data.price[i].num);
			}
		}
    });
	if(isorder!=false || isorder===0){
		$("[name='allnum']").attr("disabled",true);
		$("[name='num']").attr("disabled",true);
                $('#count_num').val('-1');
		$("#all").html("<p class='red'>开启订购功能后，商品库存全部为不限</p>");
	}else{
		var l = 0;
		var t = 0;
		for(var i=0;i<$("input[name='num']").length;i++){
			if($("input[name='num']:eq("+i+")").val()=="" || $("input[name='num']:eq("+i+")").val()=="不限" || $("input[name='num']:eq("+i+")").val()=="-1"){
				t++;
			}else{
				l += parseInt($("input[name='num']:eq("+i+")").val());
			}
		}
			if(t > 0)
				$('#count_num').val('-1');
			else
				$('#count_num').val(l);
		$("#all").text("已设置的总库存为："+l+"，不填写库存，则商品库存为不限,总共"+t+"处为不限");
	}
	if(data.namelist.length>=3){
		$(".addsku").addClass("hide");
	}else{
		$(".addsku").removeClass("hide");
	}
}
</script>

<script id="skuList" type="text/html">
{{each namelist}}
{{if !value.ordertype}}
<div class="skuList" data-id="{{value.id}}" data-newid="{{value.newid}}">
	<div class="skuListHead fn">
		<i class="icon-skuDel r"><a href="javascript:void(0)" class="a-hide">删除</a></i>
		<div class="searchInput">
			<span data-id="{{value.id}}" data-newid="{{value.newid}}">{{value.name}}</span>
			<i class="icon-skuEdit">
				<a href="javascript:void(0)" class="a-hide">修改</a>
			</i>
			<div class="searchInput-edit dn">
				<div class="input">
				<input type="text" maxlength="6">
					<i class="icon-skuOk erro">
						<a href="javascript:void(0)" class="a-hide">修改</a>
					</i>
				</div>
				<dl class="valLsit">
					{{each cookiename}}
					<dd>{{value}}</dd>
					{{/each}}
					<dd class="nodata dn">"回车"创建临时规格</dd>
				</dl>
				<div class="valLsitclose"></div>
			</div>
		</div>
	</div>
	<div class="skuCon fn">
		<div class="skuRule" data-newid="{{value.newid}}">
			{{each value.list}}
			<div class="skuRuleItem" data-id="{{value.id}}" data-newid="{{value.newid}}">{{value.val}}<i></i></div>
			{{/each}}
			<div class="skuRuleAdd">
				<div class="input">
					<input type="text" maxlength="8" class="validate[required,funcCall[checkorder]] orderAddinput">
					<i class="icon-skuOk erro">
						<a href="javascript:void(0)" class="a-hide">修改</a>
					</i>
				</div>
				<dl class="valLsit">
					{{each cookielist}}
					<dd>{{value}}</dd>
					{{/each}}
					<dd class="nodata dn">"回车"创建临时类别</dd>
				</dl>
				<div class="valLsitclose"></div>
				<div class="skuRuleBtn">
					<i></i>添加类型
				</div>
			</div>
		</div>
	</div>
</div>
{{/if}}
{{/each}}
<div class="addsku">
	<i></i>
	<span>添加规格</span>
</div>
</script>

<script id="skuRuleItem" type="text/html">
<div class="skuRuleItem">{{name}}<i></i></div>
</script>

<script id="skuTable" type="text/html">
{{if erromsg!=""}}
	<p class="erro">{{erromsg}}</p>
{{else}}
	<table cellpadding="0" cellspacing="0" class="sku-table">
		<tr>
		{{each namelist}}
			{{if value.list!=""}}<th data-id="{{value.id}}" data-newid="{{value.newid}}">{{if value.ordertype}}订购周期{{else}}{{value.name}}{{/if}}</th>{{/if}}
		{{/each}}
			<th width="123" >原价(元)</th>
			<th width="123" >商品总数</th>
		</tr>
		<tr>
			<td colspan="{{length}}" class="top">批量设置</td>
			<td class="top"><input type="text" name="allprice" /><i class="icon-skuOk skuOk-allprice erro"><a href="javascript:void(0)" class="a-hide">确定</a></i></td>
			<td class="top"><input type="text" name="allnum" placeholder="请输入数字" /><i class="icon-skuOk skuOk-allnum erro"><a href="javascript:void(0)" class="a-hide">确定</a></i></td>
		</tr>
		<tr>
		{{if namelist.length == 1}}
			{{each namelist[0].list as value j}}
			<tr>
				<td rowspan="{{length3}}" data-id="{{value.id}}" data-newid="{{value.newid}}">{{value.val}}{{if namelist[0].ordertype}}{{if namelist[0].ordertype==1}}个{{/if}}{{namelist[0].name}}{{/if}}</td>
				<td><input type="text" name="price" class="validate[required,custom[number],min[0]]" data-id="{{value.id}}"  data-newid="{{value.newid}}" /></td>
				<td><input type="text" name="num" class="validate[custom[number],max[99999]]" data-id="{{value.id}}"  data-newid="{{value.newid}}" /></td>
			</tr>
			{{/each}}
		{{/if}}
		{{if namelist.length == 2}}
			{{each namelist[0].list as value j}}
			<tr>
				<td rowspan="{{length3}}" data-id="{{value.id}}" data-newid="{{value.newid}}">{{value.val}}{{if namelist[0].ordertype}}{{if namelist[0].ordertype==1}}个{{/if}}{{namelist[0].name}}{{/if}}</td>
					{{each namelist[1].list as value1 j}}
						<td rowspan="{{length4}}" data-id="{{value1.id}}" data-newid="{{value1.newid}}">{{value1.val}}{{if namelist[1].ordertype}}{{if namelist[1].ordertype==1}}个{{/if}}{{namelist[1].name}}{{/if}}</td>
						<td><input type="text" name="price" class="validate[required,custom[number],min[0]]" data-id="{{value.id}},{{value1.id}}"  data-newid="{{value.newid}},{{value1.newid}}" /></td>
						<td><input type="text" name="num" class="validate[custom[number],max[99999]]" data-id="{{value.id}},{{value1.id}}"  data-newid="{{value.newid}},{{value1.newid}}" /></td>
						</tr>
					{{/each}}
			{{/each}}
		{{/if}}
		{{if namelist.length == 3}}
			{{each namelist[0].list as value j}}
			<tr>
				<td rowspan="{{length3}}" data-id="{{value.id}}" data-newid="{{value.newid}}">{{value.val}}{{if namelist[0].ordertype}}{{if namelist[0].ordertype==1}}个{{/if}}{{namelist[0].name}}{{/if}}</td>
					{{each namelist[1].list as value1 j}}
						<td rowspan="{{length4}}" data-id="{{value1.id}}" data-newid="{{value1.newid}}">{{value1.val}}{{if namelist[1].ordertype}}{{if namelist[1].ordertype==1}}个{{/if}}{{namelist[1].name}}{{/if}}</td>
							{{each namelist[2].list as value2 j}}
								<td data-id="{{value2.id}}" data-newid="{{value2.newid}}">{{value2.val}}{{if namelist[2].ordertype}}{{if namelist[2].ordertype==1}}个{{/if}}{{namelist[2].name}}{{/if}}</td>
								<td><input type="text" name="price" class="validate[required,custom[number],min[0]]" data-id="{{value.id}},{{value1.id}},{{value2.id}}"  data-newid="{{value.newid}},{{value1.newid}},{{value2.newid}}" /></td>
								<td><input type="text" name="num" class="validate[custom[number],max[99999]]" data-id="{{value.id}},{{value1.id}},{{value2.id}}"  data-newid="{{value.newid}},{{value1.newid}},{{value2.newid}}" /></td>
								</tr>
							{{/each}}
					{{/each}}
			{{/each}}
		{{/if}}
		<tr>
			<td colspan="{{length2}}" id="all">{{allnum}}</span></td>
		</tr>
	</table>
{{/if}}
</script>

<script id="skuOrderRule" type="text/html">
<div class="skuRule" data-newid="{{newid}}">
	{{each list as value i}}
	<div class="skuRuleItem" data-id="{{value.id}}" data-newid="{{value.newid}}">{{value.val}}{{if ordertype==1}}个{{/if}}{{name}}<i></i></div>
	{{/each}}
	<div class="skuRuleAdd">
		<div class="input">
			<input type="text" maxlength="3" class="validate[required,custom[integer],min[1],funcCall[checkorder]] orderAddinput">
			<i class="icon-skuOk erro">
				<a href="javascript:void(0)" class="a-hide">修改</a>
			</i>
		</div>
		<div class="skuRuleBtn">
			<i></i>添加订购周期
		</div>
	</div>
</div>
</script>