<script id="groundAdd" type="text/html" class="dn">
    <form id="theform" action="{:U('createRoomSubmit')}" method="post">
        <input type="hidden" name="id" value="{{id}}"/>
        <div class="Gform new" style=" width:450px;">
            <ul>
                <li class="Gnmae"> 炮区口号：</li>
                <li class="Ginput">
                    <input type="text" maxlength="30" name="community_title" value="{{community_title}}"/><span class="maxTips forInput" data-max="30">{{community_title?community_title.length:0}}/30</span>
                </li>
            </ul>
            <ul>
                <li class="Gnmae">* 参炮截止日期：</li>
                <li class="Ginput">
                    <div class="Gtime1 fn">
                        <input type="text" class="validate[required]" onclick="WdatePicker()"  name="enroll_end_time" value="{{enroll_end_time}}">
                        <em></em>
                    </div>
                </li>
            </ul>
            <ul>
                <li class="Gnmae">* 比赛截止日期：</li>
                <li class="Ginput">
                    <div class="Gtime1 fn">
                        <input type="text" class="validate[required]" onclick="WdatePicker()"  name="match_end_time" value="{{match_end_time}}">
                        <em></em>
                    </div>
                </li>
            </ul>
            <ul>
                <li class="Gnmae"> 炮区图片：</li>
                <li class="Ginput">
                    <div class="switch {{if community_pic_flag }}hover{{/if}}">
                        <input type="radio" value="{{community_pic_flag}}" checked="checked" name="community_pic_flag">
                        <div class="newRadio">
                            <span class="valfirst {{if !community_pic_flag }}hover{{/if}}" data-val="0">否</span>
                            <span class="vallast {{if community_pic_flag }}hover{{/if}}" data-val="1">是</span>
                        </div>
                        <div class="newRadio-input">
                            <div class="Gchoose"><input type="text" class="validate[required,funcCall[checkswitch]]" name="community_pic" value="{{community_pic}}">
                                <img src="{{community_pic_url}}"/><a href="javascript:void(0)" class="Gbtn-pic" title="选择图片"><i></i></a></div>
                        </div>
                    </div>
                </li>
            </ul>
            <ul>
                <li class="Gnmae"> 限制炮友：</li>
                <li class="Ginput">
                    <div class="switch {{if friend_limit_flag }}hover{{/if}}">
                        <input type="radio" value="{{friend_limit_flag}}" checked="checked" name="friend_limit_flag">
                        <div class="newRadio">
                            <span class="valfirst {{if !friend_limit_flag}}hover{{/if}}" data-val="0">否</span>
                            <span class="vallast {{if friend_limit_flag}}hover{{/if}}" data-val="1">是</span>
                        </div>
                        <div class="newRadio-input">
                            <input type="text" class="validate[required,funcCall[checkswitch]]" name="friend_limit" value="{{friend_limit}}"><span class="maxTips forInput">名</span>
                        </div>
                    </div>
                </li>
            </ul>
            <ul>
                <li class="Gnmae"> 设置奖励规则：</li>
                <li class="Ginput">
                    <div class="switch {{if award_flag }}hover{{/if}}">
                        <input type="radio" value="{{award_flag}}" checked="checked" name="award_flag">
                        <div class="newRadio">
                            <span class="valfirst {{if !award_flag }}hover{{/if}}" data-val="0">否</span>
                            <span class="vallast {{if award_flag }}hover{{/if}}" data-val="1">是</span>
                        </div>
                        <div class="newRadio-input mt10">
                            <textarea name="award_content" id="wap_info{{ueNum}}">{{award_content}}</textarea>
                        </div>
                    </div>
                    <span class="txtTips">您可以在此处设置炮区规则,如:第一名可获得精美奖品一份</span>
                </li>
            </ul>
            <ul>
                <li class="Gnmae"> 设置暗号：</li>
                <li class="Ginput">
                    <div class="switch {{if secret_flag }}hover{{/if}}">
                        <input type="radio" value="{{secret_flag}}" checked="checked" name="secret_flag">
                        <div class="newRadio">
                            <span class="valfirst {{if !secret_flag }}hover{{/if}}" data-val="0">否</span>
                            <span class="vallast {{if secret_flag }}hover{{/if}}" data-val="1">是</span>
                        </div>
                        <div class="newRadio-input dn">
                            <div class="Gtime1 fn special">
                                <em class="em1" style=" width:40px;">问:</em>
                                <input type="text" class="validate[required,funcCall[checkswitch]]" style=" padding-left:40px; padding-right:8px;" name="secret_question" value="{{secret_question}}">
                            </div>
                            <div class="Gtime1 fn special mt10">
                                <em class="em1" style=" width:40px;">答:</em>
                                <input type="text" class="validate[required,funcCall[checkswitch]]" style=" padding-left:40px; padding-right:8px;" name="secret_answer" value="{{secret_answer}}">
                            </div>
                        </div>
                    </div>
                    <span class="txtTips">通过暗号设置,您可以指定企业加入炮区</span>
                </li>
            </ul>
            <ul>
                <li class="Gnmae"></li>
                <li class="Ginput">
                    <a href="javascript:void(0)" class="btn-all w110 js-submit">确认</a>
                </li>
            </ul>
        </div>
    </form>
</script>
<textarea id="groundJoin" type="text/html" class="dn">
    <form id="theform" action="{:U('joinRoomSubmit')}" method="post">
        <input type="hidden" name="community_id" value="{{id}}"/>
        <div class="Gform" style=" width:450px;">
            {{if +secret_flag==1 }}
            <ul>
                <li class="Gnmae">* 炮区暗号：</li>
                <li class="Ginput">
                    <span class="txtTips" style="font-size:14px; color:#333;">{{secret_question}}</span>
                    <div class="Gtime1 fn special mt10">
                        <em class="em1" style=" width:40px;">答:</em>
                        <input type="text" class="validate[required]" style=" padding-left:40px; width:197px;" name="secret_answer"/>
                    </div>
                </li>
            </ul>
            {{/if}}
            <ul>
                <li class="Gnmae">* 联系人姓名：</li>
                <li class="Ginput">
                    <input type="text" class="validate[required]" name="contact_name" maxlength="20">
                </li>
            </ul>
            <ul>
                <li class="Gnmae">* 联系人手机：</li>
                <li class="Ginput">
                    <input type="text" class="validate[required,custom[phone]]"  name="contact_mobile" maxlength="11"/>
                </li>
            </ul>
            <ul>
                <li class="Gnmae"></li>
                <li class="Ginput">
                    <a href="javascript:void(0)" class="btn-all w110 js-submit">确认加入</a>
                </li>
            </ul>
        </div>
    </form>
</textarea>
<textarea id="groundRule" type="text/html" class="dn">
    <div id="rule">
        <p><span>1.炮区</span>：炮区即赛区，企业PK的地方;</p>
        <p><span>2.炮主</span>：炮区的创建者即炮主，比如翼码旺财创建了一炮区，那么翼码旺财就是一炮区炮主;</p>
        <p><span>3.炮友</span>：炮区里的参赛企业即炮友，比如A企业加入了一炮区，那么A企业就是一炮区的一名炮友;</p>
        <p><span>4.比赛规则</span>：在炮主指定的比赛截止日期对该炮区炮友开展的【打炮总动员】活动发放金币数量进行统计并产生排名;</p>
        <p><span>5.炮区建立规则</span>：旺财平台注册客户均可建立自己的炮区（仅限建立1个炮区）;</p>
        <p><span>6.参赛规则</span>：在加入任一炮区前，需创建【打炮总动员】活动后，才能加入某个炮区成为炮友，最多可加入3个不同炮区，加入后不可退出;</p>
        <p><span>7.禁止行为</span>：本着“友谊第一，比赛第二”的群P精神，所有炮友都应采用合法姿势打炮（禁止刷分）!</p>
    </div>
</textarea>
<textarea id="groundMore" type="text/html" class="dn">
    <div class="grounds-more">
        <div class="grounds-top">
            <h1>炮主:&nbsp;{{node_name}}</h1>
            <div class="pic"><p><a><span>
                {{if community_pic_flag}}
                <img src="{{community_pic_url}}">
                {{else}}
                <img src="__PUBLIC__/Image/edm/20150126-16.png"/>
                {{/if}}
            </span></a></p></div>
            <div class="txt">
                <div class="txt-slogan">{{community_title}}</div>
                <p>炮友:&nbsp;{{friend_count}}名/{{if +friend_limit!=0}} {{friend_limit}}名 {{else}}不限{{/if}}</p>
                <p>战绩:&nbsp;{{score}}</p>
                <p>参炮截止日期:&nbsp;{{enroll_end_time}}</p>
                <p>比赛截止日期:&nbsp;{{match_end_time}}</p>
            </div>
        </div>
        {{if award_flag }}
        <div class="cut">奖励规则</div>
        <div class="grounds-con">
            {{#award_content}}
        </div>
        {{/if}}
    </div>
</textarea>
<script>
    /*
     * 上传文件后回调函数
     * */
    window.uploadCallback = function(){
        alert('error');
    };
    /*
     * 打开上传文件控件
     * */
    function openUploader(obj) {
        //定义回调函数
        window.uploadCallback = function(res){
            $(obj).closest('div').find('img').get(0).src = res.info.imgUrl;
            $(obj).closest('div').find('input').get(0).value = res.info.imgName;
        }
        var win_width = 700;
        var url = "{:U('ImgResize/Meitu/index')}&";
        var opt = [
            ,"uploadUrl={:urlencode(U('uploadImg','','','',true))}"
            ,"cropPresets=320x320"
            ,"callback=uploadCallback"
            ,"menuType=1"
        ].join('&');
        url+=opt;
        art.dialog.open(url, {
            lock: true,
            title: "上传图片",
            width: win_width,
            height: win_width / 1.6,
            id: 'art_upload'
        });
    }

    var ueNum = 1 ;
    $(document).ready(function(e) {
        Gform();
        //创建
        $("body").on("click",".js-submit",function(){
            $(this).closest("form").validationEngine().submit();
        })

        //上传图片
        $("body").unbind("click",".Gbtn-pic").on("click",".Gbtn-pic",function(e){
            openUploader(e.target);
        });


        $("body").on("click",".ground-add",function(){

            var _this = $(this),url = _this.data('url');

            var data = {
                "ueNum":ueNum
            };
            var _openWin = function(data,opt){
                var html = template("groundAdd", data);
                art.dialog({
                    title: opt.title,
                    content:html,
                    lock:true,
                    width:'500px',
                    height:'440px',
                    zIndex:900,
                    padding:"0 0 20px 0"
                });
                setTimeout(function(){
                    var ue = UE.getEditor('wap_info'+ueNum,{
                        imageUrl:"{:U('LabelAdmin/Upfile/editoImageSave')}",
                        imagePath:"__UPLOAD__/",//上传文件基本目录
                        catcherUrl:"{:U('LabelAdmin/Upfile/getRemoteImage')}",
                        catcherPath:"__UPLOAD__/",
                        initialFrameWidth:320,
                        initialFrameHeight:200
                    });
                    ueNum++
                },200);
            };
            if(!url){
                _openWin(data,{title:'新建炮区'});
                return;
            }
            //编辑
            var loading = art.dialog({id:'loading','content':'载入中...',title:false});
            $.get(url,function(res){
                loading.close();
                var info = res.info;
                data = $.extend(data,info,{
                    community_pic_flag:+info.community_pic_flag?1:0,
                    friend_limit_flag:+info.friend_limit>1?1:0,
                    secret_flag:+info.secret_flag?1:0,
                    award_flag:+info.award_flag?1:0
                });
                _openWin(data,{title:'编辑炮区'});
            },'json')
                    .fail(function(){
                        loading.close();
                        alert("系统正忙...");
                    })
            ;
        });

        $("body").on("click",".ground-rule",function(){
            var data = [];
            var html = template("groundRule", data);
            art.dialog({
                title: '群P公约',
                lock:true,
                content:html,
                width:'500px',
                zIndex:900
            });
        });
        $("body").on("click",".ground-join",function(e){
            var _this = $(e.target),data = _this.closest('div').find(".js-data").val();
            data = $.parseJSON(data) || {};
            var html = template("groundJoin", data);
            art.dialog({
                title: '加入炮区',
                lock:true,
                content:html,
                width:'500px',
                zIndex:900,
                padding:"0 0 20px 0"
            });
        });

    });
    function checkswitch(field, rules, i, options){
        if($(this).closest(".switch").find(">[type='radio']").val()!=0){
            return false;
        };
    }

</script>