<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>抽奖设置_营销活动_翼码旺财</title>
<link href="__PUBLIC__/Css/main.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/layout.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/module.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wprize.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wnumgoods.css?v=__VR__" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="__PUBLIC__/Js/jquery-1.7.1.min.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/global.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default"></script>
<script type="text/javascript" src="__PUBLIC_LOCAL__/Js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery-ui-1.11.2.custom/template.js?v=__VR__"></script>
<style>
	.Gform .Gnmae{width:160px;}
	.Gform .Ginput{padding:12px 0 0 160px;}
	.rule-detail{display:none;width:430px;margin-bottom:15px;padding:8px;border:1px solid #ccc;}
	.Gform .Ginput .Gtime1 input[type=text]{width:140px;}

    a.btn-up{  display: inline-block;  padding: 4px 15px;  border: solid 1px #ffd0d3;  background: #fff2f3; border-radius:2px;  color: #f15755; text-decoration:none cursor:pointer}
    a.btn-up:hover { background:#ffd0d3; text-decoration:none}

    .sweet_tips {  padding-left: 15px;  margin-left: auto;  margin-right: auto;  border: 1px solid #f2e6ce;  background-color: #fffbf2;  color: #f0ab68;  font-size: 14px;  padding: 4px 15px;  margin-bottom: 10px; border-radius:2px;}
</style>
<script type="text/javascript">
window._g = window._g || {};
_g.batch_id = '<?php echo $batch_id;?>';
$(function(){
	var initobj = $(".EditGprize-conItemList");
	$(initobj).each(function(index, element) {
		var _thisVal = $(this);
		var initStatus = _thisVal.hasClass("erro");
		//alert(initStatus);
		if(initStatus){
			_thisVal.find(".icon-prizeRollback").removeClass("dn");
		}
	})
})
</script>
</head>
<body>
	<div id="wrapper">
		<div id="container">
			<div id="main">
				<div class="bread">
                    <div class="bread-con fn">
                    	<include file="./Home/Tpl/LabelAdmin/Path_index.html" />
                        <div class="bread-history" style="display: block;">
                            <i class="icon-history"></i>
                            <p><a href="javascript:void(0)" class="ind-bread">返回</a></p>
                        </div>
                    </div>
              	</div>
				<div class="global-input2 Gform fn pb30 w7" style="width:700px;" data-url="{:U('cjsetSubmit')}">
					<input type="hidden" name="batch_id" value="{$batch_id}"/>
                    <p class="newsadd-title">活动规则</p>
					<ul>
						<li class="Gnmae">*&nbsp;每日比赛场次：</li>
						<li class="Ginput">
							<select name="game-time" id="game-time" >
								<option value="0">请选择</option>
                                {:show_arr_opt(array(
                                    '1'=>'1',
                                    '2'=>'2',
                                    '3'=>'3',
                                    '4'=>'4',
                                ),strval($rule_num))}
							</select>
						</li>
					</ul>
					<ul>
						<li class="Gnmae">&nbsp;</li>
						<li class="Ginput fn">
                            <for start="1" end="4" comparison="elt">
                                <php>
                                    if(isset($rule_detail[$i-1])){
                                        $vo = $rule_detail[$i-1];
                                    }
                                    else{
                                        $vo = array(
                                            'batch_number'=>'',
                                            'rule_begin_time'=>date('H:i'),
                                            'rule_end_time'=>'',
                                            'game_time'=>'60',
                                        );
                                    }
                                </php>
                                <div class="rule-detail">
                                    <p class="pb10">第{$i}场时间</p>
                                    <input type="hidden" name="batch_number" value="{$vo.batch_number}">
                                    <div class="fn">
                                        <div class='Gtime1 fn l'>
                                            <input name='rule_begin_time' id='rule_begin_time_{$i}' type='text' onClick="WdatePicker({ dateFmt:'HH:mm'})" class="textbox" value="{$vo.rule_begin_time}"/>
                                            <em></em>
                                        </div>
                                        <div class="Gtime2 noIcon">
                                            <em style="border-left:0">至</em>
                                        </div>
                                        <div class="Gtime1 fn l">
                                            <input name="rule_end_time" id="rule_end_time_{$i}" type="text" onClick="WdatePicker({ dateFmt:'HH:mm'})" class="textbox" value="{$vo.rule_end_time}"/>
                                            <em></em>
                                        </div>
                                    </div>
                                    <p class="mt10">摇一摇计时时间:<span class="ml5 mr5"><input type="text" style="width:50px;" name="game_time" value="{$vo.game_time}"/></span>秒</p>
                                </div>
                            </for>

						</li>
					</ul>

					<ul class="Gtitle">奖品设置</ul>
                    <ul id="cj_style">
                    <li class="global-input2-name">绑定抽奖：</li>
                    <li class="global-input2-input">
                        <div class="Gprize">
                            <div class="AddGprize icon-prizeAdd" data-rel="0" onclick="editcate('<?php echo $batch_id;?>','')">
                                <i></i>
                                <span>添加奖项</span>
                            </div>
                            <?php if($cj_cate_arr){foreach($cj_cate_arr as $cate_arr){?>
                            <div class="EditGprize IngGprize" data-rel="+datarel+" >
                                <div class="EditGprize-head">
                                    <i class="icon-prizeDel r"><a href="javascript:void(0)" class="a-hide btn-DelEditGprize" onclick="delCate('<?php echo $batch_id;?>','<?php echo $cate_arr['id'];?>')">删除</a></i>
                                    <p class="GprizeName"><span><?php echo $cate_arr['name'];?> 第：&nbsp;<?php echo $cate_arr['min_rank'];?> 名 - 第 <?php echo $cate_arr['max_rank'];?> 名</span><i class="icon-prizeEdit dib vm"><a href="javascript:void(0)" class="a-hide btn-ChangeEditGprize" onclick="editcate('<?php echo $batch_id;?>','<?php echo $cate_arr['id'];?>')">修改</a></i><?php if($cate_arr['member_batch_id']){?><i class="icon-prizeMember dib vm"></i><span class="GprizeName-tip">会员专享</span><?php }	?></p>
                                </div>
                                <div class="EditGprize-add">
                                    <div class="fn"><a href="javascript:void(0)" class="btn-EditGprizeAdd" onclick="editjp('<?php echo $batch_id;?>','<?php echo $cate_arr['id'];?>','')">添加奖品</a></div>
                                </div>
                                <div class="EditGprize-con">
                                    <?php
                                    	if($jp_arr){foreach($jp_arr as $jparr){
                                    	if($cate_arr['id']!=$jparr['cj_cate_id'])
                                    		continue;
                                    	?>
                                    <div class="EditGprize-conItem fn">
                                        <div class="EditGprize-conItemList <?php echo $jparr['status']=='2' ? 'erro' :'';    ?> fn">
                                            <div class="EditGprize-con-name"><?php echo $jparr['batch_name'];?></div>
                                            <div class="EditGprize-con-all"><eq name="jparr['online_verify_flag']" value="1">可线上提领<else />&nbsp;</eq></div>
                                            <div class="EditGprize-con-day">共<?php echo $jparr['total_count'];?>份</div>
                                            <div class="EditGprize-con-all">&nbsp;</div>
                                            <div class="EditGprize-con-edit">
                                            	<i class="icon-prizeRollback dn"><a href="javascript:void(0)" class="a-hide btn-EditGprizeAdd-rollback" onclick="prize_back('<?php echo $jparr['id'];?>')">回退到库存</a></i>
                                                <i class="icon-prizeEdit2 "><a href="javascript:void(0)" class="a-hide btn-EditGprizeAdd-edit" onclick="editjp('<?php echo $batch_id;?>','<?php echo $cate_arr['id'];?>','<?php echo $jparr['id']?>')">修改</a></i>
                                                <i class="icon-prizeDel2 "><a href="javascript:void(0)" class="a-hide btn-EditGprizeAdd-del" onclick="jpStatus('<?php echo $batch_id;?>','<?php echo $jparr['id'];?>','<?php echo $jparr['status']=='1' ? '1' :'2';    ?>')">停用</a></i>
                                            </div>
                                        </div>
                                    </div>
                                    <?php }}?>
                                </div>
                            </div>

                            <?php }}?>
                        </div>
                    </li>
                    </ul>
                    <p class="newsadd-title">参与店铺</p>
                    <ul>
						<li class="Gnmae">开启地理位置匹配功能：</li>
						<li class="Ginput">
							<div class="switch {:$location_flag?'hover':''}">
                                <input type="radio" name="location_flag" value="{$location_flag}" checked>
                                <div class="newRadio">
                                    <span class="valfirst {:$location_flag?'':'hover'}" data-val="0">否</span>
                                    <span class="vallast {:$location_flag?'hover':''}" data-val="1">是</span>
                                </div>
                            </div>
						</li>
					</ul>
                    <if condition="true">
                        <ul>
                            <li class="Gnmae">*&nbsp;可验证门店：</li>
                            <li class="Ginput">
                                <div class="switch {:$store_flag?'hover':''}">
                                    <input type="radio" name="store_flag" id="store_flag" value="{$store_flag}" checked="checked" />
                                    <div class="newRadio">
                                        <span class="valfirst {:$store_flag?'':'hover'}" data-val="0">所有门店可用</span>
                                        <span class="vallast {:$store_flag?'hover':''}" data-val="1">自己选择可用门店</span>
                                    </div>
                                    <div class="newRadio-input" style="float:none; clear:both; padding-top:10px;">
                                        <a href="javascript:void(0);" class="btn-up fl" name="choose_shop">选择门店</a>
                                        <input type="hidden" id="shop_idstr" name="shop_idstr" value="{$store_list}"/>
                                        <div class="sweet_tips ml10" style="display:inline-block">您已选择<span id="shop_number">{$store_num}</span>家门店</div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <else/>
                        <ul>
                        <li class="Gnmae">*&nbsp;可验证门店：</li>
                        <li class="Ginput">
                            <div class="switch {:$store_flag?'hover':''}">
                                <input type="radio" name="store_flag" id="store_flag" value="{$store_flag}" checked="checked" />
                                <div class="newRadio">
                                    <span class="valfirst {:$store_flag?'':'hover'}" data-val="0">所有子门店可用</span>
                                    <span class="vallast {:$store_flag?'hover':''}" data-val="1">自己选择可用门店</span>
                                </div>
                                <div class="newRadio-input mt10" style="width:100%;">
                                    <div class="switch auto">
                                        <div id="chooseShop" class="fn">
                                            <div class="numgoodsList newRadio" id="shop_content">
                                                <volist name="store_list" id="vo">
                                                    <div class="numgoodsList-item">
                                                        <i class="icon-del"></i><input type="hidden" name="shop_id[]" value="{$vo.store_id}">
                                                        {$vo.store_short_name}
                                                    </div>
                                                </volist>
                                            </div>
                                            <div class="mt5"><a href="javascript:void(0);" title="选择门店" name="choose_shop" class="btn-all w90 ml10">选择门店</a></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                    </if>

                    <ul class="mt20">
                        <li class="Gnmae">&nbsp;</li>
                        <li class="Ginput">
                            <a href="javascript:void(0);" class="btn-all-del w110">上一步</a>
                            <a href="javascript:void(0);" class="btn-all ml10 w110 js-submit">下一步</a>
                        </li>
                    </ul>
				</div>

                <div class="prizeIntroduce" style="padding: 20px;">
                    <div class="lotteryPrizeCon prizeIntroduceCon">
                        <div class="prizeIntroduceList">
                            <h4 style="color: #8F4106">活动规则说明：</h4>
                            <p>1.每日最多举办4场活动，活动时间不能重复</p>
                            <p>2.活动会自动统计参与本场活动摇一摇成绩的排名，每位参与者只记录最高成绩</p>
                            <p>3.单场比赛结束后，系统会自动将获奖者奖励以短彩信的形式发送到获奖者手机。</p>
                            <p>4.如开启地理位置功能，则需要参与者到店参与，地理位置根据配置的店铺LBS来结合参与者手机GPRS来匹配。为了确保到店用户在信号不好的情况下也能参与，会有2公里的容错处理。</p>
                            <p>5.开启地理位置后可选择参与的门店，确保门店LBS位置信息正确。</p>
                            <br/>
                            <h4 style="color: #8F4106">奖项配置说明：</h4>
                            <p>1.每个奖项可选择多种奖品。</p>
                            <p>2.可在每个奖项中设置可获得奖品的名次区间。</p>
                        </div>

                    </div>

                </div>
			</div>
		</div>
	</div>
</body>
</html>
<script type="text/html" id="rollbackResult">
<div class='loadTip'>
    <div class='loadStatus ok'>
    <dl>
    <dt>奖品回退成功！</dt>
    <dd>您已成功回退<span class='redfont'>{{backNum}}</span>份奖品！</dd>
    </dl>
    </div>
</div>
</script>
<script>
	$(document).ready(function(){
		$('#game-time').change(function(){
			var counts = $(this).val();
			var part = $('.rule-detail');
			part.hide();
			for(var i=0;i<counts;i++){
				(function(i){
					part.eq(i).show();
				})(i)
			}
		}).change();

        //门店选择
        $("a[name='choose_shop']").click(function(){
            var type = '&type=0';
            if($(this).attr("name") == "choose_shop"){
                type = "&type=1";
            }
            art.dialog.open("{:U('WangcaiPc/NumGoods/shopList')}"+type,{
                lock: true,
                title:"选择门店",
                width:800,
                height:'80%'
            });
        });
        $(".icon-del").live('click',function(){
            $(this).closest(".numgoodsList-item").detach();
        });

        //提交表单
        $(".js-submit").click(function(){
            //收集每日场次信息
            var $_form = $(".Gform"),
                    store_flag = $_form.find("input[name='store_flag']").val()*1;
            debugger;
            var getDetail = function(){
                var part = $('.rule-detail:visible');
                var arr = [];
                part.each(function(){
                    var _this = $(this),obj;
                    obj = {
                        'rule_begin_time':_this.find("input[name='rule_begin_time']").val(),
                        'rule_end_time':_this.find("input[name='rule_end_time']").val(),
                        'game_time':_this.find("input[name='game_time']").val()
                    };
                    if(!obj.rule_begin_time || !obj.rule_end_time){
                        alert("场次开始或者结束时间不能为空");
                        return false;
                    }
                    arr = arr.concat(obj);
                });
                return arr;
            };
            //获取门店列表
            var getStoreList = function(){
                if(!store_flag){
                    return '';
                }
                /*var $shopList = $("input[name='shop_id[]']");
                var arr = [];
                $shopList.each(function(){
                    arr  = arr.concat($(this).val());
                });*/
                var arr = $("#shop_idstr").val();
                return arr;
            };
            if(!confirm("确定要操作？")){
                return false;
            }
            //收集其它信息
            var data = {
                batch_id:$_form.find("input[name='batch_id']").val(),
                rule_detail:getDetail(),
                location_flag:$_form.find("input[name='location_flag']").val(),
                store_flag:store_flag,
                store_list:getStoreList()
            };
            var url = $_form.data('url');
            var loading = art.dialog({title:false,content:'loading',lock:true});
            $.post(url,data,function(res){
                loading.close();
                if(!res.status){
                    art.dialog({
                        content:res.info,
                        lock:true
                    });
                }
                else{
                    art.dialog({
                        content:"编辑成功",
                        ok:function(){
                            window.location.href = "{:U('MarketActive/Activity/MarketList')}";
                        },
                        lock:true
                    });
                }
            },'json');
        });
	});


    //添加编辑奖品类型
    function editcate(batch_id,cj_cate_id){
        var prizetype = parseInt($("input[name='cj_phone_type']:checked").val());
        if(prizetype>=2){
            var prizelength = $(".EditGprize").length;
            if(prizelength>=7){
                art.dialog({
                    content: '特殊抽奖最多只能设置7个奖项',
                    ok: function () {
                        this.close();
                        return false;
                    }
                });
                return false;
            }
        }
        var title = cj_cate_id!='' ? '编辑奖项' :'添加奖项';
        art.dialog.open("{:U('jpType','batch_id=')}"+batch_id+"&cj_cate_id="+cj_cate_id,{
            width:500,
            height:230,
            title:title,
            lock: true
        });
    }

    //添加编辑奖品
    function editjp(batch_id,cj_cate_id,cj_batch_id){
        var title = cj_batch_id!='' ? '编辑奖品' :'添加奖品';
        art.dialog.open("{:U('CjSet/selectJp','batch_id=')}"+batch_id+"&cj_cate_id="+cj_cate_id+"&cj_batch_id="+cj_batch_id,{
            width:800,
            title:title
        });
    }


    //删除奖项
    function delCate(batch_id,cj_cate_id){

        art.dialog({
            title:"确认",
            content:'您确定要删除该奖项吗？',
            fixed: true,
            lock:true,
            okVal: '确认',
            ok: function () {
                var data = {
                    cj_cate_id : cj_cate_id,
                    batch_id : batch_id
                }
                $.post("{:U('Common/SelectJp/jpCateDel')}", data, function(resp){
                    art.dialog({width:"200px",title:"提示",lock:true,content:resp.info,
                        okVal: '确认',
                        ok: function () {
                            if(resp.status=='1'){
                                window.location.reload();
                            }
                        }
                    });

                }, 'json');
            },
            cancel: true
        });
    }


    //奖品停用
    function jpStatus(batch_id,cj_batch_id,type){
        var jpsetUrl = "";
        var content = "";
        if(type == '1'){
            content ="您确定要停用该奖品吗？";
            jpsetUrl ="{:U('Common/SelectJp/jpStop')}";
        }else{
            content ="您确定要启用该奖品吗？";
            jpsetUrl ="{:U('Common/SelectJp/jpStart')}";
        }

        art.dialog({
            title:"确认",
            content:content,
            fixed: true,
            lock:true,
            okVal: '确认',
            ok: function () {
                var data = {
                    cj_batch_id : cj_batch_id,
                    batch_id : batch_id
                }
                $.post(jpsetUrl, data, function(resp){
                    art.dialog({width:"200px",title:"提示",lock:true,content:resp.info,
                        okVal: '确认',
                        ok: function () {
                            if(resp.status=='1'){
                                window.location.reload();
                            }
                        }
                    });

                }, 'json');
            },
            cancel: true
        });
    }
	
	function prize_back(p_id){
        art.dialog.confirm("您确定要将该卡券回退到库存？", function(){
            var m_id = _g.batch_id;
            $.post("{:U('LabelAdmin/CjSet/prizeBack')}",{"m_id":m_id,"p_id":p_id}, function(data) {
                if (data.status == 1) {
                    var data={"backNum":data.info};
                    var html = template("rollbackResult",data);
                    art.dialog({
                        title: '卡券回退',
                        width:"400px",
                        content:html,
                        cancel:function(){
                            //art.dialog.list['PrizeBack'].close();
                            var win = art.dialog.open.origin;
                            win.location.reload();
                        },
                        cancelVal:"关闭"
                    })
                }else{
                	Diaerror(data.info);
                }
            }, 'json');
        })
    }


</script>