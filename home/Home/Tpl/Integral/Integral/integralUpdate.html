<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>手动增减{:L('INTEGRAL_NAME')}</title>
<link href="__PUBLIC__/Css/easyui.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/main.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/layout.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/module.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wcanal.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wshop.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Whygl.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="__PUBLIC__/Js/jquery-1.8.2.min.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/Wcanal.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/global.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery.form.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC_LOCAL__/Js/My97DatePicker/WdatePicker.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/validationEngine/languages/jquery.validationEngine-zh_CN.js?v=__VR__" ></script>
<script type="text/javascript" src="__PUBLIC__/Js/validationEngine/jquery.validationEngine.js?v=__VR__" ></script>
<script type="text/javascript" src="__PUBLIC__/Js/citycode.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery.easyui.min.js"></script>
<style type="text/css">
	.leftCon { position: absolute; width: 218px; bottom: -240px; margin-top: 25px; border: 1px #ececec solid;}
	.leftCon { position: absolute; width:212px; bottom: -240px; margin-top: 25px; border: 1px #ececec solid; font-size:14px;}
	.leftCon-title { padding: 0 15px; line-height: 30px; color: #333333; font-weight: bold; background: #f8f8f8;}
	.leftCon ul { padding: 10px 15px;}
	.leftCon ul li a { line-height: 24px; color: #666666;}
	.leftCon ul li i { display: none; width: 4px; height: 4px; background: #666666; vertical-align: middle; margin-right: 5px; border-radius: 50%;}
	.leftCon div.fn { padding: 0 15px 15px 15px;}
	.SearchAreaLeft { width: 807px; padding: 0 0 13px 0; margin-bottom: 15px;}
	.SearchAreaLeft:last-child { border-left: 0px dashed #999999;}
	.SearchAreaLeft label { position: relative; font-size: 14px; margin-right: 10px;}
	/*.SearchAreaLeft-inner { padding: 0 0 0 20px;}
	.SearchAreaLeft-inner.active { border-left: 1px dashed #999999;}*/
	.SearchAreaLabel { display: none; float: left; font-size: 14px; margin: 0px 10px 0 0; font-weight: bold;}
	.searchBtn { right: 65px;}
	.SearchAreaLeft .addMark {
		display: inline-block;
		float: none;
		width: 65px;
	    min-width: 65px;
	    padding: 0;
	    height: 26px;
	    line-height: 26px;
	    border: solid 1px #757982;
	    background: #757982;
	    color: #fff;
	    border-radius: 2px;
	    margin: 0;
	    font-size: 14px;
	    text-align: center;
    }
    .SearchAreaLeft .addMark:hover {
	    background-color: #999ca3;
	    color: #fff;
	    text-decoration: none;
	}
	.choose { padding: 10px 15px; font-size: 14px;}
	.choose input[type="checkbox"] { margin-right: 10px; vertical-align: middle;}
	
	.SearchArea.extendMode { overflow: visible;}
	.SearchAreaLeft label.active { margin-bottom: 0; padding: 5px 0;}
	.combo.active { height: 26px; vertical-align: middle; padding: 0 6px;}
	.combo.active .textbox-text,.combo.active .textbox-text:focus,.combo.active .textbox-text:hover { border: none; box-shadow: none;}
	.combo.active .textbox-text { width: 74px; padding: 0;}
	.combo.active .textbox-addon { padding-right: 0;}
	.combo.active .combo-arrow { width: 28px; height: 26px; background: url(__PUBLIC__/Image/moreArrow.png) center center no-repeat; background-color: none;}
	.mark-box { display: inline-block; vertical-align: middle;}
	.mb1 {
	    padding: 0 34px 0 10px;
	    margin: 0 20px 0 0;
	    height: 24px;
	    line-height: 24px;
	    text-align: center;
	    font-size: 15px;
	}
	.mb1 { margin: 0 10px 10px 0; vertical-align: top; display: inline-block; float: none; height: 26px; line-height: 26px; border-width: 1px; color: #ed3f41;}
	.mb1:hover { margin-right: 10px; display: inline-block; float: none; border-width: 1px;}
	.mb1 i { width: 26px; height: 26px; color: #ed3f41; font-style: normal; display: block; position: absolute;right: 0;bottom: 0;}
	.mb1:hover i { width: 26px; height: 26px; line-height: 26px; background: none; color: #ffffff; background-color: #ed3f41;}
	.choose { padding:10px 0 10px 15px; font-size: 14px;}
	.choose input[type="checkbox"] { margin-right: 10px; vertical-align: middle;}
	.select{float: right; font-size: 14px;}
	.select select{margin: 0 10px;}
</style>
<script>
$(function() {
	$(".more-filter").click(function(){
		$(".SearchAreaLeft label").toggleClass("active");
	});
	
    Gform();
    //添加标签弹窗
    //导入数据弹窗
    $(".btn-add").click(function (e) {
        art.dialog.open("{:U('uploadMembers')}", {
            id: "EnterpriseNo",
            title: "导入数据",
            lock: true,
            width: "750px",
            height: "350px"
        });
    });

    //导出数据弹窗
    $(".btn-down").click(function (e) {
        art.dialog.open("{:U('downloadMember')}", {
            id: "EnterpriseNo",
            title: "导出数据",
            lock: true,
            width: "750px",
            height: "380px"
        });
    });

    //会员详情弹窗
    $(".member-info a").click(function (e) {
        var m_id = $(this).attr("data-id");
        art.dialog.open("{:U('detail')}&m_id=" + m_id, {
            id: "EnterpriseNo",
            title: "会员详情",
            lock: true,
            width: "800px",
            height: "650px"
        });
    });
})
    function integralUpdate(id,type){
        art.dialog.open("{:U('Integral/integralPointSet')}"+"&id="+id+"&type="+type,{
            id:"EnterpriseNo",
            title:"{:L('INTEGRAL_NAME')}增减",
            lock:true,
            width:"480px",
            height:"260px"
        });
    }
$(function() {
	$(".more-filter").toggle(function(e){
		$(".more-filter").addClass("active");
        $(".more-filter").html("收起筛选");
        $(".SearchArea").addClass("extendMode");
        $(".SearchAreaLabel").show();
        $(".SearchAreaLeft-inner").addClass("active");
        $("#member_cards").insertBefore("#member_id");
    },function(e){
        $(".more-filter").removeClass("active");
        $(".SearchArea").removeClass("extendMode");
        $(".more-filter").html("更多筛选");
        $(".SearchAreaLabel").hide();
        $(".SearchAreaLeft-inner").removeClass("active");
        $("#member_cards").insertBefore("#nickname");
    });

});
    function unselectall(){
        if(document.myform.chkAll.checked){
            document.myform.chkAll.checked = document.myform.chkAll.checked&0;
        }
    }
    function CheckAll(form){
        for (var i = 0; i < form.elements.length; i++){
            var e = form.elements[i];
            if (e.Name != 'chkAll' && e.disabled == false) {
                e.checked = form.chkAll.checked;
            }
        }
    }

    function batchIncrease(type){
        var num=0;
        var value=[];
        var c=document.getElementsByTagName("INPUT");
        for(var i=0;i<c.length;i++){
            if(c[i].type=="checkbox" && c[i].checked)
            {
                num++;
                if(c[i].value !=''){
                    value[value.length]=c[i].value;
                }

            }
        }
        //弹窗批量添加
        var id=value;
        integralUpdate(id,type);
    }
</script>

</head>
<body>
<div id="wrapper">
    <include file="./Home/Tpl/Public/Public_header.html" />
       	<!--页面主体开始-->
    <div id="container">
        <div id="main">
        	<div class="sidenav">
            <include file="./Home/Tpl/Integral/Integral/Store_sidenav.html" leftmenuid="jizj"/>
            </div>
                <div class="subcon fn">
                	<div class="main-name fn">
                        <h4>手动增减{:L('INTEGRAL_NAME')}</h4>
                    </div>
                    <div class="Wcanal-tab" id="Wcanal-tabon">
                        <div class="Wcanal-tab-list">
                        	<div class="SearchArea fn">
								<form action="{:U('integralUpdate')}" method="get" name="theform" id="theform">
                                    <input type="hidden" name="g" value="Integral">
                                    <input type="hidden" name="m" value="Integral">
                                    <input type="hidden" name="a" value="integralUpdate">
									<div class="SearchAreaLabel">基本<br>资料</div>
			                        <div class="SearchAreaLeft">
                                        <input type="hidden" value="1" name="dataType"/>
			                        	<div class="SearchAreaLeft-inner">
			                        		<label>
				                                <span>姓名</span><input name="member_name" type="text" class="textbox w90" value="{$member_name}" />
				                            </label>
				                            <label>
				                                <span>手机号</span><input name="member_phone" type="text" class="textbox w90" value="{$member_phone}" />
				                            </label>
				                            <label>
                                                <span>性别</span><select class="textbox w100" name="member_sex">
				                                    <option value="">全部</option>
				                                    {:show_arr_opt($sex_list, $member_sex)}
												</select>
				                            </label>
			                                <label id="member_cards">
			                                    <span>会员卡</span>
			                                    <select class="textbox w100" name="member_cards">
			                                        <option value="">全部</option>
			                                        {:show_arr_opt($member_cgroup, $member_cards)}
												</select>
			                                </label>
				                            <label id="nickname">
				                                <span>微信昵称</span><input name="nickname" type="text" class="textbox w90" value="{$nickname}" />
				                            </label>
				                            <label>
				                                <span>出生日期</span><input type="text" name="birthday_start" id="birthday_start" onclick="WdatePicker({dateFmt:'yyyyMMdd',maxDate:'#F{$dp.$D(\\'birthday_end\\')}'})" value="{$birthday_start}" />
				                                -
				                                <input type="text" name="birthday_end" id="birthday_end" onclick="WdatePicker({dateFmt:'yyyyMMdd',minDate:'#F{$dp.$D(\\'birthday_start\\')}'})" value="{$birthday_end}" />
				                            </label>
				                            <label>
				                                <span>地区</span>
				                                <select name="province" class="textbox w100" id="province">
                                                    <option value="">省</option>
                                                </select>
                                                <select name="city" class="textbox w100" id="city">
                                                    <option value="">市</option>
                                                </select>
                                                <select name="town" class="textbox w100" id="town">
                                                    <option value="">区</option>
                                                </select>
				                            </label>
				                            <label>
				                                <span>来源渠道</span><input name="channel_name" type="text" class="textbox w90" value="{$channel_name}" />
				                            </label>
			                        	</div>
			                        </div>
			                        
			                        <div class="SearchAreaLabel">行为<br>数据</div>
			                        <div class="SearchAreaLeft">
			                        	<div class="SearchAreaLeft-inner">
			                        		<label>
                                                <span>活动参与次数</span>
                                                <input name="join_cnt1" id="join_cnt1" type="text" class="textbox w90" value="{$join_cnt1}" />
                                                -
                                                <input name="join_cnt2" id="join_cnt2" type="text" class="textbox w90" value="{$join_cnt2}" />
                                            </label>
                                            <label>
                                                <span>接收卡券数</span>
                                                <input name="send_cnt1" id="send_cnt1" type="text" class="textbox w90" value="{$send_cnt1}" />
                                                -
                                                <input name="send_cnt2" id="send_cnt2" type="text" class="textbox w90" value="{$send_cnt2}" />
                                            </label>
                                            <label>
                                                <span>到店核销数</span>
                                                <input name="verify_cnt1" id="verify_cnt1" type="text" class="textbox w90" value="{$verify_cnt1}" />
                                                -
                                                <input name="verify_cnt2" id="verify_cnt2" type="text" class="textbox w90" value="{$verify_cnt2}" />
                                            </label>
                                            <label>
                                                <span>线上购物次数</span>
                                                <input name="shop_line1" id="shop_line1" type="text" class="textbox w90" value="{$shop_line1}" />
                                                -
                                                <input name="shop_line2" id="shop_line2" type="text" class="textbox w90" value="{$shop_line2}" />
                                            </label>
                                            <label>
                                                <span>线下消费次数</span>
                                                <input name="shop_down1" id="shop_down1" type="text" class="textbox w90" value="{$shop_down1}" style="width:70px;"/>
                                                -
                                                <input name="shop_down2" id="shop_down2" type="text" class="textbox w90" value="{$shop_down2}" style="width:70px;"/>
                                            </label>
			                        	</div>
			                        </div>

                                    <div class="SearchAreaLabel">标签<br>信息</div>
                                    <div class="SearchAreaLeft" style="overflow: visible;">
                                        <div class="SearchAreaLeft-inner">
                                            <label>
                                                <span>标签</span>
                                                <select class="easyui-combobox" name="state" style="width:100px;">
                                                    {:show_arr_opt($member_lgroup, $member_label)}
                                                </select>
                                                <input class="searchBtn" id="add_mark" type="button" value="添加" style="position: inherit; right: 0; cursor: pointer; margin-right: 10px; vertical-align: middle;" />
                                                <div class="mark-box fn" <php>if($arr){echo "style='display:block;'";}</php>>
                                                    <volist name="arr" id="vo1">
                                                        <div class="mb1 fl" id="mb1">{$vo1}<i></i></div>
                                                    </volist>
                                                </div>
                                                <input type="hidden" id="bqValue" name="bqValue"  value="{$label_name}"/>
                                            </label>
                                        </div>
                                    </div>
			                        <div class="SearchAreaLabel">卡信<br>息</div>
			                        <div class="SearchAreaLeft">
			                        	<div class="SearchAreaLeft-inner">
			                        		<label id="member_id">
				                                <span>会员卡号</span>
				                                <input name="member_id" type="text" class="textbox w90" value="{$member_id}" style="width:70px;"/>
				                            </label>
				                            <label>
				                                <span>剩余积分</span>
				                                <input name="integral_point1" id="integral_point1" type="text" class="textbox w90" value="{$integral_point1}" />
                                                -
                                                <input name="integral_point2" id="integral_point2" type="text" class="textbox w90" value="{$integral_point2}" />
				                            </label>
			                        	</div>
			                        </div>
                            <input type="hidden" id="opt" name="optNumber" value="">
			                        <div class="SearchAreaRight">
			                            <a href="javascript:void(0);" id="sub_button" class="searchBtn">查找</a>
			                            <a href="javascript:void(0);" class="more-filter">更多筛选</a>
			                        </div>
								</form>
							</div>
                        	<div class="shopCon">
                                <form name="myform" method="post" id="myform" action="" >
	                            <table cellpadding="0" cellspacing="0" class="W-table">
	                            <thead>
	                            <tr class="th">
	                            <th>选择</th>
                                <th>手机号码</th>
                                <th>姓名</th>
                                <th>会员卡</th>
                                <th>当前{:L('INTEGRAL_NAME')}</th>
                                <th>上次登录时间</th>
	                            <th class="last">操作</th>
	                            </tr>
	                            </thead>
	                            <tbody>
                                <volist name="memberData" id="vo">
                                    <tr>
                                        <td><input name='id' type='checkbox' onclick='unselectall()'  value='{$vo.id}'/></td>
                                        <td>{$vo.phone_no}</td>
                                        <td>{$vo.name}</td>
                                        <td>{$vo.card_name}</td>
                                        <td>{$vo.point}</td>
                                        <td>{$vo['update_time']|preg_replace='/([0-9][0-9][0-9][0-9])([0-9][0-9])([0-9][0-9])(.*)/','$1-$2-$3',###|}</td>
                                        <td>
                                            <a href="javascript:void(0);" onclick="integralUpdate('{$vo.id}','1');">&nbsp;增减{:L('INTEGRAL_NAME')}</a>
                                        </td>
                                    </tr>
                                </volist>
                        <empty name="memberData" >
                            <tr class="info">
                                <td colspan="9" class="last">
                                    <div class="nonedata"></div>
                                </td>
                            </tr>
                        </empty>
	                            </table>
                                 <php>if($memberData!=''){</php>
	                            <div class="choose">
	                            	<label><input type="checkbox" name="chkAll" id='chkAll' onclick='CheckAll(this.form)'value="" />全选</label>
                                    <a href="javascript:void(0);" onclick="batchIncrease('2');">&nbsp;&nbsp;批量增减{:L('INTEGRAL_NAME')}</a>
                                    <label class="select">
                                        每页显示<select id="select">
                                        {:show_arr_opt($paging, $optNumber)}
                                    </select>条数据
                                    </label>
                                </div>

                                <php>}</php>

	                            <div class="page">{$page}</div>
                                </form>
	                        </div>
                        </div>
                    <script>
                        $(document).ready(function(){
                            $("#select").change(function(){
                                var id = $(this).find("option:selected").val();//当前下拉选择的值
                                $("#opt").val(id);
                                $("#theform").submit();
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
        <include file="./Home/Tpl/Public/Public_footer.html" />
    </div>
</div>
<div class="integralService"></div>
</body>
</html>

<script type="text/javascript">
$(document).ready(function(e){
    $("#sub_button").click(function(){
        //剩余积分输入校验
        if(inputFlag("integral_point", "剩余积分") == false) {
            return false;
        }
        //活动参与次数输入校验
        if(inputFlag("join_cnt", "活动参与次数") == false) {
            return false;
        }
        //接收卡券数输入校验
        if(inputFlag("send_cnt", "接收卡券数") == false) {
            return false;
        }
        //到店核销数输入校验
        if(inputFlag("verify_cnt", "到店核销数") == false) {
            return false;
        }
        //线上购物次数输入校验
        if(inputFlag("shop_line", "线上购物次数") == false) {
            return false;
        }
        //线下购物次数输入校验
        if(inputFlag("shop_down", "线下购物次数") == false) {
            return false;
        }

        $("#theform").submit();
    });

    CityCode({
        province:$("#province"),//省
        city:$("#city"),//市
        town:$("#town"),//区
        selected:"{:$_GET['province'].$_GET['city'].$_GET['town']}",
        url:"{:U('LabelAdmin/AjaxCity/index')}"
    });
});

function inputFlag(numId, msg)
{
    var num1 = $("#"+numId+"1").val();
    var num2 = $("#"+numId+"2").val();

    if(num1 != '' && num1 < 1) {
        art.dialog({title:false,content:"<div class='msg-all-error'>请在"+msg+"第一个输入框输入大于0的数字</div>",fixed:true,padding:0,time:2});
        return false;
    }
    if(num2 != '') {
        if(num1 == '') {
            if(num2 < 1) {
                art.dialog({title:false,content:"<div class='msg-all-error'>请在"+msg+"第二个输入框中输入大于0的数字</div>",fixed:true,padding:0,time:2});
                return false;
            }
        } else {
            var num = num2 - num1;
            if(num < 0) {
                art.dialog({title:false,content:"<div class='msg-all-error'>"+msg+"第二个参与必须大于第一个参数</div>",fixed:true,padding:0,time:2});
                return false;
            }
        }
    }

    return true;
}

$(function(){
    $(".combo").css("height","26px");
    $(".combo-arrow").css("height","26px");
	$(".textbox-text").css({"width":"74px","margin-right":"0"});
    $(".combo").addClass("active");
    $("#add_mark").click(function(){
        var val = $(".textbox-text").val();
        if(val == '') {
            return false;
        }
        $.post(
                "{:U('selLabelFlag')}",
                {label_name: val},
                function (data) {
                    if (data.status == '0') {
                        art.dialog({title:false,content:"<div class='msg-all-error'>添加的标签不存在~~</div>",fixed:true,padding:0,time:2});
                        return false;
                    }
                },
                'json'
        );
        var str = $("#bqValue").val();

        if(str != '' && str.indexOf(val+",") > 0) {
            art.dialog({title:false,content:"<div class='msg-all-error'>添加的标签已经添加，请添加其它标签~~</div>",fixed:true,padding:0,time:2});
            return false;
        }
        var dom = '<div class="mb1 fl" id="mb1">' + val + '<i>x</i></div>';
        str += val+',';
        $("#bqValue").val(str);
        if(val==""){
            $(".textbox-text").attr("value","");
        }else{
            $(this).after(dom);
            $(".textbox-text").attr("value","");
        };
    });
    $(document).on("click", "#mb1 i", function(){
        var str = $("#bqValue").val();
        var rmL = $(this).parent(".mb1").text();
        $("#bqValue").val(str.replace(rmL+",", ""));
        $(this).parent(".mb1").remove();
    });
});
</script>