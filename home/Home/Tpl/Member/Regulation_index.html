<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>粉丝权益设置_粉丝筐_翼码旺财</title>
<link href="__PUBLIC__/Css/main.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/layout.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/module.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/member.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wcanal.css?v=__VR__" rel="stylesheet" type="text/css" />
<js href="__PUBLIC__/Js/jquery-1.7.1.min.js?v=__VR__"/>
<js href="__PUBLIC__/Js/global.js?v=__VR__"/>
<js  href="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default" />
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
<js href="__PUBLIC__/Js/My97DatePicker/WdatePicker.js?v=__VR__"/>
<script type="text/javascript" src="__PUBLIC__/Js/member.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery.form.js?v=__VR__"></script>
<load href="__PUBLIC__/Js/validationEngine/css/validationEngine.jquery.css" />
<js href="__PUBLIC__/Js/validationEngine/languages/jquery.validationEngine-zh_CN.js?v=__VR__" />
<js href="__PUBLIC__/Js/validationEngine/jquery.validationEngine.js?v=__VR__" />
<style type="text/css">
.uploadarea li img{ z-index:-1; display:block}
.editupload{ display:none; width:70px; height:50px; background:rgba(0, 0, 0, 0.5); position:absolute; top:0; z-index:600; color:#FFF; font-weight:bold; line-height:50px; text-align:center}

a.btn-up{  display: inline-block;  padding: 4px 15px;  border: solid 1px #ffd0d3;  background: #fff2f3; border-radius:2px;  color: #f15755; text-decoration:none cursor:pointer}
a.btn-up:hover { background:#ffd0d3; text-decoration:none}


.sweet_tips {  padding-left: 15px;  margin-left: auto;  margin-right: auto;  border: 1px solid #f2e6ce;  background-color: #fffbf2;  color: #f0ab68;  font-size: 14px;  padding: 4px 15px;  margin-bottom: 10px; border-radius:2px;}
input:-moz-placeholder,textarea:-moz-placeholder {color: #999;}
input:-ms-input-placeholder,textarea:-ms-input-placeholder {color: #999;}
input::-webkit-input-placeholder,textarea::-webkit-input-placeholder {color: #999;}
input::placeholder,textarea::placeholder {color:#999;}
.small_font{ font-size:14px;}
</style>
<script type="text/javascript">
$(function(){
	$("#cards_submit").click(function(){
		var show_id = $("#level_id").val();
        var dialog;
        if($("#cards_form").validationEngine('validate')){
            $("#cards_form").ajaxSubmit({
                beforeSubmit:function(){
                    dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
                },
                success:function(data){
                     if(data.status == '1'){
                           dialog.time(2).content("<div class='msg-all-succeed'>"+data.info+"</div>");
                           var jump_url = "window.location.href='{:U('Member/Regulation/index')}&show="+show_id+"'";
                           setTimeout(jump_url,500);
                           return false;
                      }else{
                            dialog.time(3).content("<div class='msg-all-error'>"+data.info+"</div>");
                              }
                      },
                dataType:'json'
            });
            return false;
        }
    });
	$("#pri_submit").click(function(){
        var show_id = $("#pri_level_id").val();
        var dialog;
        if($("#pri_form").validationEngine('validate')){
            $("#pri_form").ajaxSubmit({
                beforeSubmit:function(){
                    dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
                },
                success:function(data){
                     if(data.status == '1'){
                           dialog.time(2).content("<div class='msg-all-succeed'>"+data.info+"</div>");
                           var jump_url = "window.location.href='{:U('Member/Regulation/index')}&show="+show_id+"'";
                           setTimeout(jump_url,500);
                           return false;
                      }else{
                            dialog.time(3).content("<div class='msg-all-error'>"+data.info+"</div>");
                              }
                      },
                dataType:'json'
            });
            return false;
        }
    });
	
	$(".introduce-mem").click(function(){
		var html=
			['<div class="fn" style="width:800px">',
			'<div class="tc" style=" background:url(__PUBLIC__/Image/introduce/m-1.png) repeat-x 0 0;line-height:105px; font-size:32px;">粉丝权益说明</div>',
			'<div class="fn tc"><img src="__PUBLIC__/Image/introduce/m-2.png" class="mt20"></div>',
			'<div class="fn tl" style="margin-top:30px; margin-left:30px;line-height:30px; background:url(__PUBLIC__/Image/introduce/m-5.png) no-repeat 0 0;color:#fff; font-size:14px; font-weight:bold;text-indent:10px;">商家配置流程</div>',
			'<div class="fn tc"><img src="__PUBLIC__/Image/introduce/m-3.png" class="mt20"></div>',
			'<div class="fn tl" style="margin-top:30px; margin-left:30px;line-height:30px; background:url(__PUBLIC__/Image/introduce/m-5.png) no-repeat 0 0;color:#fff; font-size:14px; font-weight:bold;text-indent:10px;">粉丝消费流程</div>',
			'<div class="fn tc"><img src="__PUBLIC__/Image/introduce/m-4.png" class="mt20"></div>',
			'</div>'].join('');
		art.dialog({
			title:false,
			content:html,
			width:800,
			padding:"0",
			top:"0",
			lock:true
		});
	})
	//门店处理
	$("input[name='shop']").change(function(){
        if($(this).val()==1){
            $("#chooseShop").css("display","none");
        }else{
            $("#chooseShop").css("display","block");
        }
    });
	$("a[name='choose_shop']").click(function(){
        var type = '&type=member';
        art.dialog.open("{:U('WangcaiPc/NumGoods/shopList')}"+type,{
            lock: true,
            title:"选择门店",
            width:720,
            height:'80%'
        });
    });
	$(".icon-del").on('click',function(){
        $(this).closest(".numgoodsList-item").detach();
    });
	$("#valid_day").click(function(){
        $("input[name='date_type'][value='0']").attr("checked",true);
    });
    $("#begin_date,#end_date").click(function(){
        $("input[name='date_type'][value='1']").attr("checked",true);
    });
});
function edit(level){
	$.get("{:U('Member/Regulation/save')}",{"level_id":level},function(datas){
		var data = datas.data;
		if(datas.status==1){
			$("#level_name,#pri_info,#begin_date,#end_date,#valid_day,#shop_idstr").val('');
		    $("#shop_number").html('0');
			$("#level_name").val(data.level_name);
			$("#pri_info").val(data.print_info);
			$("#level_id").val(level);
			$("#shop_idstr").val(data.oldStoreStr);
			$("#shop_number").html(data.storeCount);
			if(data.node_pos_type == 2){
				$("input[name='shop']").next(".newRadio").find("span:eq(1)").click();
			}else{
				$("input[name='shop']").next(".newRadio").find("span:eq(0)").click();
			}
			$("#cards_form").attr("action","{:U('Member/Regulation/save')}");
			if(data.date_type == 0){
				$("#valid_day").val(data.valid_day);
				$("input[name='date_type']").next(".newRadio").find("span:eq(0)").click();
			}else{
				$("#begin_date").val(data.verify_begin_date.substr(0,8));
				$("#end_date").val(data.verify_end_date.substr(0,8));
				$("input[name='date_type']").next(".newRadio").find("span:eq(1)").click();
			}
		    art.dialog({
		        title:"编辑粉丝卡",
		        id:"member_cards",
		        content:document.getElementById("member_cards"),
		        width:830,
		        lock:true
		    });
		}else{
			art.dialog({title:false,time:3,content:"<div class='msg-all-error'>"+datas.info+"</div>",fixed:true,padding:0});
		}
	},"json");
}
function add(level){
	$("#level_id").val(level);
	$("#level_name,#pri_info,#begin_date,#end_date,#valid_day,#shop_idstr").val('');
	$("#shop_number").html('0');
	$("input[name='shop'],input[name='date_type']").next(".newRadio").find("span:eq(0)").click();
	$("#cards_form").attr("action","{:U('Member/Regulation/openLevel')}");
	$(".newRadio:first-child").addClass('hover');
	art.dialog({
        title:"启用粉丝卡",
        id:"member_cards",
        content:document.getElementById("member_cards"),
        width:830,
        lock:true
    });
}

function stop(level){
	art.dialog.confirm("停用粉丝权益会将该权益下所有粉丝的特权撤销,您确定停用该粉丝权益么？",function(){
		dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
		$.get("{:U('Member/Regulation/levelStop')}",{"level_id":level},function(data){
			if( data.status == '1')
            {
               dialog.time(2).content("<div class='msg-all-succeed'>"+data.info+"</div>");
               var jump_url = "window.location.href='{:U('Member/Regulation/index')}&show="+level+"'";
               setTimeout(jump_url,500);
               return false;
            }else{
                dialog.time(3).content("<div class='msg-all-error'>"+data.info+"</div>");
            }
		},'json');
    });
}
</script>
</head>
<body>
    <div id="wrapper" class="bgeee">
        <include file="./Home/Tpl/Public/Public_header.html" />
        <div id="container" class="bgfff">
            <div id="main" class="rel">
                <div class="bread">
                    <div class="bread-con fn">
                        <div class="bread-area">
                            <i class="icon-bread"></i>
                            <p><a href="{:U('Home/Index/index')}">首页</a></p>
                            <p>></p>
                            <p><a href="index.php?g=Member&m=Member&a=index">粉丝筐</a></p>
							<p>></p>
                            <p>粉丝权益设置</p>                            
                        </div>
                        <div class="bread-history">
                            <i class="icon-history"></i>
                            <p><a href="javascript:void(0)" class="ind-bread">返回</a></p>
                        </div>
                    </div>
                </div>
                <div class="sidenav">
                    <!--开始载入左菜单--> 
                    <include file="Member/Member/leftMenu" leftmenuid="fsqyksz"/>
                </div>
                <div class="subcon fn">
                    <div id="Wcanal-tabon" class="Wcanal-tab">
                    <a href="javascript:void(0)" class="btn-all-auto w110 r introduce-mem">权益说明</a>
                        <div class="Wcanal-tab-title fn">
                        	
                            <?php for($i=1;$i<=$level;$i++){?>
                            <p <?php if($i==$showTab){echo 'class="Wcanal-tab-hover"';}?> >
                                <?php 
                                    if(!empty($list[$i])){
                                        echo $list[$i]['level_name'];
                                    }else{
                                        echo $level_arr[$i];
                                    }
                                ?>
                            </p>
                            <?php }?>
                        </div>
                        
                        
                        <!--循环开始-->
                        <?php for($i=1;$i<=$level;$i++){?>
                        <div class="Wcanal-tab-list <?php if($i!=$showTab){echo 'dn';}?>">
                            <div class="mem-list fn">
                                <div class="mem-item fn">
                                    <div class="mem-icon mem-icon-all"></div>
                                    <div class="mem-new-con fn">
                                        <div class="mem-con">
                                            <?php if(empty($list[$i])){?><!-- 未启用 -->
                                            <div class="mem-notenabled fn">
                                                <div class="mem-notenabled-con">您还没有启用这一类别的粉丝卡</div>
                                                <div class="mem-notenabled-opr"><a href="javascript:void(0);" onclick="add('<?php echo $i;?>');" class="btn-all r w70">启用</a></div>
                                            </div>
                                            <?php }else{?><!-- 已启用 -->
                                            <div class="mem-enabled fn">
                                                <div class="mem-enabled-title">粉丝权益信息<a href="javascript:void(0);" onclick="stop('<?php echo $list[$i]['member_level']?>',1)" class="mr50 pr50 mem-editgo dib r">停用该粉丝权益</a><a href="javascript:void(0);" onclick="edit('<?php echo $list[$i]['member_level']?>',1)" class="mr50 pr50 mem-editgo dib r">编辑粉丝权益信息</a></div>
                                                <div class="mem-enabled-con">
                                                    <ul class="mem-enabled-base">
                                                        <li>粉丝权益名称：<span><?php echo $list[$i]['level_name']?></span></li>
                                                        <li>
                                                           <?php if($list[$i]['date_type']==0){ ?>
                                                                                                                                                                                有效期：<span><?php echo $list[$i]['valid_day']?></span>天
                                                           <?php }else{ ?>
                                                                                                                                                                                有效期：<span><?php echo dateformat($list[$i]['verify_begin_date'],'Y年m月d日');?></span>&nbsp;-&nbsp;<span><?php echo dateformat($list[$i]['verify_end_date'],'Y年m月d日');?></span>&nbsp;<span style="color:#ED1C24;"><?php if(strtotime($list[$i]['verify_end_date']) <= time()){echo '(已过期)';}?></span>
                                                           <?php }?>
                                                        </li>
                                                    </ul>
                                                    <ul class="mem-enabled-msg">
                                                        <li><h6>权益特权：</h6><p><?php echo $list[$i]['print_info']?></p></li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <?php }?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php }?>
                        <!--循环结束-->
                    </div>
                </div>
            </div>
        </div>
        <include file="./Home/Tpl/Public/Public_footer.html" />
    <div class="service"></div>
    <!-- 启用配置 -->
    <div id="member_cards" class="mem-form dn">
        <form method="post" id="cards_form" action="">
            <div class="Gform">
                <ul class="Gtitle">粉丝权益基础信息</ul>
                <ul>
                    <li class="Gname">粉丝权益名称：</li>
                    <li class="Ginput"><input type="text" name="level_name" id="level_name" class="validate[required,maxSize[7]]" value=""/><span class="txtTips">如：金卡、银卡</span></li>
                </ul>
                <ul>
                    <li class="Gname">有效期：</li>
                    <li class="Ginput">
                        <div class="switch" data-callback="txtTips">
                            <input type="radio" name="date_type" value="0" checked="checked">
                            <div class="newRadio">
                                <span class="valfirst hover" data-val="0">按天数</span>
                                <span class="vallast" data-val="1">按日期</span>
                            </div>
                            <div class="newRadio-default">
                                <input name="valid_day" id="valid_day" type="text" style="width:122px;" class="validate[condRequired[date_type1],min[1],max[365],custom[integer]]">
                                <span class="maxTips forInput">天</span>
                            </div>
                            <div class="newRadio-input">
                                <div class="Gtime2">
                                    <input name="begin_date" id="begin_date" type="text" onclick="WdatePicker({minDate:'%y-%M-%d',maxDate:'#F{$dp.$D(\\'end_date\\')}'})" class="validate[condRequired[date_type2]]">
                                    <em>至</em>
                                    <input name="end_date" id="end_date" type="text" onclick="WdatePicker({minDate:'#F{$dp.$D(\\'begin_date\\')||\\'%y-%M-%d\\'}'})" class="validate[condRequired[date_type2]]">
                                </div>
                            </div>
                            <div class="cl"></div>
                            <span class="txtTips" id="txtTips0">粉丝权益生效的开始时间和结束时间</span>
                            <span class="txtTips" style="display:none" id="txtTips1">发送粉丝权益时开始算时间,有效期最高365天</span>
                        </div>
                    </li>
                </ul>
                <ul>
                    <li class="Gnmae">*&nbsp;可验证门店：</li>
                    <li class="Ginput">
                    <div class="switch">
                            <input type="radio" name="shop" id="shop" value="1" checked="checked" />
                            <div class="newRadio">
                                <span class="valfirst hover" data-val="1">所有门店可用</span>
                                <span class="vallast" data-val="2">自己选择可用门店</span>
                            </div>
                            <div class="newRadio-input mt10">
                                <a href="javascript:void(0);" class="btn-up fl" name="choose_shop">选择门店</a>
                                <input type="hidden" id="shop_idstr" name="shop_idstr" value=""/>
                                <div class="sweet_tips ml10" style="display:inline-block">您已选择<span id="shop_number">0</span>家核验门店</div>
                                <p class="txtTips">注：仅限已安装核验终端的门店</p>
                            </div>
                        </div>
                    </li>
                </ul>
                <ul class="Gtitle">粉丝权益特权设置</ul>
                <ul>
                    <li class="Gname">特权描述：</li>
                    <li class="Ginput">
                        <textarea name="pri_info" id="pri_info" onkeyup="check_lenght(100,'pri_text',this);" class="validate[required,maxSize[100]]"></textarea><span class="maxTips forArea" data-max="100">0/100</span>
                        <span class="txtTips">注：新设置的粉丝权益特权将替换掉您当前的粉丝权益特权</span>
                    </li>
                </ul>
                <ul>
                    <li class="Gname">&nbsp;</li>
                    <li class="Ginput">
                        <input type="hidden" value='1' name="ajax" />
                        <input type="hidden" value='' name="level_id" id="level_id"/>
                        <a href="javascript:void(0)" id="cards_submit"  class="btn-all w90">确认</a>
                        <a href="javascript:void(0)" onclick="art_close('member_cards');"  class="btn-all-del w90">取消</a>
                    </li>
                </ul>
            </div>
            <div class="cl"></div>
        </form>
    </div>
<!-- 启用配置结束 -->
</body>
</html>
<script>
function txtTips(t){
	var val = t.attr("data-val");
    $("#txtTips0,#txtTips1").hide();
	$("#txtTips"+val).show();
}
</script>