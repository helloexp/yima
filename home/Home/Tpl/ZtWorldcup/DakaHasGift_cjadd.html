<assign name="cj_action" value="[cj_action]"/>
<input type="hidden" name="is_reset" id="is_reset" value="0" />
<input type="hidden" name="prize_item_num" id="prize_item_num" value="1" />
<input type="hidden" name="batchjson" id="batchjson" value="" />
<if condition="(ACTION_NAME=='add')">
	<ul class="newsadd-title">
		奖品配置
		<a href="javascript:void(0)" class="btn-all w90 add_prize_item" style="display:block;float:right;">添加签到时间</a>
	</ul>

	<ul class="prize_item" data-num='1'>
		<li class="global-input2-name">绑定抽奖：</li>
		<li class="global-input2-input c_bd_d1">
		  <div class="ml10 mt10 db">
		  	*连续签到：<input id="check_days[]" name="check_days[]" type="text"  class="validate[required,custom[integer],max[25],min[1]] textbox w50 checkdays" value=""/><span>&nbsp;天</span>
		  </div>
            <div class="ml10 mt10 db">*&nbsp;中&nbsp;&nbsp;奖&nbsp;&nbsp;概&nbsp;&nbsp;&nbsp;率：<input id="award_rate_1" name="award_rate[]" type="text"  class="validate[required,custom[integer],max[100]] textbox w50" value=""/><span>&nbsp;%</span></div>


		  <div class="ml10 mt10"  id="wc_style" ></div>
            <div style="border-bottom:1px #ccc solid" class="prize">
		  <input type="hidden" name="wc_batch_no[]"  value=""/>
		  <input name="goods_name[]"  type="text"  class="validate[required] textbox w120 ml10" value="" readonly="readonly"/><a href="javascript:void(0)" class="btn-all w80 ml10 bind_cj" id="bind_cj">选择卡券</a>


		   <div class="ml10 mt10 db">*&nbsp;奖&nbsp;&nbsp;品&nbsp;&nbsp;总&nbsp;&nbsp;&nbsp;数：<input id="goods_count" name="goods_count[]" type="text"  class="validate[required,custom[integer]] textbox w50" value=""/><span>&nbsp;份</span></div>
		   <div class="ml10 mt10 db">*&nbsp;每&nbsp;&nbsp;日&nbsp;&nbsp;数&nbsp;&nbsp;&nbsp;量：<input id="day_count" name="day_count[]" type="text"  class="validate[required,custom[integer]] textbox w50" value=""/><span>&nbsp;份</span></div>

            </div>


            <div id="more_prize">
            </div>


            <div >
                <a href="javascript:void(0)" class="w100 delete_check_days" style="display:none;float:right;">删除签到天数</a>
                <eq name="mg_flag" value="1">
                <a href="javascript:void(0)" class="w100 add_check_days_prize" style="float:right;margin-right:10px">添加奖品</a>
                </eq>
            </div>



		 <div class="cl"></div>
		</li>

	</ul>

<else/>
	<div id="editrule">
	<ul class="newsadd-title">
		<a href="javascript:;" id="reeditcj" class="btn-all w90 r">编辑</a>
		活动卡券配置
	</ul>
	<volist name="cjarr" id="vo">
		<ul class="prize_item">
			<li class="global-input2-name">绑定抽奖：</li>
			<li class="global-input2-input c_bd_d1">
              <input type="hidden" name="cj_rule_id[]" value="{$vo.cj_rule_id}"/>

			  <div class="ml10 mt10 db">
			  	*连续签到：<input id="" name="check_days[]" type="text"  class="validate[required,custom[integer],max[25],min[1] textbox w50 checkdays" value="{$vo.check_days}"  disabled/><span>&nbsp;天</span>
			  </div>
                <div class="ml10 mt10 db">*&nbsp;中&nbsp;&nbsp;奖&nbsp;&nbsp;概&nbsp;&nbsp;&nbsp;率：<input id="" name="award_rate[]" type="text"  class="validate[required,custom[integer],max[100]] textbox w50 editcj" value="{$vo.award_rate}" data-val="{$vo.award_rate}"  disabled/><span>&nbsp;%</span></div>

			  <div class="ml10 mt10"  id="wc_style" >
              </div>

                <volist name="vo.list" id="voo">

              <div style="border-bottom:1px #ccc solid" class="prize">
			  <input type="hidden" name="cj_batch_id[]" value="{$voo.cj_batch_id}"/>
			  <input type="hidden" name="wc_batch_no[]" id="" value="{$voo.batch_no}"/>
			  <input name="goods_name[]" id="" type="text"  class="validate[required] textbox w120 ml10" value="{$voo.goods_name}" disabled/>卡券

			 
			   <div class="ml10 mt10 db">*&nbsp;奖&nbsp;&nbsp;品&nbsp;&nbsp;总&nbsp;&nbsp;&nbsp;数：
			   <input id="" name="goods_count[]" type="text"  class="validate[required,custom[integer]] textbox w50 editcj" value="{$voo.total_count}" data-val="{$voo.total_count}" disabled/><span>&nbsp;份</span></div>
			   <div class="ml10 mt10 db">*&nbsp;每&nbsp;&nbsp;日&nbsp;&nbsp;数&nbsp;&nbsp;&nbsp;量：<input id="" name="day_count[]" type="text"  class="validate[required,custom[integer]] textbox w50 editcj" value="{$voo.day_count}" data-val="{$voo.day_count}"  disabled/><span>&nbsp;份</span>
              </div>

                  </div>

                    </volist>
			 <div class="cl"></div>
			</li>
		</ul>
	</volist>
	
	</div>
	<ul>
		<li class="global-input2-name">&nbsp;</li>
		<li class="global-input2-input"><a href="javascript:;" id="edit_add_rule" class="input-add"><i></i>添加签到时间</a></li>
	</ul>

	<script id="rule_tpl" type="text">
	<ul class="prize_item_new" data-num='1'>
		<li class="global-input2-name">绑定抽奖：</li>
		<li class="global-input2-input c_bd_d1">
		  <div class="ml10 mt10 db">
		  	*连续签到：<input id="check_days_1" name="check_days[]" type="text"  class="validate[required,custom[integer],max[25],min[1]] textbox w50 checkdays" value=""/><span>&nbsp;天</span>
		  </div>
		  <div class="ml10 mt10 db">*&nbsp;中&nbsp;&nbsp;奖&nbsp;&nbsp;概&nbsp;&nbsp;&nbsp;率：<input id="award_rate_1" name="award_rate[]" type="text"  class="validate[required,custom[integer],max[100]] textbox w50" value=""/><span>&nbsp;%</span></div>

		  <div class="ml10 mt10"  id="wc_style" > </div>
        <div style="border-bottom:1px #ccc solid" class="prize">
		  <input type="hidden" name="wc_batch_no[]"  value=""/>
		  <input name="goods_name[]"  type="text"  class="validate[required] textbox w120 ml10" value="" readonly="readonly"/><a href="javascript:void(0)" class="btn-all w80 ml10 bind_cj" id="bind_cj">选择卡券</a>

		 
		   <div class="ml10 mt10 db">*&nbsp;奖&nbsp;&nbsp;品&nbsp;&nbsp;总&nbsp;&nbsp;&nbsp;数：<input id="goods_count_1" name="goods_count[]" type="text"  class="validate[required,custom[integer]] textbox w50" value=""/><span>&nbsp;份</span></div>
		   <div class="ml10 mt10 db">*&nbsp;每&nbsp;&nbsp;日&nbsp;&nbsp;数&nbsp;&nbsp;&nbsp;量：<input id="day_count_1" name="day_count[]" type="text"  class="validate[required,custom[integer]] textbox w50" value=""/><span>&nbsp;份</span></div>


        </div>
		   <div id="more_prize">
		   </div>


<div class="cl"></div>
           <div >
		   <a href="javascript:void(0)" class="w100 delete_check_days" style="display:;float:right;margin-right:10px">删除签到天数</a>
		   <eq name="mg_flag" value="1">
		   <a href="javascript:void(0)" class="w100 add_check_days_prize" style="display:;float:right;margin-right:10px">添加奖品</a>
		   </eq>
		   </div>
		 <div class="cl"></div>
		</li>
	</ul>
	</script>
</if>

<script id="prize_tpl" type="text">
        <div style="border-bottom:1px #ccc solid" class="prize">
            <div class="ml10 mt10"  id="wc_style" >
		  <input type="hidden" name="wc_batch_no[]"  value=""/>
		  <input name="goods_name[]"  type="text"  class="validate[required] textbox w120 ml10" value="" readonly="readonly"/><a href="javascript:void(0)" class="btn-all w80 ml10 bind_cj" id="bind_cj">选择卡券</a>
		  </div>

		   <div class="ml10 mt10 db">*&nbsp;奖&nbsp;&nbsp;品&nbsp;&nbsp;总&nbsp;&nbsp;&nbsp;数：<input id="goods_count_1" name="goods_count[]" type="text"  class="validate[required,custom[integer]] textbox w50" value=""/><span>&nbsp;份</span></div>
		   <div class="ml10 mt10 db">*&nbsp;每&nbsp;&nbsp;日&nbsp;&nbsp;数&nbsp;&nbsp;&nbsp;量：<input id="day_count_1" name="day_count[]" type="text"  class="validate[required,custom[integer]] textbox w50" value=""/><span>&nbsp;份</span></div>
		   <a href="javascript:void(0)" class="w100" onclick="javascript:if(confirm('是否确认删除奖品？')) $(this).parent().remove()" style="display:;margin-right:10px">删除奖品</a>
        </div>
    </script>
<script>
var ACTION_NAME = '{$Think.const.ACTION_NAME}';
$(function() {
	$('#prize_item_num').val(ACTION_NAME == 'add' ? 1 : 0);

    /*$('.prize').each(function(){
        $(this).find('input[name="wc_batch_no[]"]').each(function(i){
            this.id = "wc_batch_no_" + i;
        });
        $(this).find('input[name="goods_name[]"]').each(function(i){
            this.id = "goods_name_" + i;
        });
//        $(this).find()
    });*/

	$('.add_prize_item').click(function(){
		if($('.prize_item').length >= 25){
			alert('不能超过25个！');
			return ;
		}
		var new_item = $('.prize_item:eq(0)').clone();
        new_item.find('#more_prize').empty();
		new_item.find('input').val('');
        new_item.find('.delete_check_days').show();
		new_item.insertAfter($('.prize_item:last'));
//		sort_prize_item();
	});

	$('#edit_add_rule').click(function(){
		if($('.prize_item,.prize_item_new').length >= 25){
			alert('不能超过25个！');
			return ;
		}
		var ul = $($('#rule_tpl').html());
		ul.insertAfter($('#editrule ul:last'));
//		sort_prize_item();
	});

	$('.delete_check_days').live('click', function(){
		if(!confirm('是否确认删除？'))
			return false;

		var seletor = ACTION_NAME == 'add' ? '.prize_item' : '.prize_item_new';

		$(this).closest(seletor).remove();
		sort_prize_item();
	});

    //添加奖品项
    $('.add_check_days_prize').live('click', function(){
        var li = $(this).parent().parent();
        var prize = $($('#prize_tpl').html());
        $('#more_prize', li).append(prize);
    });

	//选择卡券
    (function(){
        var _prize_i = 0;
        $('.bind_cj').live('click', function() {
            var odiv = $(this).closest('div');
            if(odiv.data('set_id_flag') != '1'){
                _prize_i++;
                var goods_name = 'goods_name_' + _prize_i;
                var batch_no = 'wc_batch_no_' + _prize_i;
                $('input[name="goods_name[]"]', odiv).attr('id', goods_name);
                $('input[name="wc_batch_no[]"]', odiv).attr('id', batch_no);
                odiv.data('set_id_flag', 1).data('prize_id', _prize_i);
            }

            else{
                var prize_id = odiv.data('prize_id');
                goods_name = 'goods_name_' + prize_id;
                batch_no = 'wc_batch_no_' + prize_id;
            }

            var name = '&name='+goods_name+'&batch_no='+batch_no;
            art.dialog.open("{:U('LabelAdmin/SelectJp/index')}" + name, {
                width: 800,
                height: 500,
                title: '选择卡券',
                lock: true
            })
        });
    })();

	//重新设置抽奖
	$('#resetcj').click(function() {
		if ($(this).html() == '重设') {
			if (!confirm('重置奖品后，已经发出的奖品数量不会计入新设置的总量内，您是否确认需要重置奖品?')) return false;
			$('#addcj').show();
			$('#editcj').hide();
			$('#is_reset').val('1');
			$('#reeditcj').hide();
			$(this).html('取消');
		} else {
			$('#is_cj_false').click();
			$('#is_cj_true').click();
			$('#is_cj_true').attr("checked", false);
			$('#cj_style').hide();
			$('#addcj').hide();
			$('#editcj').show();
			$('#is_reset').val('0');
			$('#reeditcj').show();
			$(this).html('重设');
		}
	});
	//编辑抽奖
	$('#reeditcj').click(function() {
		if ($('#reeditcj').html() == '编辑') {
			$('#reeditcj').html('取消');
			$('.editcj').attr('disabled', false);
			$('#is_reset').val('2');
		} else {
			$(".editcj").each(function() {
				$(this).val($(this).data('val'));
			});
			$('#is_reset').val('0');
			$('#reeditcj').html('编辑');
			$('.editcj').attr('disabled', true);
		}
	});
})

function open_wc(i) {
	var name = '&name=goods_name_' + i + '&batch_no=wc_batch_no_' + i;
	art.dialog.open("{:U('LabelAdmin/SelectJp/index')}" + name, {
		width: 800,
		height: 500,
		title: '选择卡券',
		lock: true
	})
}
</script>


<if condition="(ACTION_NAME=='add')" >
    <script>
        function gen_batchjson(){
            var json_data = [];
            $('.prize_item').each(function(){
                var item = {
                    'check_days' : $(':input[name="check_days[]"]', this).val(),
                    'award_rate' : $(':input[name="award_rate[]"]', this).val(),
                    'list' : []
                };

                $(this).find('.prize').each(function(){
                    item.list.push({
                        'batch_no' : $(':input[name="wc_batch_no[]"]', this).val(),
                        'goods_name' : $(':input[name="goods_name[]"]', this).val(),
                        'goods_count' : $(':input[name="goods_count[]"]', this).val(),
                        'day_count' : $(':input[name="day_count[]"]', this).val()
                    });
                });

                json_data.push(item);
            });

            $('#batchjson').val(JSON.stringify(json_data));
            console.log(JSON.stringify(json_data));
        }
    </script>
    <else/>
    <script>
        function gen_batchjson(){
            var json_data = {change_list:[], new_list:[]};
            if ($('#reeditcj').html() != '编辑') {
                $('.prize_item').each(function(){
                    var item = {
                        'cj_rule_id' : $(':input[name="cj_rule_id[]"]', this).val(),
                        'check_days' : $(':input[name="check_days[]"]', this).val(),
                        'award_rate' : $(':input[name="award_rate[]"]', this).val(),
                        'list' : []
                    };

                    $('.prize', this).each(function(){
                        item.list.push({
                            'cj_batch_id' : $(':input[name="cj_batch_id[]"]', this).val(),
                            'batch_no' : $(':input[name="wc_batch_no[]"]', this).val(),
                            'goods_name' : $(':input[name="goods_name[]"]', this).val(),
                            'goods_count' : $(':input[name="goods_count[]"]', this).val(),
                            'day_count' : $(':input[name="day_count[]"]', this).val()
                        });
                    });

                    json_data.change_list.push(item);
                });
            }

            $('.prize_item_new').each(function(){
                var item = {
                    'check_days' : $(':input[name="check_days[]"]', this).val(),
                    'award_rate' : $(':input[name="award_rate[]"]', this).val(),
                    'list' : []
                };

                $(this).find('.prize').each(function(){
                    item.list.push({
                        'batch_no' : $(':input[name="wc_batch_no[]"]', this).val(),
                        'goods_name' : $(':input[name="goods_name[]"]', this).val(),
                        'goods_count' : $(':input[name="goods_count[]"]', this).val(),
                        'day_count' : $(':input[name="day_count[]"]', this).val()
                    });
                });

                json_data.new_list.push(item);
            });

            $('#batchjson').val(JSON.stringify(json_data));
            console.log(JSON.stringify(json_data));
        }
    </script>
</if>