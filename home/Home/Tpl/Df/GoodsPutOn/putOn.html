<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>上架管理_积分商城</title>
	<link rel="stylesheet" href="__PUBLIC__/Css/main.css?v=__VR__" />
	<link rel="stylesheet" href="__PUBLIC__/Css/module.css?v=__VR__" />
	<link rel="stylesheet" href="__PUBLIC__/Css/layout.css?v=__VR__" />
	<link rel="stylesheet" href="__PUBLIC__/Css/tfb_df_pointshop.css?v=__VR__" />
    <link rel="stylesheet" href="__PUBLIC__/Js/validationEngine/css/validationEngine.jquery.css" />
	<link href="__PUBLIC__/Css/tfb_df_pointshop.css?v=__VR__" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="__PUBLIC__/Js/jquery-1.7.1.min.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC_LOCAL__/Js/My97DatePicker/WdatePicker.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/global.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/ajaxfileupload.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/jquery.form.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/validationEngine/languages/jquery.validationEngine-zh_CN.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC__/Js/validationEngine/jquery.validationEngine.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC_LOCAL__/Js/ueditor/ueditor.config.js?v=__VR__"></script>
    <script type="text/javascript" src="__PUBLIC_LOCAL__/Js/ueditor/ueditor.all.min.js?v=__VR__"></script>
    <script type="text/javascript">
    Array.prototype.remove=function(dx){
        if(isNaN(dx)||dx>this.length){return false;}
        for(var i=0,n=0;i<this.length;i++){
            if(this[i]!=this[dx]){
                this[n++]=this[i]
            }
        }
        this.length-=1
    }
    </script>
</head>
<body>
	 <div id="wrapper">
        <include file="./Home/Tpl/Public/Public_header.html" />
		<!--开始载入头部菜单--> 
    <include file="Top/nav" navmenuid="Navpointshop"/>
        <div id="container" class="bgfff">
            <div id="main" class="rel">
			<div class="sidenav">
					<!--开始载入左菜单--> 
					<include file="Left/menu" leftmenuid="sjgl"/>
				</div>
                <div class="subcon fn">   
					<div class="main-name fn">
							<h4>上架列表<a href="{:U('Df/GoodsPutOn/putOn')}" class="btn-add first" ><i></i>上架商品</a></h4>
						</div>
                            <div class="edit-area" id="div_content">
                                <div class="shopProcedure fn">
                                    <li class="hover"><span>1</span><a href="javascript:void(0);">选择商品</a></li>
                                    <li id="nav_step2"><span>2</span><a href="javascript:void(0);">填写商品销售信息</a></li>
                                </div>
                                <div class="create-good">
                                <form id="theform" action="{:U('putOnSubmit')}" method="post">
                                	<div class="fn">
                                        <h1 class="title mb35">商品基础信息</h1>
                                        <!-- <ul>
                                            <li class="fn tc">                                                
                                                <a class="btn-all w120" id="bind_cj" href="javascript:void(0)">选择商品</a>
                                                <span class="ml20 mr20">或</span>
                                                <a class="btn-all w120" id="bind_cj2" href="javascript:void(0)">选择卡券</a>
                                                <input type="text" name="goods_id" id="goods_id" style="width:1px;" readonly="readonly" />
                                            </li>
                                        </ul> -->
                                        <ul>
                                            <li class="fn">
                                                <strong class="strong l">商品类型</strong>
                                                <label class="ml20 l"><input type="radio" value="0" name="ddd" class="checkradio vm mr5" checked="checked" /><span class="vm">商品</span></label>
                                                <label class="ml20 l"><input type="radio" value="1" name="ddd" id="storage_type" class="checkradio vm mr5" /><span class="vm">卡券</span></label>
                                                <label class="ml20 judgeCon1 l">
                                                <a class="btn" id="bind_cj" href="javascript:void(0)">选择商品</a>
                                                </label>
                                                <label class="ml20 judgeCon2 dn l">
                                                <a class="btn" id="bind_cj2" href="javascript:void(0)">选择卡券</a>
                                                </label>
                                            </li>
                                        </ul>

                                        <ul class="dn goods_info">
                                            <li class="fn">
                                                <strong class="strong l">商品名称</strong>
                                                <strong class="span l ml20" id="goods_name" data-view="text,title,previewData"></strong>
                                                <input type="hidden" name="goods_id" id="goods_id" style="width:1px;" readonly="readonly" />
                                            </li>
                                        </ul>
                                        <ul class="dn goods_info">
                                            <li class="fn mb50">
                                                <strong class="strong l">商品图片</strong>
                                                <div class="fn g-pics">
                                                    <img src="" alt="" class="img l" id="goods_image" />
                                                </div>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l">商品剩余数量</strong>
                                                <p class="span l ml20" id="goods_storage" data-view="text,allnum,previewData">&nbsp;</p>
                                            </li>
                                        </ul>
                                    </div>
                                    <div id="step2" class="dn">
                                    	<h1 class="title mb35">上架设置</h1>
                                       <li class="fn">
                                             <strong class="strong l">是否限时购买</strong>
                                             <label class="ml20"><input type="radio" value="0" name="purchase_time_limit" class="checkradio" checked="checked" />否</label>&nbsp;&nbsp;&nbsp;
                                             <label class="ml20"><input type="radio" value="1" name="purchase_time_limit" id="purchase_time_limit" class="checkradio" />是</label>
                                             <p class="font-12-cc">选择否，则消费者在浏览商品时看不到销售时间。</p>
                                        </li>
                                        <ul>
                                            <li class="fn">
                                                <strong class="strong l">商品销售时间</strong>
                                                <div class="judgeCon-time judgeCon1">
                                                    <p>开始时间</p>
                                                    <!-- var min_date=$('#begin_date').val();var max_date=$('#end_date').val();WdatePicker({minDate:'%y-%M-%d',maxDate:'#F{$dp.$D(\\'end_date\\')}'}) -->
                                                    <input name="begin_date" id="begin_date" type="text" onclick="" class="textbox w90 ml5" maxlength="8" value="" autocomplete="off">
                                                    <p class="ml20">结束时间</p>
                                                    <!-- WdatePicker({minDate:'#F{$dp.$D(\\'begin_date\\')||\\'%y-%M-%d\\'}'}) -->
                                                    <input name="end_date" id="end_date" type="text" onclick="" class="textbox w90 ml5" maxlength="8" value=""  autocomplete="off">
                                                    <div class="cl pt5"></div>
                                                    <p class="font-12-cc">商户可以自定义销售开始的日期如："4月1号,6月1号";到期后自动下架！</p>
                                                </div>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l">所属分组</strong>
                                                <select class="selectbox l w120 ml20" name="classify" id="classify">
                                                    {:show_arr_opt($classify_arr)}
                                                </select>
                                                <a class="btn l new-btn" href="javascript:void(0)">新增分组</a>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l">销售积分</strong>
                                                <input style="width:338px;" class="textbox ml20 validate[custom[integer]]" name="batch_amt" id="batch_amt" data-view="val,price,previewData" type="text" value="" />
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l">商品市场价格</strong>
                                                <label class="ml20"><input type="radio" value="0" name="market_show" class="checkradio" checked="checked" />不显示</label>
                                                <label class="ml20"><input type="radio" value="1" name="market_show" id="market_show" class="checkradio" />显示在前台</label>
                                                <label class="ml20 judgeCon2 dn"><input class="textbox" name="market_price" id="market_price" data-view="val,price2,previewData" type="text" value="" />元</label>
                                            </li>
                                            <li class="fn">
                                                 <strong class="strong l">总库存设置</strong>
                                                 <label class="ml20"><input type="radio" value="0" name="storage_type" class="checkradio" checked="checked" />不限</label>&nbsp;&nbsp;&nbsp;
                                                 <label class="ml20"><input type="radio" value="1" name="storage_type" id="storage_type" class="checkradio" />限制</label>
                                                 <label class="ml20 judgeCon2 dn"><input style="margin-left:42px;" name="storage_num" id="storage_num" class="textbox for-checkbox2" type="text" /></label>
                                            </li>
                                            <li class="fn">
                                                 <strong class="strong l">商品每日限购</strong>
                                                 <label class="ml20"><input type="radio" value="0" name="day_buy_num_flag" class="checkradio" checked="checked" />不限</label>&nbsp;&nbsp;&nbsp;
                                                 <label class="ml20"><input type="radio" value="1" name="day_buy_num_flag" id="day_buy_num_flag" class="checkradio" />限制</label>
                                                 <label class="ml20 judgeCon2 dn"><input style="margin-left:42px;" name="day_buy_num" id="day_buy_num" class="textbox for-checkbox2" type="text" /></label>
                                            </li>
                                            <li class="fn bd">
                                                <strong class="strong l">每人限购</strong>
                                                <label class="ml20"><input type="radio" value="0" name="person_buy_num_flag" class="checkradio" checked="checked" />不限</label>&nbsp;&nbsp;&nbsp;
                                                <label class="ml20"><input type="radio" value="1" name="person_buy_num_flag" id="person_buy_num_flag" class="checkradio" />限制</label>
                                                <label class="ml20 judgeCon2 dn"><input style="margin-left:42px;" name="person_buy_num" class="textbox for-checkbox2" type="text" /></label>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l">配送方式</strong>
                                                <label id="delivery_status1" class="ml20 dn">自提</label>
                                                <p id="delivery_status2" class="span l">
                                                    <label class="ml20">
                                                        <input type="checkbox" name="delivery_flag[]" id="delivery_flag1" value="0" class="checkradio" />自提</label>&nbsp;&nbsp;&nbsp;
                                                <!--label class="ml20"><input type="checkbox" name="delivery_flag[]" id="delivery_flag2" value="1" class="checkradio" />物流</label-->
                                                </p>
                                            </li>
                                        </ul>
                                        <ul id="codeInfo" class="dn">
                                            <li class="fn">
                                                <strong class="strong l mr20">彩信标题</strong>
                                                <div class="l">
                                                	<input name="mms_title" id="mms_title" class="textbox" style="width:338px;" type="text" onkeyup="check_lenght(10,'title_text',this);" />
                                                <br>
                                                <p class="font-12-cc" id="title_text">还可以输入10个字</p>
                                                </div>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l mr20">彩信内容</strong>
                                                <div class="l">
                                                <textarea class="textbox" name="mms_info" id="mms_info" onkeyup="check_lenght(100,'mms_info_text',this);" style="width:338px; height:120px;"></textarea>
                                                <br>
                                                <span class="font-12-cc" id="mms_info_text">还可以输入100个字</span>
                                                <p class="font-12-cc">,请彩信内容按照以下格式：xxx时间到xxxx地点享受xxxx服务</p>
                                                </div>
                                            </li>
                                            <li class="fn bd">
                                                <strong class="strong l">商品可兑换时间</strong>
                                                <label class="ml20"><input type="radio" name="verify_time_type" id="verify_time_type1" value="0" class="checkradio" checked="checked" />按日期</label>
                                                <label class="ml20"><input type="radio" name="verify_time_type" id="verify_time_type2" value="1" class="checkradio" />按天数</label>
                                                <div class="judgeCon-time judgeCon1">
                                                    <p>使用开始时间</p>
                                                    <input name="verify_begin_date" id="verify_begin_date" type="text" onclick="WdatePicker({minDate:'%y-%M-%d',maxDate:'#F{$dp.$D(\\'verify_end_date\\')}'});" class="textbox w90 ml5" maxlength="8" value="">
                                                    <p class="ml20">使用结束时间</p>
                                                    <input name="verify_end_date" id="verify_end_date" type="text" onclick="WdatePicker({minDate:'#F{$dp.$D(\\'verify_begin_date\\')||\\'%y-%M-%d\\'}'})" class="textbox w90 ml5" maxlength="8" value="">
                                                    <div class="cl pt5"></div>
                                                    <p class="font-12-cc">商户可以自定义验码开始的日期如："4月1号,6月1号";</p>
                                                </div>
                                                <div class="judgeCon-time judgeCon2 dn">
                                                    <p>发送商品后</p>
                                                    <input name="verify_begin_days" id="verify_begin_days" type="text" class="textbox w50 ml5" value="">&nbsp;天开始使用
                                                    <p class="ml20">发送商品后</p>
                                                    <input name="verify_end_days" id="verify_end_days" type="text" class="textbox w50 ml5" value="">&nbsp;天结束使用
                                                    <div class="cl pt5"></div>
                                                    <p class="font-12-cc">商户可以自定义验码时间，如：“发送商品后3天开始使用-发送商品后5天结束使用”</p>
                                                </div>
                                            </li>
                                         </ul>
                                         <ul>
                                            <li class="fn">
                                                <strong class="strong l">商品图片库</strong>
                                                <div class="pic l ml20">
                                                    <img src="__PUBLIC__/Image/shop/no-head.png" class="img" id="show1" data-view="src,img1,previewData" />
                                                    <input type="hidden" name="resp_img1" id="resp_img1" value="" />
                                                    <a class="btn" onclick="return uploadImg('640x320','cb_img_1');" href="javascript:void(0);">上传图片</a>
                                                </div>
                                                <div class="pic l ml20">
                                                    <img src="__PUBLIC__/Image/shop/no-head.png" class="img" id="show2" data-view="src,img2,previewData" />
                                                    <input type="hidden" name="resp_img2" id="resp_img2" value="" />
                                                    <a class="btn" onclick="return uploadImg('640x320','cb_img_2');" href="javascript:void(0);">上传图片</a>
                                                </div>
                                                <div class="pic l ml20">
                                                    <img src="__PUBLIC__/Image/shop/no-head.png" class="img" id="show3" data-view="src,img3,previewData" />
                                                    <input type="hidden" name="resp_img3" id="resp_img3" value="" />
                                                    <a class="btn" onclick="return uploadImg('640x320','cb_img_3')" href="javascript:void(0);">上传图片</a>
                                                </div>
                                                <p class="tips">最多上传3张图片</p>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l mr20">商品描述</strong>
                                                <div class="l">
                                                <textarea name="goods_desc" id="goods_desc" class="textbox" style="width:338px; height:120px;" data-view="val,desc,previewData" onkeyup="check_lenght(200,'goods_desc_text',this);"></textarea>
                                                <br>
                                                <p class="font-12-cc" id="goods_desc_text">还可以输入200个字</p>
                                                </div>
                                            </li>
                                            <li class="fn">
                                                <strong class="strong l">商品描述详情</strong>
                                                <div class="ueditorDiv ml20" id="wap_tip">
                                                	<textarea name="wap_info" id="wap_info" data-view="val,info,previewData" >{$goodsInfoEx.wap_info}</textarea>
                                                </div>
                                            </li>
                                            <!--li class="fn bd">
                                                <strong class="strong l">关联商品</strong>
                                                <div class="re-good">
                                                    <div id="div_rgoods">
                                                    </div>
                                                    <a id="add_relationgoods" class="a-more mt10" href="javascript:void(0)">+　添加关联商品</a>
                                                    <p class="tips" style="margin-left:0;">最多关联8个商品</p>
                                                </div>
                                            </li-->
                                        </ul>
                                        <div class="tc fn">
                                            <a href="javascript:;" id="btn_preview" class="btn-all-del w80">预览</a>
                                            <a href="javascript:void(0)" class="btn-all w80 ml10" id="smb">确定</a>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="rgoods_ids" id="rgoods_ids" value="" />
                                </form>
                            </div>

                            <div class="edit-area dn" id="div_success">
                                <div class="fn">
                                    <div class="pop-up fn mt40">
                                            <dd class="pop-img tc pt40"><img src="__PUBLIC__/Image/ok_img.png" width="46" height="46" class="mr30" style="vertical-align:middle;">添加成功！</dd>
                                            <dd class="pop-hint"></dd>
                                            <dd class="pop-btn tc mt40">
                                                <a href="{:U('index')}" class="btn-all w110 mr10">返回列表</a>
                                                <a class="btn-all w110 mr10" href="{:U('putOn')}">继续添加</a>                           
                                            </dd>
                                    </div>
                               </div>
                            </div>
                        </div>
                    </div>
        </div>
    </div>
<include file="./Home/Tpl/Public/Public_footer.html" />
</body>
</html>

<script>
var _check_class_arr = {
    goods_id : 'validate[required]'
    ,begin_date : 'validate[required,funcCall[fc_begin_date]]'
    ,end_date : 'validate[required,funcCall[fc_end_date]]'
    ,batch_amt : 'validate[custom[number],min[0],required]'
    ,market_price : 'validate[custom[number],min[0],required]'
    // ,storage_num : 'validate[custom[number],min[0],condRequired[storage_type]]'
    ,day_buy_num : 'validate[custom[number],min[0],condRequired[day_buy_num_flag]]'
    ,person_buy_num : 'validate[custom[number],min[0],condRequired[person_buy_num_flag]]'
    ,goods_desc : 'validate[required,maxSize[200]]'
    // ,wap_info : 'validate[required]'
};
var _codeInfo_check_class_arr = {
    mms_title : 'validate[required,maxSize[10],condRequired[delivery_flag1]]'
    ,mms_info : 'validate[required,maxSize[100],condRequired[delivery_flag1]]'
    ,verify_begin_date : 'validate[condRequired[verify_time_type1]]'
    ,verify_end_date : 'validate[condRequired[verify_time_type1]]'
    ,verify_begin_days : 'validate[condRequired[verify_time_type2]]'
    ,verify_end_days : 'validate[condRequired[verify_time_type2]]'
};
var _rgoods_list = [];
var _goods_info = {};
function _setformcheck(){
    for(d in _check_class_arr)
        $('#'+d).addClass(_check_class_arr[d]);
}

$.fn.remove_vacls = function(){
    var arr = $(this).attr('class').split(' ');
    for(i = 0; i < arr.length; i++){
        if(arr[i].indexOf('validate[') == 0)
            $(this).removeClass(arr[i]);
    }
    if(arguments.length == 1)
        $(this).addClass(arguments[0]);

    return true;
}

function cb_setGoodsInfo(data){
    _goods_info = data;
    art.dialog.list['selectjp'].close();
    $('#goods_name').html(data.goods_name);
    $('#goods_desc').html(data.goods_desc);
    $('#mms_title').val(data.mms_title);
    $('#mms_info').val(data.mms_text);
    $('#goods_image').attr('src', data.goods_image_url);
    $('#goods_id').val(data.goods_id);

    $('#mms_title, #mms_info, #goods_desc').trigger('keyup');
    //不限库存
    if(data.storage_type == '0'){
        $('#goods_storage').html('不限');
        $('#storage_num').remove_vacls();
        $(':radio[name="storage_type"]').removeAttr('disabled');
        $(':radio[name="storage_type"][value="0"]').attr('checked', 'checked').trigger('click');
    }
    //限制库存
    else{
        $('#goods_storage').html(data.remain_num);
        $(':radio[name="storage_type"][value="0"]').attr('disabled', 'disabled');
        $(':radio[name="storage_type"][value="1"]').attr('checked', 'checked').trigger('click');
        $('#storage_num').remove_vacls('validate[custom[number],max['+data.remain_num+'],condRequired[storage_type]]');
    }

    
    if(data.goods_type != '6'){
        $('#delivery_status1').show();
        $('#delivery_status2').hide();
        $(':checkbox[name="delivery_flag[]"][value="0"]').attr('checked', 'checked');
        $(':checkbox[name="delivery_flag[]"][value="1"]').removeAttr('checked');
    }else{
        $('#delivery_status1').hide();
        $('#delivery_status2').show();
        $(':checkbox[name="delivery_flag[]"]').removeAttr('checked');
    }
    $('#delivery_flag1').trigger('click').trigger('change').attr('readonly', 'readonly');

    $('.goods_info').show();
    $('#step2').show();
    $('#nav_step2').addClass('hover');
    windowheight();
}

function uploadImg(cropPresets,callback) {
    var opt = {
        cropPresets:cropPresets,
        callback:callback
    };
    open_img_uploader(opt);

}

/*获取图片路径中的图片名*/
function base_name(url){
    var urlList = url.split('/'); 
    var a = urlList[urlList.length-1];
    return a;
}

function cb_img_1(data){cb_img(1, data); }
function cb_img_2(data){cb_img(2, data); }
function cb_img_3(data){cb_img(3, data); }

function cb_img(n, data){
    //填充缩略图
    $('#show'+n).attr('src', data.src).show();
    //上传用
    $('#resp_img'+n).val(data.savename);
}


function subform(ue){
    var dialog;
    var type = $("input[name='type']:checked").val();
    if($("#theform").validationEngine('validate')){
        if(!ue.getContent()){
            $('#wap_tip').validationEngine('showPrompt', '不能为空','error','topRight',true);
            return false;
        }else{
            $('#wap_tip').validationEngine('hide');
        }

        $('#rgoods_ids').val(cb_rgoodsinit().join(','));
        $("#theform").ajaxSubmit({
            beforeSubmit:function(){
                dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
            },
            success:function(data){
                 if(data.status == '1'){
                       all_art_close();
                       $('#div_content').hide();
                       $('#div_success').show();
                       windowheight();
                       return false;
                  }else{
                       dialog.time(5).content("<div class='msg-all-error'>"+data.info+"</div>");
                  }
            },
            dataType:'json'
        });
        return false;
    }   
}

function fc_begin_date(){
    var purchase_time_limit = $(':radio[name="purchase_time_limit"][checked]').val() == '1';
    var reg = purchase_time_limit ? /^(\d{4})\-(\d{2})\-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/ : /^(\d{4})\-(\d{2})\-(\d{2})$/;
    var val = $('#begin_date').val();
    if(val != '' && !reg.test(val))
        return '格式错误！';
}

function fc_end_date(){
    var purchase_time_limit = $(':radio[name="purchase_time_limit"][checked]').val() == '1';
    var reg = purchase_time_limit ? /^(\d{4})\-(\d{2})\-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/ : /^(\d{4})\-(\d{2})\-(\d{2})$/;
    var val = $('#end_date').val();
    console.log(reg);
    console.log(val);
    if(val != '' && !reg.test(val))
        return '格式错误！';
}

$(document).ready(function(e) {
    _setformcheck();

    var ue = UE.getEditor('wap_info',{
        imageUrl:"{:U('LabelAdmin/Upfile/editoImageSave')}",
        imagePath:"__UPLOAD__",
        catcherUrl:"{:U('LabelAdmin/Upfile/getRemoteImage')}",
        catcherPath:"__UPLOAD__",
        initialFrameWidth:340,
        initialFrameHeight:280
    });



	//预览用
	$("#btn_preview").click(function(){
        
        if(!$("#theform").validationEngine('validate'))
            return false;

        ue.sync();
        if(!ue.getContent()){
            $('#wap_tip').validationEngine('showPrompt', '不能为空','error','topRight',true);
            return false;
        }else{
            $('#wap_tip').validationEngine('hide');
        }

		art.dialog.open("{:U('putOnPreview')}",{
			title:false,
			lock:true,
			padding:"0 0 0 2px",
			fixed:true,
			width:"350px",
			height:"625px",
			cancel:true,
			ok:function(){
                //手动提交需要手动同步编辑器数据
                ue.sync();
				subform(ue);
                return false;
			}
		});
	})

    $('#smb').click(function(){
        //手动提交需要手动同步编辑器数据
        ue.sync();
        subform(ue);
    });
	
	//新建分组
	$(".new-btn").click(function(){
		var html=[
			'<form method="post" action="">',
					'<div class="addlist-con">',
						'<div class="fn">',
						'<p class="l">*分组名称:</p><div><input type="text" name="new_classifyName" id="new_classifyName" class="shoplist-input" /></div>',
						'</div>',
						'<div class="fn mt20">',
						// '<p class="l">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*排序:</p><div><input type="text" name="new_classifySort" id="new_classifySort" class="shoplist-input w50" value="'+length+'" /></div>',
						'</div>',
					'</div>',
			'</form>'].join('');
        
		art.dialog({
			title: '添加分组',
            id: 'new_classify',
			content: html,
			fixed:true,
			lock:true,
			width:240,
			okVal: '确认',
			ok: function () {
                var dialog;
                dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
                var req_data = {
                    name: $('#new_classifyName').val()
                }
                //dialog.time(2).content("<div class='msg-all-succeed'>正在提交</div>");
				$.post('{:U('ClassifyAdd')}', req_data, function(data){
                    
                    if(data.status == '1'){
                        dialog.time(1).content("<div class='msg-all-succeed'>"+data.info+"</div>");
                        $('#classify')
                            .append('<option value="'+data.data.id+'">'+$('#new_classifyName').val()+'</option>')
                            .val(data.data.id);
                        setTimeout(function(){
                            art.dialog.list['new_classify'].close();
                        }, 1000);
                    }
                    else{
                        dialog.time(2).content("<div class='msg-all-error'>"+data.info+"</div>");
                    }
                }, 'json');
                return false;
			},
			cancel: true
		});	
	})
	
	
	//单选限制与不限制
	$(".checkradio").click(function(){
		var val = $(this).val();
		var forbox = $(this).closest("li").find(".judgeCon1");
		if(val==0){
			if(forbox.length==1){
				forbox.show();
			}
			$(this).closest("li").find(".judgeCon2").hide();
		}else{
			if(forbox.length==1){
				forbox.hide();
			}
			$(this).closest("li").find(".judgeCon2").show();
		}
	})

    //配送方式变更
    $('#delivery_flag1').change(function(){
        
        if(!this.checked){
            for(d in _codeInfo_check_class_arr)
                $('#'+d).removeClass(_codeInfo_check_class_arr[d]);

            $('#codeInfo').show('slow');
        }
        else{
            for(d in _codeInfo_check_class_arr)
                $('#'+d).addClass(_codeInfo_check_class_arr[d]);

            $('#codeInfo').show('slow');
        }
    });

    $('#bind_cj,#bind_cj2').click(function(){
        var url = '', title = '';
        if(this.id == 'bind_cj2'){
			url = '{:U('Common/SelectJp/index',array('callback'=>'cb_setGoodsInfo','show_source'=>'0,1,2,4'))}';
            title = '';
        }else{
            url = '{:U('Common/SelectJp/index',array('goods_type'=>'6','callback'=>'cb_setGoodsInfo'))}';
        }
        art.dialog.open(url,{
            width: 800,
            height: 700,
            title:'选择商品',
            lock: true,
            id: 'selectjp'
        })
    });

    //
    $('#add_relationgoods').click(function(){
       art.dialog.open("{:U('SelectRgoods',array('cb_init'=>'cb_rgoodsinit', 'cb_rgoodsadd'=>'cb_rgoodsadd', 'cb_rgoodsdel'=>'cb_rgoodsdel'))}",{
            width: 800,
            height: 500,
            title:'选择商品',
            lock: true,
            id: 'selectjp'
        }) 
    });
    $(':radio[name="purchase_time_limit"]').change(function(){
        var limit_flag = this.value == '1', cls = !limit_flag ? 'w90': 'w150', maxlength = !limit_flag ? 10: 19;
        var begin_date = $('#begin_date').val();
        var end_date = $('#end_date').val();
        $('#begin_date, #end_date').removeClass('w90').removeClass('w150').addClass(cls).attr('maxlength', maxlength);
        if(limit_flag){
            if(begin_date != '') $('#begin_date').val(begin_date+' 00:00:00');
            if(end_date != '') $('#end_date').val(end_date+' 23:59:59');
        }
        else{
            if(begin_date != '') $('#begin_date').val(begin_date.substr(0, 10));
            if(end_date != '') $('#end_date').val(end_date.substr(0, 10));
        }
    });

    $('#begin_date').click(function(){
        var purchase_time_limit = $(':radio[name="purchase_time_limit"][checked]').val();
        var opt = {};
        if(purchase_time_limit == '0'){
            opt.dateFmt = 'yyyy-MM-dd';
            opt.startDate = '%y-%m-%d';
            // opt.maxDate = "#F{$dp.$D('end_date')}";
            // opt.minDate = '%y-%M-%d';
        }
        else{
            opt.dateFmt = 'yyyy-MM-dd HH:mm:ss';
            opt.startDate = '%y-%m-%d 00:00:00';
            // opt.minDate = '%y-%M-%d %H:%m:%s';
        }
        WdatePicker(opt);
    });
    $('#end_date').click(function(){
        var purchase_time_limit = $(':radio[name="purchase_time_limit"][checked]').val();
        var opt = {minDate:"#F{$dp.$D('begin_date')}"};
        if(purchase_time_limit == '0'){
            opt.dateFmt = 'yyyy-MM-dd';
            opt.startDate = '%y-%m-%d';
        }
        else{
            opt.dateFmt = 'yyyy-MM-dd HH:mm:ss';
            opt.startDate = '%y-%m-%d 23:59:59';
        }
        WdatePicker(opt)
    });

    // $('#delivery_flag1').trigger('click').attr('readonly', 'readonly');
});


function refresh_rgoods(){
    var html = '', i=1
    for(k=0; k<_rgoods_list.length; k++){
        var id = _rgoods_list[k].id
        var name = _rgoods_list[k].goods_name
        var image = _rgoods_list[k].goods_image
        html += '<p data-val="'+id+'">关联商品'+i+'.　<a href="javascript:void(0)" data-view="text,otherdata'+i+',previewData">'+name+'</a><i class="icon-delother" onclick="rgoods_delete('+id+')"></i><img src="'+image+'" class="dn" data-view="src,otherimg'+i+',previewData" /></p>';
        i++;
    }
    $('#div_rgoods').html(html);
    windowheight();
}
function rgoods_delete(id){
    for(i = 0; i < _rgoods_list.length; i++){
        if(_rgoods_list[i].id == id){
            _rgoods_list.remove(i)
            refresh_rgoods()
            break;
        }
    }
}
function cb_rgoodsinit(){
    var arr = [];
    for(i = 0; i<_rgoods_list.length; i++)
        arr.push(_rgoods_list[i].id);
    return arr;
}
function cb_rgoodsadd(data){
    _rgoods_list.push(data)
    refresh_rgoods()
    return cb_rgoodsinit()
}
function cb_rgoodsdel(data){
    for(i=0; i<_rgoods_list.length; i++){
        if(_rgoods_list[i].id == data.id){
            _rgoods_list.remove(i)
            refresh_rgoods()
            break;
        }
    }

    return cb_rgoodsinit();
}
</script>