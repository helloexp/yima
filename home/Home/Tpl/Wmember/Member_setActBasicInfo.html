<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>会员管理-招募活动创建-基础信息</title>
<meta name="Keywords" content="{:C('SITE_KEYWORDS')}" />
<link href="__PUBLIC__/Css/main.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/layout.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/module.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wcanal.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wnumgoods.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Waccount.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wshop.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wshopconfig.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Css/Wmember.css?v=__VR__" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Js/validationEngine/css/validationEngine.jquery.css?v=__VR__" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="__PUBLIC__/Js/jquery-1.8.2.min.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/Wcanal.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/global.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/jquery.artDialog.js?skin=default"></script>
<script type="text/javascript" src="__PUBLIC__/Js/artDialog4.1.6/plugins/iframeTools.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery-ui-1.11.2.custom/jquery-ui.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery-ui-1.11.2.custom/template.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/ajaxfileupload.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC__/Js/validationEngine/languages/jquery.validationEngine-zh_CN.js?v=__VR__" ></script>
<script type="text/javascript" src="__PUBLIC__/Js/validationEngine/jquery.validationEngine.js?v=__VR__" ></script>
<script type="text/javascript" src="__PUBLIC__/Js/jquery.form.js?v=__VR__"></script>
<script type="text/javascript" src="__PUBLIC_LOCAL__/Js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript">
    var customFields = eval({$customFields});
    var memberItemCon = 0;
    var createdCustomNum = {$createdCustomNum};
    $(function(){
	Gform();
	$('#save').click(function(){
            if($("#theform").validationEngine('validate')){
                $("#theform").ajaxSubmit({
                    beforeSubmit:function(){
                        if (!$("input[name=join_mode]").val()) {
                            dialog = art.dialog({title:false,content:"<div class='msg-all-error'>请选择参与方式</div>",fixed: true,padding:0});
                            dialog.time(2);
                            return false;
                        }
                        dialog = art.dialog({title:false,content:"<div class='msg-all-succeed'>正在提交...</div>",fixed: true,padding:0});
                    },
                    success:function(data){
                        if (data.status == '1'){
                            dialog.close();
                            if (data.info.isReEdit == '1') {
                                window.location.href="{:U('Wmember/Member/recruit')}";
                            } else {
                                window.location.href="{:U('Wmember/Member/setPrize')}&m_id="+data.info.m_id+"&isReEdit=0";
                            }
                        } else {
                            dialog.time(2).content("<div class='msg-all-error'>"+data.info+"</div>");
                            setTimeout(function(){
                                window.location.href = data.url.现在跳转; 
                            },1000);   
                        }
                    },
                    url:"{:U('Wmember/Member/setActConfig')}",
                    dataType:'json'
                });
                return false;
            }
	});
    });
</script>
<script type="text/javascript">
    var clickMb1 = function(e) {
        $("#tp2 .mb1").removeClass("current");
        $(this).addClass("current");
        var bgimg=$(this).children("img").attr("src");
        $(".selected").css("background-image","url(" + bgimg + ")");
        $('#bg_img').val(bgimg);
        var index = $(this).index() + 1;
        $('#bg_style').val(index);
    }
    
    $(function(){
	  $("#tp1 .mb1").click(function(e) {
            $("#tp1 .mb1").removeClass("current");
            $(this).addClass("current");
            var id = $(this).attr('id');
            id = id.substr(2);
            $('#template').val(id);
			
			
        });
		
	$("#tp2 .mb1").click(clickMb1);
        
	$("#mb1").click(function(e) {
            $("#phoneCon").fadeIn(300);
            $("#phoneCon").addClass("selected");
            $("#phoneCon_two").fadeOut(300);
            $("#phoneCon_two").removeClass("selected");
            $("#tp2 .mb1").each(function(){
                if($(this).hasClass("current")){
                    var bj=$(this).children("img").attr("src");
                    $(".selected").css("background-image","url(" + bj + ")");
                }
            });
        });
	
	$("#mb2").click(function(e) {
            $("#phoneCon_two").fadeIn(300);
            $("#phoneCon_two").addClass("selected");
            $("#phoneCon").fadeOut(300);
            $("#phoneCon").removeClass("selected");
            $("#tp2 .mb1").each(function(){
                if($(this).hasClass("current")){
                    var bj=$(this).children("img").attr("src");
                    $(".selected").css("background-image","url(" + bj + ")");

                }
            });
        });
    });
    
    function add(){
        var opt = {
            cropPresets:'640x340',
            callback:uploadCallback
        };
        open_img_uploader(opt);
    }
    
    function uploadCallback(data){
        //显示预览
        if ($('#tp2 .Ginput .mb1').length == 2) {
            $('#tp2 .Ginput .mb1:eq(1)').after('<div class="mb1 fl"><img src="'+data.src+'" width="100"></div>');
        } else {
            $('#tp2 .Ginput .mb1:eq(2)').replaceWith('<div class="mb1 fl"><img src="'+data.src+'" width="100"></div>');
        }
        $("#tp2 .mb1").click(clickMb1);
        $('#tp2 .mb1:eq(2)').click();
    }


    function getval(){
	$('.m-bind-box').html('');
	var act_name=$(".act_name").val(); 
	var node_name=$(".node_name").val(); 
    var button_name=$(".button_name").val(); 
	var introduce=$(".introduce").val().replace(/</g, '&lt;').replace(/>/g, '&gt;'); 
	var introduce_html ='<pre style="color:#999999;font-size:12px;font-family:microsoft yahei;">'+introduce+'</pre>';
	//var node_logo=$(".node_logo").val(); 
	$('.member_title').text(node_name);
	$('.member_hd_name').text(act_name);
	$('.m-btn').text(button_name);
	$('.member_hd_desc .text-introduce').html(introduce_html);
	//$('.member_logo img').attr('src',node_logo);
        var Gname1= $('.collect_sz ul .Gname');
	for(var i=0;i<Gname1.length;i++){
            var texts = Gname1.eq(i).text();
            var html='<div class="m-input"><p class="tit">'+texts+'</p><p class="cont"><input type="text" class="input" name="org_number" placeholder="请输入您的'+texts+'" maxlength="15"></p></div>';
            $('.m-bind-box').append(html);
        }
	var sex = ' <nav class="segmented-control"><input type="radio" name="sc-2" id="sc-2-1"  /><input type="radio" name="sc-2" id="sc-2-2" checked="checked" /><label for="sc-2-1" data-value="男">男</label><label for="sc-2-2" data-value="女">女</label></nav>';
	var myarea ='<select name="province"><option value="">选择省</option></select><select name="city"><option value="">选择市</option></select>';
	var removediv = $('.m-input').children('.tit');
	for(var j=0;j<removediv.length;j++){
            var sexremove =removediv.eq(j);
            if(sexremove.text() == '性别'){
                sexremove.next('.cont').html(sex);
            }
            if(sexremove.text()=='所在区域'){
              sexremove.next('.cont').html(myarea);
            } 
	}
    }
    
    function artVal(){
        $('#newRadio .newRadio').html('');
        $.each(customFields,function(key, value){
            var hm = '<span id="'+key+'"data-val="'+key+'">'+value['text']+'</span>';
            $('#newRadio .newRadio').append(hm);
        });
        var artgname= $('.collect_sz ul .Gname');
        for(var k=0;k<artgname.length;k++){
            $('#'+artgname.eq(k).attr('rel')).addClass('hover');
        }
        //点击已有勾选/不勾选
        $("#newRadio .newRadio span").click(function(){
		  var span_name=$(this).attr('data-val');
		  if(span_name!='member_tel'){
			 $(this).toggleClass("hover");
          }	 
		 });		
    }
	
    function addVal(){
        $('.allready_has span').each(function(data){
            if($(this).hasClass('hover')){
                var name = $(this).attr('data-val');
                var nameValue = $('input[name='+name+']').val();
                if(nameValue == undefined){
                    var ul_cj ='<ul class="rank_area"> <li class="Gname" rel="'+name+'">'+$(this).text()+'</li><li class="Ginput"><div class="switch">';
                    ul_cj+='<input type="radio" name="'+name+'" value="" checked="checked"/><div class="newRadio">';
                    ul_cj+='<span class="valfirst" data-val="1">必填</span><span class="vallast hover" data-val="0">选填</span>';
                    ul_cj+='</div></div></li><i class="member-del" title="删除"></i></ul>';
                }
            }
            $("#add_collect").before(ul_cj);
        });
    }
	
   $(function(){
        getval();
        $(".member-del").live('click',function(){
            $(this).closest(".collect_sz ul").remove();
            getval();
	});						  
	$(".com_val").live("input propertychange",function(){
            getval();
        });
    })
</script>
</head>
<body>
    <div id="wrapper"> 
        <include file="./Home/Tpl/Public/Public_header.html" />
        <div id="container" class="bgfff"> 
            <div id="main" class="rel">
            	<div class="member_con">
                    {$stepBar}
                    <div class="member_l" style="min-height:1050px;">
                        <div id="phone">
                            <div class="phonetop"></div>
                            <div id="phoneCon" class="selected">
                                <div class="member_logo"><img src="{$node_logo}" class="Gshow-img"/></div>
                                <div class="member_title">商户名称</div>
                                <div class="member_hd_name">活动标题</div>
                                <form  method="post">
                                    <div class="m-bind">
                                    	<input type="hidden" name="wx_bd" value="{$wx_bd}">
                                        <input type="hidden" name="charge_type" value="0" />
                                        <div class="m-bind-box"></div>
                                        <a class="m-btn" href="javascript:void(0);" id="sub_button">提&nbsp;&nbsp;交</a>
                                    </div>
                                </form>
                                <div class="member_hd_desc">
                                    <dl>
                                        <dt>活动说明：</dt>
                                        <dd class="text-introduce"></dd>
                                    </dl>
                                </div>
                            </div>
							<div id="phoneCon_two" class="dn">
                                <div class="member_logo" style="float:left"><img src="{$node_logo}" class="Gshow-img"/></div>
                                <div class="member_title" style="float:left;margin-top:112px;">商户名称</div>
								<div class="cl"></div>
                                <div class="member_hd_name">活动标题</div>
                                <form  method="post">
                                    <div class="m-bind">
                                    	<input type="hidden" name="wx_bd" value="{$wx_bd}">
                                        <input type="hidden" name="charge_type" value="0" />
                                        <div class="m-bind-box"></div>
                                        <a class="m-btn" href="javascript:void(0);" id="sub_button">提&nbsp;&nbsp;交</a>
                                    </div>
                                </form>
                                <div class="member_hd_desc">
                                    <dl>
                                        <dt>活动说明：</dt>
                                        <dd class="text-introduce"></dd>
                                    </dl>
                                </div>
                            </div> 
                        </div>
                    </div>
                    <div class="member_r">
                    	<form action="" method="POST" name="theform" id="theform" enctype="multipart/form-data">
                            <input type="hidden" id="m_id" name="m_id" value="{$m_id}" />
                            <input type="hidden" id="template" name="template" value='<notempty name="template">{$template}<else />1</notempty>' />
                            <input type="hidden" id="bg_img" name="bg_img" value='<notempty name="bg_img">{$bg_img}<else />__PUBLIC__/Image/member/mb_top_bg1.png</notempty>' />
                            <input type="hidden" id="bg_style" name="bg_style" value='<notempty name="bg_style">{$bg_style}<else />1</notempty>' />
                            <input type="hidden" id="isReEdit" name="isReEdit" value="{$isReEdit}" />
                            <h3>基础信息</h3>
                            <div class="Gform l w1">
                                <ul>
                                    <li class="Gname"><span class="red">*</span>&nbsp;活动标题</li>
                                    <li class="Ginput">
                                        <input type="text" maxlength="20" class="Gview-text com_val act_name validate[required,optional,maxSize[20]]" name="act_name" placeholder='活动标题' value="{$act_name}" />
                                        <span class="maxTips forInput" data-max="20">0/20</span>
                                    </li>
                                </ul>
                                <ul>
                                    <li class="Gname"><span class="red">*</span>&nbsp;活动时间</li>
                                    <li class="Ginput">
                                    <div class="Gtime2 fn">
                                        <input type="text"  class="validate[required]" onclick="WdatePicker({maxDate:'#F{$dp.$D(\\'act_time_to\\')}',dateFmt:'yyyyMMdd'})" name="act_time_from"  id="act_time_from" value="{$act_time_from}" >
                                        <em>至</em>
                                        <input type="text" class="validate[required]" onclick="WdatePicker({minDate:'#F{$dp.$D(\\'act_time_from\\')}',dateFmt:'yyyyMMdd'})" name="act_time_to" id="act_time_to" value="{$act_time_to}">
                                    </div>
                                    </li>
                                </ul>
							
                                <ul>
                                    <li class="Gname">参与方式</li>
                                    <li class="Ginput">
                                        <div class="switch" data-show="wxcode">
                                            <input type="radio" name="join_mode" value="{$join_mode}" checked="checked"/>
                                            <div class="newRadio openOrder" id="join_mode_radio_div" >
                                                <if condition="$join_mode eq 1">
                                                    <span class="valfirst" data-val="0">手机号码</span>
                                                    <span class="vallast hover" data-val="1">微信号</span>
                                                <else />
                                                    <span class="valfirst hover" data-val="0">手机号码</span>
                                                    <span class="vallast" data-val="1">微信号</span>
                                                </if>
                                            </div>
                                            <div class="cl"></div>
                                            <div class="newRadio-default fn">
                                                <div class="switch">
                                                    <span class="txtTips">
                                                        <if condition="$join_mode neq '1' ">不限制打开方式<else />只能在微信中打开</if>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="newRadio-input">
                                            <div class="switch">
                                                <span class="txtTips">
                                                    <if condition="$join_mode neq '1' ">只能在微信中打开<else />不限制打开方式</if>
                                                </span>
                                            </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                <div id="wxcode" <if condition="$join_mode neq '1' "> class="dn" </if>>
                                    <ul>
                                        <li class="Gnmae">微信授权</li>
                                        <li class="Ginput">
                                        <div class="switch" data-show="ymempower">
                                            <input type="radio" name="WeChat" id="WeChat" value="{$configData['wx_auth_type']}" checked="checked" />
                                            <div class="newRadio">
                                                <if condition="$configData['wx_auth_type'] eq '1' ">
                                                    <span class="valfirst" data-val="0">翼码代授权</span>
                                                    <span class="vallast hover" data-val="1">自有服务号</span>
                                                <else />
                                                    <span class="valfirst hover" data-val="0">翼码代授权</span>
                                                    <span class="vallast" data-val="1">自有服务号</span>
                                                </if>
                                            </div>
                                            <div class="cl"></div>
                                                <div class="newRadio-default fn">
                                                    <div class="switch">
                                                        <span class="txtTips">
                                                            <if condition="$configData['wx_auth_type'] eq '1' ">
                                                                绑定已认证微信服务号到旺财后，此设置才能生效
                                                            <else />
                                                                由翼码提供代授权服务，获取用户的微信信息，如昵称、头像
                                                            </if>
                                                        </span>
                                                    </div>
                                                </div>
                                            <div class="newRadio-input">
                                                <div class="switch">
                                                    <span class="txtTips">
                                                        <if condition="$configData['wx_auth_type'] eq '1' ">
                                                            由翼码提供代授权服务，获取用户的微信信息，如昵称、头像
                                                        <else />
                                                            绑定已认证微信服务号到旺财后，此设置才能生效
                                                        </if>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        </li>
                                    </ul>
                                    <ul id="ymempower" class=""<if condition="$configData['wx_auth_type'] neq '1'"> style="display:none"</if>>
                                        <li class="Gname">关注引导</li>
                                        <li class="Ginput">
                                            <input type="text" name="care_guide" value="{$configData['wx_auth_url']}" placeholder="请输入关注引导页的地址" />
                                            <span class="txtTips">非微信粉丝访问活动页面时，将被引导至此页面<br><a href="http://www.wangcaio2o.com/index.php?g=Home&m=Help&a=helpDetails&newsId=1333" target="_blank">如何获得微信公众号关注引导页地址</a></span>
                                        </li>
                                    </ul>
                                </div>
							
                                <ul>
                                    <li class="Gname"><span class="red">*</span>&nbsp;所属会员卡</li>
                                    <li class="Ginput">
                                        <select name="belong_card" id="belong_card" class="validate[required]">
                                            <option value="">请选择</option>
                                            <volist name='cardList' id='card'>
                                                <option value="{$card['id']}" <?php if($memberCard_id == $card['id']) {echo "selected='selected'";} ?>>{$card['card_name']}</option>
                                            </volist>
                                        </select>
										<span class="txtTips">参与该活动的消费者，将获得指定会员卡</span>
                                    </li>
                                </ul>
                            </div>
                        <div class="cl"></div>
                        <h3>界面设计</h3>
                        <div class="Gform l">
                            <ul>
                                <li class="Gname">商户名称</li>
                                <li class="Ginput">
                                    <input type="text" maxlength="20" class="Gview-text com_val node_name validate[required]" value="商户名称" name="node_name">
                                </li>
                            </ul>
                            <ul>
                                <li class="Gname">商户logo</li>
                                <li class="Ginput">
                                    <div class="Gchoose Gview-img" >
                                        <input type="text" value="{$node_logo}" name="node_logo" class="node_logo">
                                        <a href="javascript:void(0)" class="Gbtn-pic" title="选择图片" data-rel="{width:160,height:160}"><i></i></a>
                                    </div>
                                </li>
                            </ul>
                            <ul id="tp1">
                                <li class="Gname">页面模板</li>
                                <li class="Ginput">
                                    <div class='mb1 fl <if condition="empty($template) or ($template eq 1)">current</if>' id="mb1"><img src="__PUBLIC__/Image/member/mb_1.png" width="100"></div>
                                    <div class='mb1 fl <eq name="template" value="2">current</eq>' id="mb2"><img src="__PUBLIC__/Image/member/mb_2.png" width="100"></div> 
                                </li>
                            </ul>
                            <ul id="tp2">
                                <li class="Gname">背景</li>
                                <li class="Ginput">
                                    <div class='mb1 fl <if condition="empty($bg_style) or ($bg_style eq 1)">current</if>'><img src="__PUBLIC__/Image/member/mb_top_bg1.png" width="100"></div> 
                                    <div class='mb1 fl <eq name="bg_style" value="2">current</eq>'><img src="__PUBLIC__/Image/member/mb_top_bg2.png" width="100"></div>
                                    <eq name="bg_style" value="3"><div class="mb1 fl current"><img src="{$bg_img}" width="100"></div></eq>
                                    <div class="add_set_bg" onclick="add()"></div> 
                                </li>
                            </ul>
                            <ul>
                               <li class="Gname">按钮文字</li>
                               <li class="Ginput"><input type="text" maxlength="8" name="button_name"  class="button_name com_val" placeholder='提交' value="{$configData['button_name']}">
                               <span class="maxTips forInput" data-max="8">0/8</span>
                               </li>
                            </ul>
						
                            <ul>
                                <li class="Gname"><span class="red">*</span>&nbsp;活动说明</li>
                                <li class="Ginput">
                                    <textarea maxlength="140" class="Gview-textarea introduce com_val validate[required]" name="introduce" style="resize:none;" placeholder="">{$introduce}</textarea>
                                    <span class="maxTips forArea" data-max="140">0/140</span>
                                </li>
                            </ul>
                         </div>
                    
                        <div class="cl"></div>
                        <h3>采集项设置</h3>
                        <div class="sort_point"><i class="l left_ico"><img src="__PUBLIC__/Image/member_ico1.png"></i>拖动以下配置项，可以更改排序。<i class="r right_ico colse_point"><img src="__PUBLIC__/Image/member_ico2.png"></i></div>
                        <div class="Gform l collect_sz" id="collect_sz">
                            <ul>
                                <li class="Gname" rel="member_tel">手机号码</li>
                                <li class="Ginput">
                                    <div class="switch">
                                        <input type="radio" name="member_tel" value="1" checked="checked"/>
                                        <div class="newRadio">
                                            <span class="valfirst hover" data-val="1">必填</span>
                                        </div>
                                    </div>
                                    <span class="txtTips" style="color:#ed3f41">手机号码默认显示，不可编辑，不可更改排序</span>
                                </li>
                            </ul>
                            <if condition="$isReEdit eq '1' ">
                                <volist name='setedSustomFields' id='existCustomField'>
                                    <ul class="rank_area">
                                        <li class="Gname" rel="{$existCustomField['name']}">{$existCustomField['text']}</li>
                                        <li class="Ginput">
                                            <div class="switch">
                                                <input type="radio" name="{$existCustomField['name']}" value="{$existCustomField['is_required']}" checked="checked"/>
                                                <div class="newRadio">
                                                    <if condition="$existCustomField['is_required'] eq '1' ">
                                                        <span class="valfirst hover" data-val="1">必填</span>
                                                        <span class="vallast" data-val="0">选填</span>
                                                    <else />
                                                        <span class="valfirst" data-val="1">必填</span>
                                                        <span class="vallast hover" data-val="0">选填</span>
                                                    </if>
                                                </div>
                                            </div>
                                        </li>
                                        <i class="member-del" title="删除"></i>
                                    </ul>
                                </volist>
                            <else />
                                <ul class="rank_area">
                                    <li class="Gname" rel="member_name">姓名</li>
                                    <li class="Ginput">
                                        <div class="switch">
                                            <input type="radio" name="member_name" value="1" checked="checked"/>
                                            <div class="newRadio">
                                                <span class="valfirst hover" data-val="1">必填</span>
                                                <span class="vallast" data-val="0">选填</span>
                                            </div>
                                        </div>
                                    </li>
                                    <i class="member-del" title="删除"></i>
                                </ul>
                                <ul class="rank_area">
                                   <li class="Gname" rel="member_sex">性别</li>
                                   <li class="Ginput">
                                        <div class="switch">
                                            <input type="radio" name="member_sex" value="1" checked="checked"/>
                                            <div class="newRadio">
                                                <span class="valfirst hover" data-val="1">必填</span>
                                                <span class="vallast" data-val="0">选填</span>
                                            </div>
                                        </div>
                                   </li>
                                   <i class="member-del" title="删除"></i>
                                </ul>
                                <ul class="rank_area">
                                   <li class="Gname" rel="member_area">所在区域</li>
                                   <li class="Ginput">
                                        <div class="switch">
                                            <input type="radio" name="member_area" value="1" checked="checked"/>
                                            <div class="newRadio">
                                                <span class="valfirst hover" data-val="1">必填</span>
                                                <span class="vallast" data-val="0">选填</span>
                                            </div>
                                        </div>
                                   </li>
                                   <i class="member-del" title="删除"></i>
                                </ul>
                                <ul class="rank_area">
                                   <li class="Gname" rel="member_birthday">出生日期</li>
                                   <li class="Ginput">
                                        <div class="switch">
                                            <input type="radio" name="member_birthday" value="1" checked="checked"/>
                                            <div class="newRadio">
                                                <span class="valfirst hover" data-val="1">必填</span>
                                                <span class="vallast" data-val="0">选填</span>
                                            </div>
                                        </div>
                                        <i class="member-del" title="删除"></i>
                                   </li>
                                </ul>
                            </if>
                            <div id="add_collect">
                               <div class="Ginput"><a class="add_collect"><span style="font-size:18px;font-weight:700">+</span> 添加采集项</a></div>
                            </div>
                            <div class="btngp fixBtn" style="z-index:90">
                             <a href="javascript:void(0)" class="btn-all " id="save"><if condition="$m_id eq '' ">下一步<else />保存</if></a>
                        </div>
                        </div>
                    </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <include file="./Home/Tpl/Public/Public_footer.html" />
    <div class="service"></div>
        <script type="text/javascript">
            //日期初始化
            function GetDateStr(AddDayCount) {
               var dd = new Date();
               dd.setDate(dd.getDate()+AddDayCount);
               var y = String(dd.getFullYear());
               var m = dd.getMonth()+1;
               if(m <= 9){
                   m = '0'+ String(m);
               }else{
                   m = String(m);
               }
               var d = String(dd.getDate());
               if(d <= 9){
                   d = '0'+String(d)
               }else{
                   d = String(d);
               }
               return y + m + d;
            }
            var nowday=GetDateStr(0);
            
            //切换
            function show(t){
                var v = t.attr("data-val");
                $("#mshow1,#mshow2").addClass('dn');
                $("#mshow"+v).removeClass('dn');
            }
            $(function(){
                $(".colse_point").click(function(){
                    $(this).parent().remove();
                });
                //日期默认
				if($("#act_time_from").val()==""){
                   $("#act_time_from").val(nowday);
				}
                // 添加采集项弹窗  
               $("body").on("click",".add_collect",function(e){
                    var cont = '<form name ="caiji"><div class="Gform l"><ul><li class="Gname">采集项</li><li class="Ginput">';
                        cont+= '<div class="switch" data-callback="show">';
                        cont+= '<input type="radio" value="1" checked="checked"/>';
                        cont+= '<div class="newRadio openOrder" id="join_mode_radio_div" ><span class="valfirst hover" data-val="1">已有</span>';
                        cont+= '<span class="vallast" data-val="2">新建</span></div><div class="newRadio-input"><div class="switch">';
                        cont+= '<p class="txtTips">你已新建<span class="creatnum" style="color:#ed3f41;font-weight:700">'+createdCustomNum+'</span>';
                        cont+= '个，最多可以添加15个自定义采集项，请谨慎使用！</p></div></div></div>';
                        cont+= '<div id="mshow1" class="Gform" style="margin-left:-155px"><ul><li class="Gnmae"></li>';
                        cont+= '<li class="Ginput" style="padding-bottom:12px"><div class="switch auto" id="newRadio"><div class="newRadio allready_has">';
                        cont+= '</div></div></li></ul></div><div class="dn" id="mshow2" style="margin-left:-155px">';
                        cont+= '<ul><li class="Gname"><span class="red">*</span>&nbsp;采集项名称</li><li class="Ginput">';
                        cont+= '<input type="text" maxlength="6" name="collect_name" value=""><p class="txtTips">请输入会员信息采集项名称，最多6字，不可修改</p>';
                        cont+= '</li></ul><ul class="set_options"><li class="Gname"><span class="red">*</span>&nbsp;设置选项</li>';
                        cont+= '<li class="Ginput"><div class="condition-con"><div class="fn memberItem"></div><div class="Gset">';
                        cont+= '<div class="GsetPtion  js_AddPtion"><span> + 添加设置选项</span></div></div></div>';
                        cont+= '<p class="txtTips" style="padding-bottom:30px">最多可添加8个设置选项</p></li></ul></div></li></ul></div></form>';
                    art.dialog({
                        title:'添加会员信息采集项',
                        width:500,
                        content:cont,
                        padding:0,
                        okVal:'确认',
                        ok:function(){
						    var m=0;
                            if($('#mshow1').hasClass('dn')){
                                if($('input[name=collect_name]').val()==''){
                                    alert('采集项名称不能为空');
                                    return  false;	
                                }else if($(".memberItem").children(".memberItemCon").length<=0){
								  alert("请添加设置项！");
								  return false;
								}
								$(".memberItemCon .setopt1").each(function(){
									if ($(this).val() ==""){
										alert("设置项不能为空！");
										$(this).addClass('empty_input');
										m=1;
										return;
									 }
								});
								if(m==1){
								  return false;
								  $(".memberItem .empty_input:first").focus();
								}
                                var data = $('form[name=caiji]').serialize();
                                $.post("{:U('Wmember/Member/createCustomFields')}", data, function(result){
                                    result = eval("("+result+")");
                                    if(result['error'] != '0'){
                                        alert(result['msg']);
                                    }else{
                                        customFields[result['name']] = result['text'];
                                        createdCustomNum += 1;
                                        var taken='<ul class="rank_area"><li class="Gname" rel="'+result['name']+'">'+result['text']['text']+'</li><li class="Ginput"><div class="switch">';
                                        taken +='<input type="radio" name="'+result['name']+'" value="1" checked="checked"/><div class="newRadio">';
                                        taken +='<span class="valfirst hover" data-val="1">必填</span><span class="vallast" data-val="0">选填';
                                        taken +='</span></div></div></li><i class="member-edit" title="修改"></i><i class="member-del"';
                                        taken +='title="删除"></i></ul>';
                                        $("#add_collect").before(taken);
                                        getval();
                                    }
                                });
                            }else{
                                addVal();
                            }
                            getval();//2016/03/01 
                        }
                    });
                    memberItemCon = 0;
                    artVal();
                    if($('#mshow1').hasClass('dn')){
                        $('#mshow1').removeClass('dn');
                    }
                });
                
                //添加采集项弹窗中增加采集项设置
                $(".js_AddPtion").live('click',function(){
                    if(memberItemCon>8){
                        return false;
                    }else{
                        var html ='<div class="memberItemCon rel"><input type="text" maxlength="15" class="setopt1" name="setopt[]" value=""><span class="maxTips forInput" data-max="15" style="top:10px;left:225px">0/15</span><a href="javascript:void(0)" class="memberItemCon-del"><i></i></a></div>';
                        memberItemCon += 1;
                        $(".memberItem").append(html);
                        if(memberItemCon==8){
                            $(".Gset").css('display','none');
                        }
                    }
                });
                //添加采集项弹窗内部删除设置采集项
                $('body').on("click",".memberItem  .memberItemCon-del",function(){ 
                    memberItemCon -= 1;
                    $(this).parent().remove();
                    if(memberItemCon<8){
                        $(".Gset").css('display','block');
                    }
                });
				
                //修改采集项弹窗
                $(".member-edit").live("click",function(e){
                    var _this = $(this);
                    var editname=$(this).parent().find('.Gname').text();
                    var tempid=$(this).parent().attr('data-tempid');
                    var name=$(this).parent().find('.Gname').attr('rel');
                    memberItemCon = customFields[name]['value_list'].length;
                    var xgcont = '<form action="" method="post" name="modify" enctype="multipart/form-data" ><div class="Gform l">';
                    xgcont += '<ul><li class="Gname"><span class="red">*</span>&nbsp;采集项名称</li><li class="Ginput">';
                    xgcont += '<input type="text" maxlength="6" name="collect_name" id="collect_name" value="'+editname+'">';
                    xgcont += '<p class="txtTips">请输入会员信息采集项名称，最多6字，不可修改</p></li></ul><ul class="Modset_options">';
                    xgcont += '<li class="Gname"><span class="red">*</span>&nbsp;设置选项</li><li class="Ginput">';
                    xgcont += '<div class="Mod-con"><div class="fn ModifyItem" id="ModifyItem">';
                    xgcont += '<input type="hidden" name="key" value="'+name+'" />'
                    $.each(customFields[name]['value_list'], function(key, val){
					    var val_nums=val.length;
                        xgcont += '<div class="ModifyItemCon rel">';
                        xgcont += '<input type="text" maxlength="15" class="Modifyset1"  name="setopt[]" value="'+val+'">';
                        xgcont += '<span class="maxTips forInput" data-max="15" style="top:10px;left:225px">'+val_nums+'/15</span><a href="javascript:void(0)" class="ModifyItemCon-del"><i></i></a></div>'
                    });
                    xgcont += '</div><div class="Gset1"><div class="GsetPtion1  Mod_AddPtion"><span> + 添加设置选项</span></div>';
                    xgcont += '</div></div><p class="txtTips" style="padding-bottom:30px">最多可添加8个设置选项</p></li></ul>';
                    xgcont += '</div></form>'
                    art.dialog({
                        title:'修改采集项设置',
                        width:500,
                        content:xgcont,
                        padding:0,
                        okVal:'确认',
                        ok:function(){
						    var xg_name=$("#collect_name").val();
                            _this.parent().find('.Gname').text(xg_name);
						    var n=0;
						    if($('input[name=collect_name]').val()==''){
                                    alert('采集项名称不能为空');
                                    return  false;	
                                }else if($("#ModifyItem").children(".ModifyItemCon").length<=0){
								  alert("请添加设置项！");
								  return false;
								}
								$(".ModifyItemCon .Modifyset1").each(function(){
									if ($(this).val() ==""){
										alert("设置项不能为空！");
										$(this).addClass('empty_input');
										n=1;
										return;
									 }
								});
								if(n==1){
								  return false;
								  $("#ModifyItem .empty_input:first").focus();
								}
                            
                            var data = $('form[name=modify]').serialize();
                            $.post("{:U('Wmember/Member/createCustomFields')}", data, function(result){
                                result = eval("("+result+")");
                                if(result['error'] != '0'){
                                    alert(result['msg']);
                                }else{
                                    console.log(result);
                                    customFields[result['name']] = result['text'];
                                    getval();
                                }
                            });
                        }
                    });
					var modify=$("#ModifyItem").children(".ModifyItemCon").length;
					if(modify>=8){
					   $(".Gset1").css('display','none');
					 }
                    memberItemCon = 0;
                 });
			      
                //修改采集项弹窗增加采集项
                $(".Mod_AddPtion").live('click',function(){
				       var modify=$("#ModifyItem").children(".ModifyItemCon").length;
                       if(modify>=8){
					        $(".Gset1").css('display','none');
                            return false;
                       }else{
                          var html ='<div class="ModifyItemCon rel"><input type="text" maxlength="15" class="Modifyset1"  name="setopt[]" value=""><span class="maxTips forInput" data-max="15" style="top:10px;left:225px">0/15</span><a href="javascript:void(0)" class="ModifyItemCon-del"><i></i></a></div>';
                          modify += 1;
                          $("#ModifyItem").append(html);
                          if(modify==8){
                           $(".Gset1").css('display','none');
                        }
                     }
                });

                //修改采集项弹窗中删除采集项 
                $("#ModifyItem .ModifyItemCon-del").live("click",function(e){
				    var modify=$("#ModifyItem").children(".ModifyItemCon").length;
                    modify -= 1;
                    $(this).parent().remove();
                       if(modify<8){
                        $(".Gset1").css('display','block');
                     }
                });
			 
                //下一步渐显示
                $('.fixBtn').hide();
                $(window).scroll(function () {
                    if ($(window).scrollTop() > 450) {
                        $('.fixBtn').fadeIn(400);
                    } else {
                        $('.fixBtn').fadeOut(0);
                    }
                });
            
                //拖拽
                $(".collect_sz" ).sortable({
                    items: "ul.rank_area",
                    distance: 10,
                    opacity: 0.7,
                    axis:"y",
                    start:function(event, ui){
                        ui.item.startindex = ui.item.index();
                    },
                    deactivate: function(event, ui){
                        var newlist = dataList.list.list[ui.item.startindex];
                        dataList.list.list.splice(ui.item.startindex,1);
                        dataList.list.list.splice(ui.item.index(),0,newlist);
                        beginList(dataList);
                    },
                    update:function(){getval();}
                });
            })
        </script>
    </body>
</html>
